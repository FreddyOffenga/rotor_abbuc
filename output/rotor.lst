mads 1.9.9
Source: C:\Users\Freddy\Documents\Projects\wudsn\Freddy\2023\2023 ROTOR\rotor_abbuc\rotor.asm
     1 				; R O T O R (II)
     2
     3 				; F#READY, 2023-10-08
     4 				; Version 2.4.9
     5 				; For cartridge release
     6
     7 				; - added more gradual levels (level 1 - 7)
     8 				; - added single player support (against robot)
     9 				; - added demo mode
    10 				; - added support for Atari mouse
    11 				; - added autostart demo after about 2 minutes
    12
    13 				; Main idea:
    14 				; - two players ONE and TWO move in a circle
    15 				; - the ball gets color of player to indicate who should catch it
    16 				; - when the ball hits the circle, the other player gets a point
    17
    18 				            icl 'lib/labels.inc'
Source: C:\Users\Freddy\Documents\Projects\wudsn\Freddy\2023\2023 ROTOR\rotor_abbuc\lib\labels.inc
     1 				; labels for OS and hardware
     2
     3 = 0055			x_position  = $55
     4 = 0054			y_position  = $54
     5
     6 = 0058			SAVMSC      = $58       ; screen memory pointer
     7
     8 = F1D8			plot_pixel  = $f1d8
     9
    10 = 0200			VDSLST      = $200
    11
    12 = 02FB			ATACHR      = $2fb      ; drawing color
    13 = 02FB			draw_color  = ATACHR    ; alias
    14
    15 = 026F			GPRIOR      = $026f
    16
    17 = 0270			PADDL0      = $0270
    18 = 0271			PADDL1      = $0271
    19
    20 = 0278			STICK0      = $0278
    21 = 0279			STICK1      = $0279
    22
    23 = 0284			STRIG0      = $0284
    24 = 0285			STRIG1      = $0285
    25
    26 = 022F			SDMCTL      = $022f
    27 = 0230			SDLSTL      = $0230
    28 = 0231			SDLSTH      = $0231
    29
    30 = 02C0			PCOLR0      = $02c0
    31 = 02C1			PCOLR1      = $02c1
    32 = 02C2			PCOLR2      = $02c2
    33 = 02C3			PCOLR3      = $02c3
    34
    35 = 02C4			COLOR0      = $02c4
    36 = 02C5			COLOR1      = $02c5
    37 = 02C6			COLOR2      = $02c6
    38 = 02C7			COLOR3      = $02c7
    39
    40 = D000			HPOSP0      = $d000
    41 = D001			HPOSP1      = $d001
    42 = D002			HPOSP2      = $d002
    43 = D003			HPOSP3      = $d003
    44 = D004			HPOSM0      = $d004
    45 = D005			HPOSM1      = $d005
    46 = D006			HPOSM2      = $d006
    47 = D007			HPOSM3      = $d007
    48
    49 = D008			SIZEP0      = $d008
    50 = D009			SIZEP1      = $d009
    51 = D00A			SIZEP2      = $d00a
    52 = D00B			SIZEP3      = $d00b
    53 = D00C			SIZEM       = $d00c
    54
    55 				; collision
    56 = D000			M0PF        = $d000
    57 = D001			M1PF        = $d001
    58 = D002			M2PF        = $d002
    59 = D003			M3PF        = $d003
    60
    61 = D004			P0PF        = $d004
    62 = D005			P1PF        = $d005
    63 = D006			P2PF        = $d006
    64 = D007			P3PF        = $d007
    65
    66 = D008			M0PL        = $d008
    67 = D009			M1PL        = $d009
    68 = D00A			M2PL        = $d00a
    69 = D00B			M3PL        = $d00b
    70
    71 = D00C			P0PL        = $d00c
    72 = D00D			P1PL        = $d00d
    73 = D00E			P2PL        = $d00e
    74 = D00F			P3PL        = $d00f
    75
    76 = D012			COLPM0      = $d012
    77 = D013			COLPM1      = $d013
    78 = D014			COLPM2      = $d014
    79 = D015			COLPM3      = $d015
    80
    81 = D016			COLPF0      = $d016
    82 = D017			COLPF1      = $d017
    83 = D018			COLPF2      = $d018
    84 = D019			COLPF3      = $d019
    85 = D01A			COLBK       = $d01a
    86
    87 = D01D			GRACTL      = $d01d
    88 = D01E			HITCLR      = $d01e
    89 = D01F			CONSOL      = $d01f
    90
    91 = D200			AUDF1       = $d200
    92 = D201			AUDC1       = $d201
    93 = D202			AUDF2       = $d202
    94 = D203			AUDC2       = $d203
    95 = D204			AUDF3       = $d204
    96 = D205			AUDC3       = $d205
    97 = D206			AUDF4       = $d206
    98 = D207			AUDC4       = $d207
    99 = D208			AUDCTL      = $d208
   100
   101 = D20A			RANDOM      = $d20a
   102
   103 = D300			PORTA       = $d300
   104
   105 = D407			PMBASE      = $d407
   106 = D40A			WSYNC       = $d40a
   107 = D40E			NMIEN       = $d40e
    19
    20 				; color scheme
    21 = 0050			BASE_COLOR_P1   = $50   ; purple
    22 = 00B0			BASE_COLOR_P2   = $b0   ; green
    23
    24 = 000E			HEADER_FG_COLOR = 14
    25 = 0050			HEADER_P1_COLOR = BASE_COLOR_P1
    26 = 00B0			HEADER_P2_COLOR = BASE_COLOR_P2
    27
    28 				; must be in decimal format, so $11 is 11
    29 = 0011			MAX_SCORE   = $11
    30
    31 = 0C00			pm_area     = $0c00
    32 = 0D80			msl_area    = pm_area+$180
    33 = 0E00			p0_area     = pm_area+$200
    34 = 0E80			p1_area     = pm_area+$280
    35 = 0F00			p2_area     = pm_area+$300
    36 = 0F80			p3_area     = pm_area+$380
    37
    38 				; outer tables 256 for 360 degrees
    39 = 1000			outer_x_256     = $1000
    40 = 1100			outer_y_256     = $1100
    41
    42 = 1200			screen_y_lo     = $1200
    43 = 1300			screen_y_hi     = $1300
    44
    45 = 1400			pm_shape_lo     = $1400 ; 128 bytes
    46 = 1480			pm_shape_hi     = $1480 ; 128 bytes
    47
    48 = 0140			WIDTH           = 320
    49 = 00C0			HEIGHT          = 192
    50
    51 = 0028			SCREEN_WIDTH    = 40
    52
    53 = 0030			outer_x_margin  = 48 ;47-32
    54 = 0040			inner_x_margin  = 64
    55
    56 = 00A0			circle_center_x = WIDTH/2
    57 = 0060			circle_center_y = HEIGHT/2
    58
    59 = 0006			ball_top_margin     = 6
    60 = 0045			ball_left_margin    = 64+5
    61
    62 				; pm upper margin
    63 = 0001			upper_margin    = 1
    64 = 0020			left_margin     = 32
    65
    66 = 0080			music_toggle    = $80
    67
    68 = 0081			shadow_HPOSP0   = $81
    69 = 0082			shadow_HPOSP1   = $82
    70
    71 = 0083			winner_color    = $83
    72
    73 = 0084			shape_ptr       = $84
    74 = 0086			tmp_screen      = $86
    75
    76 = 0088			stick_slow_speed = $88
    77 = 0089			stick_fast_speed = $89
    78
    79 = 008A			player_mode     = $8a
    80 = 0000			MODE_2_PLAYER   = 0
    81 = 0001			MODE_1_PLAYER   = 1
    82 = 0002			MODE_DEMO       = 2
    83 = 0003			NR_OF_PLAYER_MODES = 3
    84 = 0000			INIT_PLAYER_MODE = MODE_2_PLAYER
    85
    86 = 008B			player_mode_saved = $8b
    87
    88 = 008C			game_state      = $8c
    89 = 0000			STATE_IN_GAME   = 0
    90 = 0001			STATE_IN_MENU   = 1
    91 = 0002			STATE_IN_END    = 2
    92
    93 = 008D			volume_hit_bat  = $8d
    94 = 008E			volume_hit_edge = $8e
    95
    96 = 008F			end_screen_delay = $8f
    97
    98 				; player vars must be in sequence for zp,x indexing
    99
   100 = 0090			p1_shape        = $90
   101 = 0091			p2_shape        = $91
   102
   103 = 0094			player1_x       = $94
   104 = 0095			player2_x       = $95
   105
   106 = 0098			player1_y       = $98
   107 = 0099			player2_y       = $99
   108
   109 = 009C			p1_angle        = $9c
   110 = 009D			p2_angle        = $9d
   111
   112 = 00A0			mp_collision    = $a0
   113 = 00A1			in_collision    = $a1
   114 = 00A2			player_nr_hit   = $a2       ; which player hit the ball? 1=player1, 2=player2
   115 = 00A3			edge_delay      = $a3
   116 = 00A4			bat_collision_delay = $a4
   117
   118 				; ball vars
   119 = 00A6			ball_current_x      = $a6
   120 = 00A7			ball_current_y      = $a7
   121 = 00AA			ball_angle_start    = $aa
   122 = 00AB			ball_angle_end      = $ab
   123 = 00AC			ball_speed          = $ac
   124
   125 = 00AD			edge_collision      = $ad
   126 = 00AE			edge_hit_count      = $ae
   127
   128 = 00B0			tmp_angle1          = $b0
   129 = 00B1			tmp_angle2          = $b1
   130 = 00B2			add_to_angle        = $b2
   131 = 00B3			angle_diff_bat      = $b3
   132 = 00B4			tmp_angle_direction = $b4
   133 = 00B5			player_turn         = $b5       ; who's turn to hit ball? 1=player1, 2=player2
   134 = 00B6			game_restart        = $b6
   135 = 00B7			tmp_angle_diff      = $b7
   136 = 00B8			magnitude           = $b8       ; word
   137
   138 = 00BA			robot_angle_end     = $ba       ; 2 bytes
   139 = 00BA			robot1_angle_end    = robot_angle_end
   140 = 00BB			robot2_angle_end    = robot_angle_end+1
   141
   142 				; $c0 - $df free for music
   143
   144 = 00E0			_divisor    = $e0   ; word
   145 = 00E2			_dividend   = $e2   ; word
   146 = 00E4			_remainder  = $e4   ; word
   147 = 00E2			_result     = _dividend         ; save memory by reusing divident to store the result
   148
   149 = 00E6			tmp_x1      = $e6   ; byte
   150 = 00E7			tmp_y1      = $e7   ; byte
   151 = 00E8			tmp_x2      = $e8   ; byte
   152 = 00E9			tmp_y2      = $e9   ; byte
   153
   154 = 00EA			current_x   = $ea  ; word  8.8 fixed point
   155 = 00EC			current_y   = $ec  ; word  8.8 fixed point
   156
   157 = 00EE			step_x      = $ee  ; word  8.8 fixed point
   158 = 00F0			step_y      = $f0  ; word  8.8 fixed point
   159
   160 = 00F2			tmp_dx      = $f2  ; byte
   161 = 00F3			tmp_dy      = $f3  ; byte
   162
   163 = 00F6			_multiplicand   = $f6   ; word
   164 = 00F8			_multiplier     = $f8   ; byte
   165
   166 				; direction:
   167 				; 0 : x1<x2 or y1<y2 = add
   168 				; 1 ; x1>=y2 or y1>=y2 = subtract
   169
   170 = 00FA			dir_x       = $fa  ; byte
   171 = 00FB			dir_y       = $fb  ; byte
   172
   173 = 00FC			line_end_x  = $fc  ; byte
   174 = 00FD			line_end_y  = $fd  ; byte
   175
   176 				            icl 'intro.asm'
Source: C:\Users\Freddy\Documents\Projects\wudsn\Freddy\2023\2023 ROTOR\rotor_abbuc\intro.asm
     1 				; rotor intro 
     2
     3 				            org $0600
     4
     5 				first_screen_off
     6 FFFF> 0600-0618> A9 00	            lda #0
     7 0602 8D 2F 02		            sta 559
     8 0605 A5 14		            lda 20
     9 0607			wait_black
    10 0607 C5 14		            cmp 20
    11 0609 F0 FC		            beq wait_black
    12
    13 				; BASIC off
    14 060B AD 01 D3		            lda $d301
    15 060E 09 02		            ora #2
    16 0610 8D 01 D3		            sta $d301
    17
    18 0613 A9 01		            lda #1
    19 0615 8D 44 02		            sta 580
    20 0618 60			            rts
    21
    22 02E2-02E3> 00 06		            ini first_screen_off
    23
    24 0619			            org $9800
    25 9800			rotor_font
    26 9800-9D15> 00 00 00 00 +             ins 'font\rotor.fnt'
    27
    28 9C00			intro_main
    29 9C00 A9 48		            lda #<dl_intro
    30 9C02 8D 30 02		            sta $230
    31 9C05 A9 9C		            lda #>dl_intro
    32 9C07 8D 31 02		            sta $231
    33
    34 9C0A A9 98		            lda #>rotor_font
    35 9C0C 8D F4 02		            sta 756
    36
    37 9C0F A9 00		            lda #0
    38 9C11 8D C6 02		            sta 710
    39
    40 9C14 A9 22		            lda #34
    41 9C16 8D 2F 02		            sta 559
    42
    43 				; reset clock
    44 9C19 A9 00		            lda #0
    45 9C1B 85 14		            sta 20
    46 9C1D 85 13		            sta 19
    47 				            
    48 9C1F 60			            rts
    49
    50 9C20			footer_intro
    51 9C20 2B 6F 64 1A 26 03 +             dta d'Kod:F#READY  Music:IvoP  Gfx:IvoP,Fred_M'
    52
    53 9C48			dl_intro
    54 9C48 70 70 70		            dta $70,$70,$70
    55
    56 9C4B 4F			            dta $4f
    57 9C4C 10 A0		            dta a(intro_image)
    58 9C4E 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f
    59 9C55 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    60 9C5D 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    61 9C65 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    62
    63 9C6D 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    64 9C75 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    65 9C7D 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    66 9C85 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    67
    68 9C8D 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    69 9C95 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    70 9C9D 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    71 9CA5 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    72
    73 9CAD 0F 0F 0F 0F 0F 0F	            dta $0f,$0f,$0f,$0f,$0f,$0f
    74
    75 9CB3 4F			            dta $4f
    76 9CB4 00 B0		            dta a(intro_image+$ff0)
    77 9CB6 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f
    78 9CBD 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    79 9CC5 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    80 9CCD 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    81
    82 9CD5 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    83 9CDD 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    84 9CE5 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    85 9CED 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    86
    87 9CF5 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    88 9CFD 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f            
    89 9D05 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    90 9D0D 0F 0F		            dta $0f,$0f
    91 				            
    92 9D0F 20			            dta $20
    93 9D10 42			            dta $42
    94 9D11 20 9C		            dta a(footer_intro)
    95
    96 9D13 41			            dta $41
    97 9D14 48 9C		            dta a(dl_intro)
    98 				            
    99 9D16			            org $a010
   100 A010			intro_image
   101 				            ;ins 'gfx\intro\intro_v6_gr8_inverted.gr8'
   102 A010-BE0F> 10 82 84 42 +             ins 'gfx\intro\intro_rotor2_v2.gr8'
   103
   104 02E2-02E3> 00 9C		            ini intro_main
   177
   178 				; real data is loaded at $2000 ($1700+$900)
   179 BE10			            org $1700
   180 1700			            icl 'music\rotor_music\rotor_music.asm'
Source: C:\Users\Freddy\Documents\Projects\wudsn\Freddy\2023\2023 ROTOR\rotor_abbuc\music\rotor_music\rotor_music.asm
     1 				;
     2 				; LZSS Compressed SAP player for 16 match bits
     3 				; --------------------------------------------
     4 				;
     5 				; (c) 2020 DMSC
     6 				; Code under MIT license, see LICENSE file.
     7 				;
     8 				; This player uses:
     9 				;  Match length: 8 bits  (1 to 256)
    10 				;  Match offset: 8 bits  (1 to 256)
    11 				;  Min length: 2
    12 				;  Total match bits: 16 bits
    13 				;
    14 				; Compress using:
    15 				;  lzss -b 16 -o 8 -m 1 input.rsap test.lz16
    16 				;
    17 				; Assemble this file with MADS assembler, the compressed song is expected in
    18 				; the `test.lz16` file at assembly time.
    19 				;
    20 				; The plater needs 256 bytes of buffer for each pokey register stored, for a
    21 				; full SAP file this is 2304 bytes.
    22 				;
    23
    24 = 0232			SSKCTL = $0232
    25 				;RANDOM = $d20a
    26 = D20F			SKCTL  = $d20f
    27
    28 = 00C0			zp_music    = $c0
    29 = 00C0			chn_copy    = zp_music    ; .ds     9
    30 = 00C9			chn_pos     = zp_music+9  ; .ds     9
    31 = 00D2			bptr        = zp_music+18 ; .ds     2
    32 = 00D4			cur_pos     = zp_music+20 ; .ds     1
    33 = 00D5			chn_bits    = zp_music+21 ; .ds     1
    34 = 00D6			bit_data    = zp_music+22 ; .byte   1
    35
    36 = 00D7			newsong     = zp_music+23 ; .ds     1       ; IVO
    37
    38 = 00D8			stereo_pokey    = zp_music+24 ;.ds     1
    39
    40 = D200			POKEY = $D200
    41
    42 				    ;org $9800
    43 1700			buffers
    44 = 1700			    .ds 256 * 9
    45
    46 2000			intro_data
    47 2000-3277> 01 01 A1 34 +         ins     'intro.lz16'
    48 22D8			intro_end
    49
    50 22D8			loop_data
    51 22D8 01 01 A1 34 00 10 +         ins     'loop.lz16'
    52 30D7			loop_end
    53
    54 30D7			.proc get_byte
    55 30D7 AD 34 12		    lda $1234
    56 30DA EE D8 30		    inc song_ptr
    57 30DD D0 03		    bne skip
    58 30DF EE D9 30		    inc song_ptr+1
    59 30E2			skip
    60 30E2 60			    rts
    61 				.endp
    62 = 30D8			song_ptr = get_byte + 1
    63
    64 30E3			start
    65
    66 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    67 				; Song Initialization - this runs in the first tick:
    68 				;
    69 30E3			.proc play_first_frame
    70
    71 30E3 20 D7 30		    jsr get_byte                    ; IVO START move init here
    72 30E6 8D 22 31		    sta play_frame.init_chn_bits
    73 30E9 A9 01		    lda #1                          ; IVO set to 1 at init(!)
    74 30EB 85 D6		    sta bit_data
    75 30ED A9 17		    lda #>buffers                   ; IVO reset cbuf+1 pointer
    76 30EF 8D 02 31		    sta cbuf+2                      ; IVO END
    77
    78 				    ; Init all channels:
    79 30F2 A2 08		    ldx #8
    80 30F4 A0 00		    ldy #0
    81 30F6 84 D7		    sty newsong                     ; IVO signal first frame is played
    82 30F8			clear
    83 				    ; Read just init value and store into buffer and POKEY
    84 30F8 20 D7 30		    jsr get_byte
    85 30FB 9D 6F 32		    sta SHADOW, x
    86 30FE 94 C0		    sty chn_copy, x
    87 3100			cbuf
    88 3100 8D FF 17		    sta buffers + 255
    89 3103 EE 02 31		    inc cbuf + 2
    90 3106 CA			    dex
    91 3107 10 EF		    bpl clear
    92
    93 				    ; Initialize buffer pointer:
    94 3109 84 D2		    sty bptr
    95 310B 84 D4		    sty cur_pos
    96 310D 60			    rts                     ; IVO turn into subroutine
    97 				.endp
    98
    99 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   100 				; Wait for next frame
   101 				;
   102 310E			.proc wait_frame
   103
   104 310E A5 14		    lda 20
   105 3110			delay
   106 3110 C5 14		    cmp 20
   107 3112 F0 FC		    beq delay
   108 3114 60			    rts                     ; IVO turn into subroutine
   109 				.endp
   110
   111 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   112 				; Play one frame of the song
   113 				;
   114 3115			.proc play_frame
   115 3115 A5 D7		    lda newsong
   116 3117 F0 02		    beq continue
   117 3119 D0 C8		    bne play_first_frame
   118
   119 311B			continue
   120 311B A4 D4		    ldy cur_pos                 ; IVO
   121
   122 311D A9 17		    lda #>buffers
   123 311F 85 D3		    sta bptr+1
   124
   125 = 3122			init_chn_bits=*+1
   126 3121 A9 00		    lda #0              ; IVO: 8 bits, but 9 streams. bug?
   127 3123 85 D5		    sta chn_bits
   128 3125 A2 08		    ldx #8
   129
   130 				    ; Loop through all "channels", one for each POKEY register
   131 3127			chn_loop:
   132 3127 46 D5		    lsr chn_bits
   133 3129 B0 29		    bcs skip_chn       ; C=1 : skip this channel
   134
   135 312B B5 C0		    lda chn_copy, x    ; Get status of this stream
   136 312D D0 16		    bne do_copy_byte   ; If > 0 we are copying bytes
   137
   138 				    ; We are decoding a new match/literal
   139 312F 46 D6		    lsr bit_data       ; Get next bit
   140 3131 D0 06		    bne got_bit
   141 3133 20 D7 30		    jsr get_byte       ; Not enough bits, refill!
   142 3136 6A			    ror                ; Extract a new bit and add a 1 at the high bit (from C set above)
   143 3137 85 D6		    sta bit_data       ;
   144 3139			got_bit:
   145 3139 20 D7 30		    jsr get_byte       ; Always read a byte, it could mean "match size/offset" or "literal byte"
   146 313C B0 0F		    bcs store          ; Bit = 1 is "literal", bit = 0 is "match"
   147
   148 313E 95 C9		    sta chn_pos, x     ; Store in "copy pos"
   149
   150 3140 20 D7 30		    jsr get_byte
   151 3143 95 C0		    sta chn_copy, x    ; Store in "copy length"
   152
   153 				                        ; And start copying first byte
   154 3145			do_copy_byte:
   155 3145 D6 C0		    dec chn_copy, x     ; Decrease match length, increase match position
   156 3147 F6 C9		    inc chn_pos, x
   157 3149 B4 C9		    ldy chn_pos, x
   158
   159 				    ; Now, read old data, jump to data store
   160 314B B1 D2		    lda (bptr), y
   161
   162 314D			store:
   163 314D A4 D4		    ldy cur_pos
   164 314F 9D 6F 32		    sta SHADOW, x        ; Store to output and buffer
   165 3152 91 D2		    sta (bptr), y
   166
   167 3154			skip_chn:
   168 				    ; Increment channel buffer pointer
   169 3154 E6 D3		    inc bptr+1
   170
   171 3156 CA			    dex
   172 3157 10 CE		    bpl chn_loop        ; Next channel
   173
   174 3159 E6 D4		    inc cur_pos
   175 315B 60			    rts                 ; IVO once per frame
   176 				.endp
   177
   178 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   179 				; Check for ending of song and jump to the next frame
   180 				;
   181 315C			.proc check_end_song
   182 315C AD D9 30		    lda song_ptr + 1
   183 = 3160			song_end_high=*+1
   184 315F C9 00		    cmp #>0
   185 3161 D0 09		    bne not_equal           ; IVO turn into subroutine
   186 3163 AD D8 30		    lda song_ptr
   187 = 3167			song_end_low=*+1
   188 3166 C9 00		    cmp #<0
   189 3168 D0 02		    bne not_equal           ; IVO turn intro subroutine
   190
   191 316A 38			    sec                     ; IVO....
   192 316B 60			    rts
   193 316C			not_equal
   194 316C 18			    clc
   195 316D 60			    rts
   196 				.endp
   197
   198 				; IVO everything below
   199
   200 316E			.proc music_init
   201 316E 20 10 32		    jsr detect_2nd_pokey
   202 3171 20 49 32		    jsr clear_echo
   203
   204 3174 A9 8A 8D CF 31 A9 +     mwa #normal_volume adjust_volume.volume
   205 				;    mwa #half_volume adjust_volume.volume
   206 				;    mwa #quarter_volume adjust_volume.volume
   207
   208 317E A9 D8		    lda #<intro_end
   209 3180 8D 67 31		    sta check_end_song.song_end_low
   210 3183 A9 22		    lda #>intro_end
   211 3185 8D 60 31		    sta check_end_song.song_end_high
   212 3188 A9 00		    lda #<(intro_data)
   213 318A 8D D8 30		    sta song_ptr
   214 318D A9 20		    lda #>(intro_data)
   215 318F 8D D9 30		    sta song_ptr+1
   216 3192 A9 01		    lda #1
   217 3194 85 D7		    sta newsong
   218 3196 60			    rts
   219 				.endp
   220
   221 3197			.proc play_song
   222 3197			playloop
   223 3197 20 15 31		    jsr play_frame      ; generates tick two and beyond
   224 319A 20 BF 31		    jsr adjust_volume
   225
   226 319D 20 5C 31		    jsr check_end_song
   227 31A0 90 03		    bcc no_end_song
   228 31A2 20 A6 31		    jsr restart_music
   229 31A5			no_end_song
   230 31A5 60			    rts
   231 				.endp
   232
   233 31A6			.proc restart_music
   234 31A6 A9 D7		    lda #<loop_end
   235 31A8 8D 67 31		    sta check_end_song.song_end_low
   236 31AB A9 30		    lda #>loop_end
   237 31AD 8D 60 31		    sta check_end_song.song_end_high
   238 31B0 A9 D8		    lda #<(loop_data)
   239 31B2 8D D8 30		    sta song_ptr
   240 31B5 A9 22		    lda #>(loop_data)
   241 31B7 8D D9 30		    sta song_ptr+1
   242 31BA A9 01		    lda #1
   243 31BC 85 D7		    sta newsong
   244 31BE 60			    rts
   245 				.endp
   246
   247 31BF			.proc adjust_volume
   248 31BF A0 06		    ldy #6
   249 31C1			adjust
   250 31C1 B9 70 32		    lda SHADOW+1,y
   251 31C4 AA			    tax
   252 31C5 29 F0		    and #$f0
   253 31C7 99 70 32		    sta SHADOW+1,y
   254 31CA 8A			    txa
   255 31CB 29 0F		    and #$0f
   256 31CD AA			    tax
   257 = 31CF			volume=*+1
   258 31CE BD 34 12		    lda $1234,x
   259 31D1 19 70 32		    ora SHADOW+1,y
   260 31D4 99 70 32		    sta SHADOW+1,y
   261 31D7 88			    dey
   262 31D8 88			    dey
   263 31D9 10 E6		    bpl adjust
   264 				    
   265 31DB 60			    rts
   266 				.endp
   267
   268 31DC			.proc copy_shadow
   269 31DC A2 08		    ldx #8
   270 31DE			copy
   271 31DE BD 6F 32		    lda SHADOW,x
   272 31E1 9D 00 D2		    sta POKEY,x
   273 31E4 CA			    dex
   274 31E5 10 F7		    bpl copy
   275
   276 31E7 A5 D8		    lda stereo_pokey
   277 31E9 F0 0E		    beq end_copy
   278
   279 31EB A2 08		    ldx #8
   280 31ED			copy2
   281 31ED BD 81 32		    lda ECHO,x
   282 31F0 9D 10 D2		    sta POKEY+$10,x
   283 31F3 CA			    dex
   284 31F4 10 F7		    bpl copy2
   285
   286 31F6 20 54 32		    jsr shift_echo
   287
   288 31F9			end_copy
   289 31F9 60			    rts
   290 				.endp
   291
   292 31FA			.proc music_normal_volume
   293 31FA A9 8A 8D CF 31 A9 +     mwa #normal_volume adjust_volume.volume
   294 3204 60			    rts
   295 				.endp
   296
   297 3205			.proc music_low_volume
   298 3205 A9 AA 8D CF 31 A9 +     mwa #quarter_volume adjust_volume.volume
   299 320F 60			    rts
   300 				.endp
   301
   302 3210			.proc detect_2nd_pokey
   303 3210 20 0E 31		    jsr wait_frame
   304
   305 3213 A9 00 8D 32 02	    mva #0 SSKCTL
   306 3218 A9 00 8D 0F D2	    mva #0 SKCTL
   307 321D A9 00 8D 1F D2	    mva #0 SKCTL+$10        ; make sure a potential 2nd pokey is cleared
   308
   309 3222 20 0E 31		    jsr wait_frame
   310
   311 				    ; Restart SKCTL. This starts all the poly counters
   312
   313 3225 A9 03 8D 32 02	    mva #3 SSKCTL
   314 322A A9 03 8D 0F D2	    mva #3 SKCTL
   315
   316 322F 20 0E 31		    jsr wait_frame
   317
   318 				    ; Except when there's a seconds pokey!! Its counters are not restarted.
   319 				    ; Its RANDOM should not change.
   320
   321 3232 AD 1A D2		    lda RANDOM+$10
   322 3235 CD 1A D2		    cmp RANDOM+$10
   323 3238 F0 05		    beq detected_stereo         ; so equal means there's a 2nd pokey
   324
   325 323A			detected_mono
   326 323A A9 00 85 D8		    mva #0 stereo_pokey
   327 323E 60			    rts
   328
   329 323F			detected_stereo
   330 323F A9 01 85 D8		    mva #1 stereo_pokey
   331 3243 A9 03 8D 1F D2	    mva #3 SKCTL+$10            ; start second pokey here
   332 3248 60			    rts
   333 				.endp
   334
   335 3249			.proc clear_echo
   336 3249 A0 11		    ldy #(endecho-echobuffer)-1
   337 324B			clear_echo_loop
   338 324B A9 00 99 78 32	    mva #0 echobuffer,y
   339 3250 88 10 F8		    dey:bpl clear_echo_loop
   340 3253 60			    rts
   341 				.endp
   342
   343 3254			.proc shift_echo
   344 3254 A0 11		    ldy #(ECHO-echobuffer)-1+9
   345 3256			shift_loop
   346 3256 B9 6F 32 99 78 32	    mva SHADOW,y SHADOW+9,y
   347 325C 88 10 F7		    dey:bpl shift_loop
   348 325F 60			    rts
   349 				.endp
   350
   351 3260			.proc music_off
   352 3260 A9 00		    lda #0
   353 3262 8D 70 32		    sta shadow+1
   354 3265 8D 72 32		    sta shadow+3
   355 3268 8D 74 32		    sta shadow+5
   356 326B 8D 76 32		    sta shadow+7
   357 326E 60			    rts
   358 				.endp
   359
   360 326F			SHADOW              ; shadow pokey
   361 326F 00 00 00 00 00 00 + :9 .byte 0
   362
   363 				                    ; fake stereo effect:
   364 				                    ; 0*9 = small
   365 				                    ; 1*9 = medium
   366 				                    ; 2*9 = big
   367 				                    ; >3 too big imho
   368
   369 3278			echobuffer
   370 = 3278			    .ds 1*9        ; total of echobuffer+ECHO MUST NOT exceed 128 bytes
   371
   372 3281			ECHO
   373 = 3281			    .ds 9
   374 328A			endecho
   375
   376 328A			normal_volume
   377 328A-32BB> 00 01 02 03 +     dta 0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15
   378 329A			half_volume
   379 329A 00 01 01 02 02 03 +     dta 0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,7
   380 32AA			quarter_volume
   381 32AA 00 01 01 01 01 02 +     dta 0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,4
   181
   182 32BC			            icl 'lib/drivers.inc'       
Source: C:\Users\Freddy\Documents\Projects\wudsn\Freddy\2023\2023 ROTOR\rotor_abbuc\lib\drivers.inc
     1
     2 				; F#READY
     3
     4 = 32BC			driver_tmp      .ds 2
     5 = 32BE			driver_mode     .ds 1
     6
     7 = 00E5			paddle_vals = 229
     8 = 011F			paddle_add  = 287       ; 65536 / 229
     9
    10 32BF			            .align $100
    11 3300			paddle_to_256
    12 = 3300			            .ds $100
    13
    14 				; paddle initial value
    15 3400			prev_paddle_value
    16 = 3400			            .ds 1
    17
    18 				; previous mouse value (player 1,2)
    19 3401			prev_mouse_value
    20 = 3401			            .ds 2
    21
    22 3403			driver_init
    23 3403-3FD8> A9 00		            lda #0  ; stick
    24 3405 8D BE 32		            sta driver_mode
    25
    26 3408 8D 01 34		            sta prev_mouse_value
    27 340B 8D 02 34		            sta prev_mouse_value+1
    28
    29 340E AD 70 02		            lda PADDL0
    30 3411 8D 00 34		            sta prev_paddle_value
    31
    32 3414 A9 00		            lda #0
    33 3416 85 9C		            sta p1_angle
    34 3418 A9 80		            lda #128
    35 341A 85 9D		            sta p2_angle
    36
    37 				; init paddle table
    38
    39 341C A9 00		            lda #0
    40 341E 8D BC 32		            sta driver_tmp
    41 3421 8D BD 32		            sta driver_tmp+1
    42 				            
    43 3424 A2 00		            ldx #0
    44 3426			store_pv
    45 3426 AD BD 32		            lda driver_tmp+1
    46 3429 9D 00 33		            sta paddle_to_256,x
    47 				            
    48 342C AD BC 32		            lda driver_tmp
    49 342F 18			            clc
    50 3430 69 1F		            adc #<paddle_add
    51 3432 8D BC 32		            sta driver_tmp
    52 3435 AD BD 32		            lda driver_tmp+1
    53 3438 69 01		            adc #>paddle_add
    54 343A 8D BD 32		            sta driver_tmp+1
    55 343D E8			            inx
    56 343E E0 E5		            cpx #paddle_vals
    57 3440 D0 E4		            bne store_pv
    58 3442 60			            rts
    59
    60 3443			reset_driver_mode
    61 3443 A9 00		            lda #0
    62 3445 8D BE 32		            sta driver_mode     ; reset driver mode
    63 3448 60			            rts
    64
    65 				; stick detect by using left/right
    66 				; paddle by connecting/rotate
    67 				; mouse controller by movement
    68
    69 				; return A = driver mode
    70 				; 0 = stick detected
    71 				; 1 = paddle detected
    72 				; 2 = mouse detected
    73
    74 3449			driver_detect
    75 3449 AD 70 02		            lda PADDL0
    76 344C C9 E4		            cmp #228
    77 344E D0 07		            bne paddle_detect
    78 3450 AD 71 02		            lda PADDL1
    79 3453 C9 E4		            cmp #228
    80 3455 F0 06		            beq no_paddle_detect
    81 3457			paddle_detect
    82 3457 A9 01		            lda #1
    83 3459 8D BE 32		            sta driver_mode
    84 345C 60			            rts
    85
    86 345D			no_paddle_detect
    87 345D AD BE 32		            lda driver_mode
    88 3460 C9 02		            cmp #2
    89 3462 F0 0C		            beq keep_mouse
    90 3464 AD 78 02		            lda STICK0
    91 3467 C9 0C		            cmp #12
    92 3469 D0 06		            bne no_mouse_detect
    93 346B A9 02		            lda #2
    94 346D 8D BE 32		            sta driver_mode
    95 3470			keep_mouse
    96 3470 60			            rts
    97
    98 3471			no_mouse_detect
    99 3471 C9 07		            cmp #7      ; paddle button also gives this
   100 3473 F0 04		            beq stick_detect    
   101 3475 C9 0B		            cmp #11     ; paddle button also gives this
   102 3477 D0 06		            bne no_stick_detect
   103 3479			stick_detect
   104 3479 A9 00		            lda #0
   105 347B 8D BE 32		            sta driver_mode
   106 347E 60			            rts
   107
   108 347F			no_stick_detect
   109 				; default is the last value
   110 347F AD BE 32		            lda driver_mode
   111 3482 60			            rts
   112
   113 				; move player 1/2
   114 				; right - clockwise, left = anti-clockwise
   115
   116 				; X = 0, player 1
   117 				; X = 1, player 2
   118
   119 				; A = driver mode:
   120 				; 0 : stick
   121 				; 1 : paddle
   122 				; 2 : mouse
   123 				; 3 : computer
   124
   125 3483			main_driver
   126 3483 AC BE 32		            ldy driver_mode
   127 3486 B9 95 34		            lda driver_lo,y
   128 3489 8D 93 34		            sta driver_ptr
   129 348C B9 99 34		            lda driver_hi,y
   130 348F 8D 94 34		            sta driver_ptr+1
   131
   132 = 3493			driver_ptr = *+1
   133 3492 4C FF FF		            jmp $ffff  
   134
   135 3495			driver_lo
   136 3495 9D			            dta <driver_stick
   137 3496 0B			            dta <driver_paddle
   138 3497 18			            dta <driver_mouse
   139 3498 9D			            dta <driver_stick
   140
   141 3499			driver_hi
   142 3499 34			            dta >driver_stick
   143 349A 35			            dta >driver_paddle
   144 349B 35			            dta >driver_mouse
   145 349C 34			            dta >driver_stick
   146
   147 				; joystick driver
   148
   149 349D			driver_stick
   150 349D BD 78 02		            lda STICK0,x
   151 34A0 C9 0F		            cmp #15
   152 34A2 F0 31		            beq move_done
   153 34A4 C9 0B		            cmp #11
   154 34A6 D0 16		            bne no_left
   155
   156 34A8 B5 9C		            lda p1_angle,x
   157 34AA 38			            sec
   158 34AB E5 88		            sbc stick_slow_speed
   159 34AD 95 9C		            sta p1_angle,x
   160
   161 34AF BD 84 02		            lda STRIG0,x
   162 34B2 D0 07		            bne no_fast
   163
   164 34B4 B5 9C		            lda p1_angle,x
   165 34B6 38			            sec
   166 34B7 E5 89		            sbc stick_fast_speed
   167 34B9 95 9C		            sta p1_angle,x
   168 34BB			no_fast
   169 				            
   170 34BB 4C D5 34		            jmp move_done
   171 34BE C9 07		no_left     cmp #7
   172 34C0 D0 13		            bne move_done
   173
   174 34C2 B5 9C		            lda p1_angle,x
   175 34C4 18			            clc
   176 34C5 65 88		            adc stick_slow_speed
   177 34C7 95 9C		            sta p1_angle,x
   178
   179 34C9 BD 84 02		            lda STRIG0,x
   180 34CC D0 07		            bne no_fast_right
   181
   182 34CE B5 9C		            lda p1_angle,x
   183 34D0 18			            clc
   184 34D1 65 89		            adc stick_fast_speed
   185 34D3 95 9C		            sta p1_angle,x
   186 34D5			no_fast_right
   187 34D5			move_done
   188 34D5 60			            rts
   189
   190 				; check if player1 button is pressed
   191 				; A=0 not pressed, 1=pressed
   192
   193 34D6			is_player1_button_pressed
   194 34D6 AD BE 32		            lda driver_mode
   195 34D9 C9 01		            cmp #1
   196 34DB F0 07		            beq check_player1_paddle_fire
   197
   198 34DD AD 84 02		            lda STRIG0
   199 34E0 F0 1C		            beq fire_pressed
   200 34E2 D0 24		            bne fire_not_pressed
   201
   202 34E4			check_player1_paddle_fire
   203 34E4 AD 78 02		            lda STICK0
   204 34E7 C9 0B		            cmp #11
   205 34E9 F0 13		            beq fire_pressed
   206 34EB D0 1B		            bne fire_not_pressed
   207
   208 				; X=port number to check (paddle uses only port 1)
   209 				; check fire button (paddle uses left/right stick as fire button)
   210 				; A=0 not pressed, 1=pressed
   211
   212 34ED			is_both_buttons
   213 34ED AD BE 32		            lda driver_mode
   214 34F0 C9 01		            cmp #1
   215 34F2 F0 0D		            beq check_paddle_fire
   216
   217 34F4 AD 84 02		            lda STRIG0
   218 34F7 D0 0F		            bne fire_not_pressed
   219 34F9 AD 85 02		            lda STRIG1
   220 34FC D0 0A		            bne fire_not_pressed
   221
   222 34FE			fire_pressed
   223 34FE A9 01		            lda #1
   224 3500 60			            rts
   225
   226 3501			check_paddle_fire
   227 3501 AD 78 02		            lda STICK0
   228 3504 C9 03		            cmp #3
   229 3506 F0 F6		            beq fire_pressed
   230
   231 3508			fire_not_pressed
   232 3508 A9 00		            lda #0
   233 350A 60			            rts
   234
   235 				; paddle driver
   236 				            
   237 350B			driver_paddle            
   238 350B BD 70 02		            lda PADDL0,x
   239 350E A8			            tay
   240 350F B9 00 33		            lda paddle_to_256,y
   241 3512 5D 4F 35		            eor paddle_offsets,x
   242 3515 95 9C		            sta p1_angle,x
   243 3517 60			            rts
   244
   245 				; mouse driver (Atari ST compatible)
   246
   247 3518			driver_mouse
   248 3518 60			            rts
   249 				;            lda STICK0,x
   250 				;            eor #15
   251 				;            jmp driver_mouse_main
   252
   253 3519			driver_mouse_fast_p1
   254 3519 AD 00 D3		            lda PORTA
   255 351C A2 00		            ldx #0
   256 351E 4C 2A 35		            jmp driver_mouse_main
   257
   258 3521			driver_mouse_fast_p2
   259 3521 AD 00 D3		            lda PORTA
   260 3524 4A			            lsr
   261 3525 4A			            lsr
   262 3526 4A			            lsr
   263 3527 4A			            lsr
   264 3528 A2 01		            ldx #1
   265 				; have to call this many times per frame for each player
   266 352A			driver_mouse_main
   267 352A 29 03		            and #%00000011
   268 352C 48			            pha
   269 352D 1D 01 34		            ora prev_mouse_value,x
   270 3530 A8			            tay
   271 3531 68			            pla
   272 3532 0A			            asl
   273 3533 0A			            asl
   274 3534 9D 01 34		            sta prev_mouse_value,x  ; store previous bits at 0000AA00 position for next time
   275
   276 3537 B9 3F 35		            lda mouse_transitions,y
   277 353A 75 9C		            adc p1_angle,x
   278 353C 95 9C		            sta p1_angle,x
   279 353E 60			            rts
   280
   281 				; nibble coded transitions for mouse
   282 				; 15,13,12,14 = anti-clockwise
   283 				; 15,14,12,13 = clockwise
   284 				; only lowest 2 bits change, so we need 16 values for all transitions
   285
   286 				; index is the combined value of nibble AABB
   287 				; where AA is previous bits and BB current bits
   288 353F			mouse_transitions
   289 353F 00			            dta 0   ; 00 -> 00 (12 -> 12)
   290 3540 02			            dta 2   ; 00 -> 01 (12 -> 13)
   291 3541 FE			            dta 254 ; 00 -> 10 (12 -> 14)
   292 3542 00			            dta 0   ; 00 -> 11 (12 -> 15)
   293 3543 FE			            dta 254 ; 01 -> 00 (13 -> 12)
   294 3544 00			            dta 0   ; 01 -> 01 (13 -> 13)
   295 3545 00			            dta 0   ; 01 -> 10 (13 -> 14)
   296 3546 02			            dta 2   ; 01 -> 11 (13 -> 15)
   297 3547 02			            dta 2   ; 10 -> 00 (14 -> 12)
   298 3548 00			            dta 0   ; 10 -> 01 (14 -> 13)
   299 3549 00			            dta 0   ; 10 -> 10 (14 -> 14)
   300 354A FE			            dta 254 ; 10 -> 11 (14 -> 15)
   301 354B 00			            dta 0   ; 11 -> 00 (15 -> 12)
   302 354C FE			            dta 254 ; 11 -> 01 (15 -> 13)
   303 354D 02			            dta 2   ; 11 -> 10 (15 -> 14)
   304 354E 00			            dta 0   ; 11 -> 11 (15 -> 15)
   305
   306 354F			paddle_offsets
   307 354F 00 00		            dta 0,0
   183
   184 3551			reset_pressed
   185 3551 20 00 9C		            jsr intro_main
   186
   187 3554			main
   188 3554 A9 FF		            lda #255
   189 3556 8D FC 02		            sta 764
   190
   191 				; for fast loaders, wait 10 seconds or continue with spacebar
   192 3559			wait_a_sec
   193 3559 AD FC 02		            lda 764
   194 355C C9 FF		            cmp #255
   195 355E D0 06		            bne any_key_pressed
   196
   197 3560 A5 13		            lda 19
   198 3562 C9 02		            cmp #2
   199 3564 90 F3		            bcc wait_a_sec
   200
   201 3566			any_key_pressed
   202 3566 A9 FF		            lda #255
   203 3568 8D FC 02		            sta 764
   204
   205 				; start the game!
   206 				 
   207 356B A9 00		            lda #0
   208 356D 8D 2F 02		            sta SDMCTL
   209 3570 85 B6		            sta game_restart
   210 3572 85 8F		            sta end_screen_delay
   211 3574 85 83		            sta winner_color
   212
   213 3576 A9 80		            lda #128
   214 3578 85 8D		            sta volume_hit_bat
   215 357A 85 8E		            sta volume_hit_edge
   216 357C 85 80		            sta music_toggle        ; 128 = on, 0 = off
   217
   218 357E A9 01		            lda #1
   219 3580 8D 44 02		            sta 580 ; coldstart
   220
   221 				;            lda #1
   222 				;            sta 9   ; boot
   223
   224 				;            lda #<reset_pressed
   225 				;            sta $0a
   226 				;            lda #>reset_pressed
   227 				;            sta $0b
   228
   229 3583 20 03 34		            jsr driver_init
   230
   231 3586 20 BB 3C		            jsr make_shape_index
   232
   233 3589 20 EB 3C		            jsr make_outer_256
   234
   235 358C 20 D2 36		            jsr make_screen_y_tab
   236
   237 358F 20 1D 37		            jsr invert_backdrop
   238 3592 A9 60		            lda #$60
   239 3594 8D 1D 37		            sta invert_backdrop ; dirty hack to fix warm reset :P
   240
   241 3597 20 5B 3D		            jsr reset_score
   242 359A 20 29 3D		            jsr show_score_p1
   243 359D 20 42 3D		            jsr show_score_p2
   244
   245 35A0 20 30 3F		            jsr init_sprites
   246 35A3 20 5C 3F		            jsr init_colors
   247
   248 				; init. game vars
   249 35A6 A2 00		            ldx #INIT_LEVEL_INDEX
   250 35A8 8E 7C 3F		            stx current_level_index
   251 35AB 20 92 3F		            jsr set_level_ball_speed
   252
   253 35AE A9 00		            lda #INIT_PLAYER_MODE
   254 35B0 85 8A		            sta player_mode
   255 35B2 85 8B		            sta player_mode_saved
   256 35B4 20 CA 3F		            jsr show_player_mode
   257
   258 35B7 A9 01		            lda #STATE_IN_MENU
   259 35B9 85 8C		            sta game_state           ; start with menu
   260
   261 35BB 20 6E 31		            jsr music_init
   262
   263 35BE 20 62 37		            jsr show_menu_options
   264
   265 35C1 20 6D 38		            jsr reset_autostart_demo
   266
   267 35C4 A9 00		            lda #<display_list
   268 35C6 8D 30 02		            sta SDLSTL
   269 35C9 A9 50		            lda #>display_list
   270 35CB 8D 31 02		            sta SDLSTH
   271
   272 				; start vbi
   273
   274 35CE A9 C0		            lda #$c0
   275 35D0 8D 0E D4		            sta NMIEN
   276
   277 35D3 A9 07		            lda #7          ; sets VVBLKI
   278 35D5 A0 B4		            ldy #<vbi
   279 35D7 A2 37		            ldx #>vbi
   280 35D9 20 5C E4		            jsr $e45c       ; SETVBV
   281
   282 35DC			wait_mouse
   283 35DC AD BE 32		            lda driver_mode
   284 35DF C9 02		            cmp #2
   285 35E1 D0 F9		            bne wait_mouse
   286
   287 35E3 A5 8A		            lda player_mode
   288 35E5 C9 01		            cmp #MODE_1_PLAYER
   289 35E7 F0 03		            beq single_driver
   290 35E9 20 21 35		            jsr driver_mouse_fast_p2
   291 35EC			single_driver
   292 35EC 20 19 35		            jsr driver_mouse_fast_p1
   293
   294 35EF 4C DC 35		            jmp wait_mouse
   295
   296 				;------------------------
   297 				; 8bit * 8bit = 16bit multiply
   298 				; By White Flame
   299 				; Multiplies _multiplicand by _multiplier and stores result in .A (low byte, also in .X) and .Y (high byte)
   300 				; uses extra zp var _multiplicand+1
   301
   302 				; .X and .Y get clobbered.  Change the tax/txa and tay/tya to stack or zp storage if this is an issue.
   303 				;  idea to store 16-bit accumulator in .X and .Y instead of zp from bogax
   304
   305 				; In this version, both inputs must be unsigned
   306 				; Remove the noted line to turn this into a 16bit(either) * 8bit(unsigned) = 16bit multiply.
   307
   308 35F2			_multi8
   309 35F2 A9 00		            lda #$00
   310 35F4 A8			            tay
   311 				            ;sty _multiplicand+1          ; remove this line for 16*8=16bit multiply
   312 35F5 F0 0D		            beq _enter_loop
   313 35F7			_do_add
   314 35F7 18			            clc
   315 35F8 65 F6		            adc _multiplicand
   316 35FA AA			            tax
   317
   318 35FB 98			            tya
   319 35FC 65 F7		            adc _multiplicand+1
   320 35FE A8			            tay
   321 35FF 8A			            txa
   322 3600			_mul_loop
   323 3600 06 F6		            asl _multiplicand
   324 3602 26 F7		            rol _multiplicand+1
   325 3604			_enter_loop                     ; accumulating multiply entry point (enter with .A=lo, .Y=hi)
   326 3604 46 F8		            lsr _multiplier
   327 3606 B0 EF		            bcs _do_add
   328 3608 D0 F6		            bne _mul_loop
   329 360A 60			            rts
   330
   331 				; reset PM0/1 to playfield settings
   332 360B			dli_header
   333 360B 48			            pha
   334
   335 360C A9 08		            lda #8
   336 360E 8D 17 D0		            sta COLPF1
   337
   338 3611 A5 81		            lda shadow_HPOSP0
   339 3613 8D 00 D0		            sta HPOSP0
   340 3616 A5 82		            lda shadow_HPOSP1
   341 3618 8D 01 D0		            sta HPOSP1
   342
   343 361B A9 00		            lda #0
   344 361D 8D 08 D0		            sta SIZEP0
   345 3620 8D 09 D0		            sta SIZEP1
   346
   347 3623 A9 5A		            lda #BASE_COLOR_P1+10
   348 3625 8D 12 D0		            sta COLPM0
   349 3628 A9 BA		            lda #BASE_COLOR_P2+10
   350 362A 8D 13 D0		            sta COLPM1
   351
   352 362D A9 39		            lda #<dli_menu
   353 362F 8D 00 02		            sta VDSLST
   354 3632 A9 36		            lda #>dli_menu
   355 3634 8D 01 02		            sta VDSLST+1
   356
   357 3637 68			            pla
   358 3638 40			            rti
   359
   360 3639			dli_menu
   361 3639 48			            pha
   362 363A 8A			            txa
   363 363B 48			            pha
   364
   365 363C A9 0E		            lda #$0e
   366 363E 8D 0A D4		            sta WSYNC
   367 3641 8D 1A D0		            sta COLBK
   368 3644 A9 0A		            lda #$0a
   369 3646 8D 0A D4		            sta WSYNC
   370 3649 8D 1A D0		            sta COLBK
   371 364C A9 00		            lda #0
   372 364E 8D 0A D4		            sta WSYNC
   373 3651 8D 1A D0		            sta COLBK
   374
   375 3654 A2 00		            ldx #0
   376 3656			color_it1
   377 3656 BD 9A 36		            lda menu_colpf2,x
   378 3659 8D 0A D4		            sta WSYNC
   379 365C 8D 18 D0		            sta COLPF2
   380 365F E8			            inx
   381 3660 E0 12		            cpx #18
   382 3662 D0 F2		            bne color_it1
   383
   384 3664 A2 00		            ldx #0
   385 3666			color_it2
   386 3666 BD AC 36		            lda menu_colpf0,x
   387 3669 05 83		            ora winner_color
   388 366B 8D 0A D4		            sta WSYNC
   389 366E 8D 16 D0		            sta COLPF0
   390 3671 E8			            inx
   391 3672 E0 26		            cpx #38
   392 3674 D0 F0		            bne color_it2
   393
   394 3676 A9 00		            lda #0
   395 3678 8D 0A D4		            sta WSYNC
   396 367B 8D 1A D0		            sta COLBK
   397 367E A9 0A		            lda #$0a
   398 3680 8D 0A D4		            sta WSYNC
   399 3683 8D 1A D0		            sta COLBK
   400 3686 A9 0E		            lda #$0e
   401 3688 8D 0A D4		            sta WSYNC
   402 368B 8D 1A D0		            sta COLBK
   403 368E A9 00		            lda #0
   404 3690 8D 0A D4		            sta WSYNC
   405 3693 8D 1A D0		            sta COLBK
   406 				            
   407 3696 68			            pla
   408 3697 AA			            tax
   409 3698 68			            pla
   410 3699 40			            rti
   411
   412 369A			menu_colpf2
   413 369A 50			            dta BASE_COLOR_P1
   414 369B 50			            dta BASE_COLOR_P1
   415 369C 50			            dta BASE_COLOR_P1
   416 369D 50			            dta BASE_COLOR_P1
   417 369E 50			            dta BASE_COLOR_P1
   418 369F 50			            dta BASE_COLOR_P1
   419 36A0 50			            dta BASE_COLOR_P1
   420 36A1 50			            dta BASE_COLOR_P1
   421
   422 36A2 B0			            dta BASE_COLOR_P2
   423 36A3 B0			            dta BASE_COLOR_P2
   424 36A4 B0			            dta BASE_COLOR_P2
   425 36A5 B0			            dta BASE_COLOR_P2
   426 36A6 B0			            dta BASE_COLOR_P2
   427 36A7 B0			            dta BASE_COLOR_P2
   428 36A8 B0			            dta BASE_COLOR_P2
   429 36A9 B0			            dta BASE_COLOR_P2
   430
   431 36AA 00 00		            dta 0,0
   432
   433 36AC			menu_colpf0
   434 				;            dta 0,0,$28,$28,$2a,$2a,$2c,$2c
   435 				;            dta $7c,$7c,$7a,$7a,$78,$78,0,0
   436 36AC 00 00		            dta 0,0
   437 36AE 00 0E 0E 0C 0A 08 +             dta 0,14,14,12,10,8,6,0
   438 36B6 00 0E 0E 0C 0A 08 +             dta 0,14,14,12,10,8,6,0
   439 36BE 00 0E 0E 0C 0A 08 +             dta 0,14,14,12,10,8,6,0
   440 36C6 00 00 00 00		            dta 0,0,0,0
   441 36CA 00 00 00 00 00 00 +             dta 0,0,0,0,0,0,0,0
   442
   443 				; make pointers from y-position to screen memory
   444 				; screen memory is 3 blocks
   445 				; screen_mem1 : 102 lines, 4080 bytes
   446 				; screen_mem2 : 102 lines, 4080 bytes
   447 				; screen_mem3 :  20 lines,  800 bytes
   448
   449 36D2			make_screen_y_tab
   450 36D2 A9 00		            lda #<screen_mem1
   451 36D4 85 86		            sta tmp_screen
   452 36D6 A9 70		            lda #>screen_mem1
   453 36D8 85 87		            sta tmp_screen+1
   454
   455 36DA A2 00		            ldx #0
   456 36DC			fill_y_tab1
   457 36DC 20 05 37		            jsr store_y_line
   458 36DF E8			            inx
   459 36E0 E0 66		            cpx #102
   460 36E2 D0 F8		            bne fill_y_tab1
   461
   462 				; x = 102
   463 36E4 A9 00		            lda #<screen_mem2
   464 36E6 85 86		            sta tmp_screen
   465 36E8 A9 80		            lda #>screen_mem2
   466 36EA 85 87		            sta tmp_screen+1
   467
   468 36EC			fill_y_tab2
   469 36EC 20 05 37		            jsr store_y_line
   470 36EF E8			            inx
   471 36F0 E0 CC		            cpx #204
   472 36F2 D0 F8		            bne fill_y_tab2
   473
   474 36F4 A9 00		            lda #<screen_mem3
   475 36F6 85 86		            sta tmp_screen
   476 36F8 A9 90		            lda #>screen_mem3
   477 36FA 85 87		            sta tmp_screen+1
   478
   479 				; x = 204
   480 36FC			fill_y_tab3
   481 36FC 20 05 37		            jsr store_y_line
   482 36FF E8			            inx
   483 3700 E0 E0		            cpx #224
   484 3702 D0 F8		            bne fill_y_tab3
   485 3704 60			            rts
   486
   487 3705			store_y_line
   488 3705 A5 86		            lda tmp_screen
   489 3707 9D 00 12		            sta screen_y_lo,x
   490 370A A5 87		            lda tmp_screen+1
   491 370C 9D 00 13		            sta screen_y_hi,x
   492 				            
   493 370F A5 86		            lda tmp_screen
   494 3711 18			            clc
   495 3712 69 28		            adc #SCREEN_WIDTH
   496 3714 85 86		            sta tmp_screen
   497 3716 A5 87		            lda tmp_screen+1
   498 3718 69 00		            adc #0
   499 371A 85 87		            sta tmp_screen+1
   500 371C 60			            rts
   501
   502 				; @todo invert backdrop image
   503 				; now we have to do it here :P
   504 371D			invert_backdrop
   505 371D A9 00		            lda #<screen_mem1
   506 371F 85 86		            sta tmp_screen
   507 3721 A9 70		            lda #>screen_mem1
   508 3723 85 87		            sta tmp_screen+1
   509 				            
   510 3725 A2 10		            ldx #16     ; 16 pages = 4K
   511 3727 20 45 37		            jsr do_x_pages
   512 				           
   513 372A A9 00		            lda #<screen_mem2
   514 372C 85 86		            sta tmp_screen
   515 372E A9 80		            lda #>screen_mem2
   516 3730 85 87		            sta tmp_screen+1
   517 				            
   518 3732 A2 10		            ldx #16     ; 16 pages = 4K
   519 3734 20 45 37		            jsr do_x_pages
   520
   521 3737 A9 00		            lda #<screen_mem3
   522 3739 85 86		            sta tmp_screen
   523 373B A9 90		            lda #>screen_mem3
   524 373D 85 87		            sta tmp_screen+1
   525 				            
   526 373F A2 04		            ldx #4     ; 4 pages = 1K
   527 3741 20 45 37		            jsr do_x_pages
   528 3744 60			            rts
   529
   530 				; invert x pages, starting from tmp_screen
   531
   532 3745			do_x_pages
   533 3745 A0 00		            ldy #0
   534 3747			do_page
   535 3747 B1 86		            lda (tmp_screen),y
   536 3749 49 FF		            eor #$ff
   537 374B 91 86		            sta (tmp_screen),y
   538 374D C8			            iny
   539 374E D0 F7		            bne do_page 
   540
   541 3750 E6 87		            inc tmp_screen+1
   542 3752 CA			            dex
   543 3753 D0 F2		            bne do_page
   544 3755 60			            rts
   545
   546 3756			turn_color_ball
   547 3756 A6 B5		            ldx player_turn
   548 3758 BD 5F 37		            lda color_turn,x
   549 375B 8D C7 02		            sta COLOR3
   550 375E 60			            rts
   551 				            
   552 375F 00 56 B6		color_turn  dta 0,BASE_COLOR_P1+6,BASE_COLOR_P2+6                           
   553
   554 3762			show_menu_options
   555 3762 A9 50		            lda #<controller_text
   556 3764 8D F6 50		            sta menu_line1_ptr
   557 3767 A9 52		            lda #>controller_text
   558 3769 8D F7 50		            sta menu_line1_ptr+1
   559
   560 376C 20 CA 3F		            jsr show_player_mode
   561
   562 376F A9 9F		            lda #<level_text
   563 3771 8D FC 50		            sta menu_line3_ptr
   564 3774 A9 52		            lda #>level_text
   565 3776 8D FD 50		            sta menu_line3_ptr+1
   566
   567 3779 A9 00		            lda #0
   568 377B 85 83		            sta winner_color
   569 377D 60			            rts
   570
   571 377E			show_end_screen
   572 377E A9 FB		            lda #<empty_text
   573 3780 8D F6 50		            sta menu_line1_ptr
   574 3783 8D FC 50		            sta menu_line3_ptr
   575 3786 A9 52		            lda #>empty_text
   576 3788 8D F7 50		            sta menu_line1_ptr+1
   577 378B 8D FD 50		            sta menu_line3_ptr+1
   578
   579 378E AD 2E 51		            lda score_p1
   580 3791 CD 2F 51		            cmp score_p2
   581 3794 90 0F		            bcc player_2_wins
   582
   583 3796 A9 0F		            lda #<winner_one_text
   584 3798 8D F9 50		            sta menu_line2_ptr
   585 379B A9 53		            lda #>winner_one_text
   586 379D 8D FA 50		            sta menu_line2_ptr+1
   587
   588 37A0 A9 50		            lda #BASE_COLOR_P1
   589 37A2 85 83		            sta winner_color
   590 37A4 60			            rts
   591
   592 37A5			player_2_wins
   593 37A5 A9 23		            lda #<winner_two_text
   594 37A7 8D F9 50		            sta menu_line2_ptr
   595 37AA A9 53		            lda #>winner_two_text
   596 37AC 8D FA 50		            sta menu_line2_ptr+1
   597
   598 37AF A9 B0		            lda #BASE_COLOR_P2
   599 37B1 85 83		            sta winner_color
   600
   601 37B3 60			            rts
   602
   603 				; A, X, Y are already saved by the OS
   604 37B4			vbi
   605 37B4 20 DC 31		            jsr copy_shadow
   606
   607 37B7 A5 80		            lda music_toggle
   608 37B9 F0 03		            beq skip_music
   609 37BB 20 97 31		            jsr play_song
   610 37BE			skip_music
   611
   612 				; toggle music on/off with spacebar
   613 37BE AD FC 02		            lda 764
   614 37C1 C9 21		            cmp #$21
   615 37C3 D0 10		            bne no_spacebar
   616 37C5 A5 80		            lda music_toggle
   617 37C7 49 80		            eor #128
   618 37C9 85 80		            sta music_toggle
   619 37CB D0 03		            bne music_turned_on
   620 37CD 20 60 32		            jsr music_off
   621
   622 37D0			music_turned_on
   623 37D0 A9 FF		            lda #255
   624 37D2 8D FC 02		            sta 764
   625
   626 37D5			no_spacebar
   627 37D5 20 3A 3A		            jsr play_sound_bat
   628 37D8 20 58 3A		            jsr play_sound_edge
   629
   630 37DB A9 0B		            lda #<dli_header
   631 37DD 8D 00 02		            sta VDSLST
   632 37E0 A9 36		            lda #>dli_header
   633 37E2 8D 01 02		            sta VDSLST+1
   634
   635 37E5 A9 2E		            lda #%00101110  ; enable P/M DMA
   636 37E7 8D 2F 02		            sta SDMCTL
   637 37EA A9 00		            lda #0
   638 37EC 85 4D		            sta 77      ; attract off
   639 37EE A9 98		            lda #>rotor_font
   640 37F0 8D F4 02		            sta 756
   641
   642 37F3 A9 30		            lda #$30
   643 37F5 8D 00 D0		            sta HPOSP0
   644 37F8 A9 B0		            lda #$b0
   645 37FA 8D 01 D0		            sta HPOSP1
   646
   647 				; menu switching thingy
   648
   649 37FD AD 1F D0		            lda CONSOL
   650 3800 C9 03		            cmp #3  ; option button
   651 3802 D0 17		            bne no_option_pressed
   652 3804 A5 8C		            lda game_state
   653 3806 C9 01		            cmp #STATE_IN_MENU
   654 3808 F0 2E		            beq check_game_state
   655
   656 				; prevent menu option directly after leaving in-game state
   657 380A A9 03		            lda #3
   658 380C 8D 7B 3F		            sta previous_consol
   659
   660 380F			go_menu_mode
   661 380F 20 0C 3C		            jsr wipe_ball
   662
   663 3812 20 FA 31		            jsr music_normal_volume
   664
   665 3815 20 5B 38		            jsr switch_to_menu
   666
   667 3818 4C 38 38		            jmp check_game_state
   668
   669 381B			no_option_pressed
   670 381B C9 06		            cmp #6  ; start pressed
   671 381D F0 05		            beq reset_game
   672
   673 				; check autostart state
   674
   675 381F AD 6A 38		            lda autostart_demo
   676 3822 F0 14		            beq check_game_state
   677
   678 				; reset game
   679
   680 3824			reset_game
   681 3824 20 05 32		            jsr music_low_volume
   682
   683 3827 20 0C 3C		            jsr wipe_ball
   684
   685 382A 20 EB 3A		            jsr reset_robot_angle_end
   686
   687 382D A9 01		            lda #1
   688 382F 85 B6		            sta game_restart
   689
   690 3831 20 6D 38		            jsr reset_autostart_demo
   691
   692 3834 A9 00		            lda #STATE_IN_GAME
   693 3836 85 8C		            sta game_state
   694
   695 3838			check_game_state
   696 3838 A5 8C		            lda game_state
   697 383A D0 03		            bne no_main_game_state
   698 383C 4C 36 39		            jmp main_game_vbi
   699
   700 383F			no_main_game_state
   701 383F C9 02		            cmp #STATE_IN_END
   702 3841 D0 58		            bne menu_vbi
   703
   704 				; end screen vbi
   705 3843 A5 8F		            lda end_screen_delay
   706 3845 D0 0C		            bne stay_in_end_screen
   707
   708 3847 20 A6 31		            jsr restart_music
   709 384A 20 FA 31		            jsr music_normal_volume
   710
   711 384D 20 5B 38		            jsr switch_to_menu
   712
   713 3850 4C 9B 38		            jmp menu_vbi
   714
   715 3853			stay_in_end_screen
   716 3853 20 1C 3A		            jsr play_sound_end_game
   717 3856 C6 8F		            dec end_screen_delay
   718 3858 4C E7 38		            jmp wait_depressed
   719
   720 385B			switch_to_menu
   721 385B A5 8B		            lda player_mode_saved
   722 385D 85 8A		            sta player_mode
   723
   724 385F 20 62 37		            jsr show_menu_options
   725
   726 3862 20 43 34		            jsr reset_driver_mode
   727
   728 3865 A9 01		            lda #STATE_IN_MENU
   729 3867 85 8C		            sta game_state
   730 3869 60			            rts
   731
   732 				; demo autostart
   733
   734 386A 00			autostart_demo  dta 0
   735 386B 00 00		autostart_timer dta 0,0
   736
   737 386D			reset_autostart_demo
   738 386D A9 00		            lda #0
   739 386F 8D 6A 38		            sta autostart_demo      ; do not start again
   740 3872 8D 6B 38		            sta autostart_timer
   741 3875 A9 1E		            lda #30                 ; N * 5 seconds (roughly)
   742 3877 8D 6C 38		            sta autostart_timer+1
   743 387A 60			            rts
   744
   745 387B			handle_autostart_timer
   746 387B AD 6B 38		            lda autostart_timer
   747 387E 0D 6C 38		            ora autostart_timer+1
   748 3881 F0 17		            beq idle_timer
   749 3883 CE 6B 38		            dec autostart_timer
   750 3886 D0 12		            bne running_timer
   751 3888 CE 6C 38		            dec autostart_timer+1
   752 388B D0 0D		            bne running_timer
   753
   754 				; timer reached zero
   755 388D A9 01		            lda #1
   756 388F 8D 6A 38		            sta autostart_demo
   757 3892 A5 8A		            lda player_mode
   758 3894 85 8B		            sta player_mode_saved
   759 3896 A9 02		            lda #2
   760 3898 85 8A		            sta player_mode
   761
   762 389A			running_timer
   763 389A			idle_timer
   764 389A 60			            rts
   765
   766 				; within menu vbi
   767
   768 389B			menu_vbi
   769 389B 20 7B 38		            jsr handle_autostart_timer
   770
   771 389E A5 8A		            lda player_mode
   772 38A0 F0 08		            beq check_human_buttons
   773
   774 38A2 20 D6 34		            jsr is_player1_button_pressed
   775 38A5 F0 0B		            beq check_consol_buttons
   776 38A7 4C 24 38		            jmp reset_game
   777
   778 38AA			check_human_buttons
   779 38AA 20 ED 34		            jsr is_both_buttons
   780 38AD F0 03		            beq check_consol_buttons
   781 38AF 4C 24 38		            jmp reset_game
   782
   783 38B2			check_consol_buttons
   784 38B2 AD 1F D0		            lda CONSOL
   785 38B5 C9 05		            cmp #5          ; select
   786 38B7 D0 18		            bne no_level_select
   787 				            
   788 38B9 AD 7B 3F		            lda previous_consol
   789 38BC C9 05		            cmp #5
   790 38BE F0 27		            beq wait_depressed
   791
   792 38C0 20 AB 3F		            jsr increase_level
   793 38C3 AE 7C 3F		            ldx current_level_index
   794 38C6 20 92 3F		            jsr set_level_ball_speed
   795
   796 38C9 A9 05		            lda #5
   797 38CB 8D 7B 3F		            sta previous_consol
   798 38CE 4C E7 38		            jmp wait_depressed
   799
   800 38D1			no_level_select
   801 38D1 C9 03		            cmp #3          ; option
   802 38D3 D0 0F		            bne no_player_mode_select
   803
   804 38D5 AD 7B 3F		            lda previous_consol
   805 38D8 C9 03		            cmp #3
   806 38DA F0 0B		            beq wait_depressed
   807
   808 38DC 20 BB 3F		            jsr increase_player_mode
   809 38DF 20 CA 3F		            jsr show_player_mode
   810
   811 38E2 A9 03		            lda #3
   812 38E4			no_player_mode_select
   813 38E4 8D 7B 3F		            sta previous_consol
   814
   815 38E7			wait_depressed
   816 38E7 A9 01		            lda #1      ; dl jump
   817 38E9 8D 55 50		            sta menu_dl_hook
   818 38EC A9 EE		            lda #<menu_dl_part
   819 38EE 8D 56 50		            sta menu_dl_hook+1
   820 38F1 A9 50		            lda #>menu_dl_part
   821 38F3 8D 57 50		            sta menu_dl_hook+2
   822
   823 				; detect/show controller type (used for both players)
   824 38F6 20 1D 39		            jsr detect_show_driver
   825
   826 38F9 A5 8A		            lda player_mode
   827 38FB C9 00		            cmp #MODE_2_PLAYER
   828 38FD F0 15		            beq no_robot_in_menu
   829
   830 38FF C9 01		            cmp #MODE_1_PLAYER
   831 3901 F0 0B		            beq one_robot_in_menu
   832 				; demo mode, both robots in menu
   833 3903 A5 9C		            lda p1_angle
   834 3905 C5 BA		            cmp robot1_angle_end
   835 3907 D0 05		            bne robot1_moves_to_goal
   836
   837 3909 AD 0A D2		            lda RANDOM
   838 390C 85 BA		            sta robot1_angle_end
   839
   840 390E			robot1_moves_to_goal
   841 390E			one_robot_in_menu
   842 390E A5 9C		            lda p1_angle
   843 3910 49 80		            eor #128
   844 3912 85 BB		            sta robot2_angle_end
   845
   846 3914			no_robot_in_menu
   847 3914 20 A7 3A		            jsr handle_player1
   848 3917 20 CA 3A		            jsr handle_player2
   849
   850 391A 4C F1 39		            jmp exit_vbi
   851
   852 				; X = port/driver to detect
   853 391D			detect_show_driver
   854 391D 20 49 34		            jsr driver_detect
   855 3920 A8			            tay
   856 3921 B9 37 53		            lda driver_text_lo,y
   857 3924 85 86		            sta tmp_screen
   858 3926 B9 3B 53		            lda driver_text_hi,y
   859 3929 85 87		            sta tmp_screen+1
   860
   861 392B A0 07		            ldy #7
   862 392D			show_driv
   863 392D B1 86		            lda (tmp_screen),y
   864 392F 99 5A 52		            sta driver_screen,y
   865 3932 88			            dey
   866 3933 10 F8		            bpl show_driv
   867 3935 60			            rts
   868
   869 				; main game vbi
   870 3936			main_game_vbi
   871 3936 A5 B6		            lda game_restart
   872 3938 F0 33		            beq no_restart
   873
   874 				; restart game
   875
   876 393A 20 34 3A		            jsr silence_end
   877
   878 393D A9 00		            lda #0
   879 393F 85 B6		            sta game_restart
   880 				            
   881 3941 20 5B 3D		            jsr reset_score
   882 3944 20 29 3D		            jsr show_score_p1
   883 3947 20 42 3D		            jsr show_score_p2
   884
   885 394A A6 9C		            ldx p1_angle
   886 394C 86 AA		            stx ball_angle_start
   887 394E 20 67 3B		            jsr ball_to_start_position
   888 3951 20 76 3B		            jsr prepare_ball_end_position
   889
   890 3954 A9 00		            lda #0
   891 3956 85 A0		            sta mp_collision
   892 3958 85 A1		            sta in_collision
   893 395A 85 A3		            sta edge_delay
   894 395C 85 AD		            sta edge_collision
   895 395E 85 AE		            sta edge_hit_count
   896 3960 8D 1E D0		            sta HITCLR
   897
   898 3963 A9 02		            lda #2
   899 3965 85 B5		            sta player_turn
   900
   901 3967 20 56 37		            jsr turn_color_ball
   902 396A 4C F1 39		            jmp exit_vbi
   903
   904 396D			no_restart
   905 				; remove menu hook
   906 396D A9 0F		            lda #$0f        ; dl gfx 8
   907 396F 8D 55 50		            sta menu_dl_hook
   908 3972 8D 56 50		            sta menu_dl_hook+1
   909 3975 8D 57 50		            sta menu_dl_hook+2
   910
   911 3978 AD 08 D0		            lda M0PL
   912 397B 85 A0		            sta mp_collision
   913 397D AD 09 D0		            lda M1PL
   914 3980 05 A0		            ora mp_collision
   915 3982 85 A0		            sta mp_collision
   916
   917 3984 AD 00 D0		            lda M0PF
   918 3987 85 AD		            sta edge_collision
   919 3989 AD 01 D0		            lda M1PF
   920 398C 05 AD		            ora edge_collision
   921 398E 85 AD		            sta edge_collision
   922 				;           beq no_edge_collision
   923
   924 				;            inc edge_hit_count
   925 				;            lda edge_hit_count
   926 				;            cmp #2
   927 				;            bcc edge_hit_counting
   928
   929 				;            sei
   930 				;lalala      jmp lalala
   931
   932 				;no_edge_collision
   933 				;            lda #0
   934 				;            sta edge_hit_count
   935
   936 3990			edge_hit_counting
   937 3990 20 A7 3A		            jsr handle_player1
   938 3993 20 CA 3A		            jsr handle_player2
   939
   940 				; handle ball
   941
   942 3996 20 0C 3C		            jsr wipe_ball         
   943
   944 				; Check ball collision with bat
   945
   946 3999 A5 A4		            lda bat_collision_delay
   947 399B F0 05		            beq check_allowed
   948 399D C6 A4		            dec bat_collision_delay
   949 399F 4C B9 39		            jmp move_one
   950
   951 39A2			check_allowed
   952 39A2 A5 A0		            lda mp_collision
   953 39A4 F0 0F		            beq reset_in_collision
   954
   955 39A6 A5 A1		            lda in_collision
   956 39A8 D0 0F		            bne no_first_hit
   957
   958 39AA E6 A1		            inc in_collision            
   959 39AC 20 A3 3B		            jsr bounce_bat_ball 
   960 				            
   961 39AF 20 17 3A		            jsr start_sound_bat          
   962 				            
   963 39B2 4C B9 39		            jmp move_one
   964 				            
   965 39B5			reset_in_collision
   966 39B5 A9 00		            lda #0
   967 39B7 85 A1		            sta in_collision        
   968
   969 39B9			move_one
   970 39B9			no_first_hit
   971 39B9 20 AD 3E		            jsr move_current_xy
   972
   973 39BC A5 AD		            lda edge_collision
   974 39BE F0 1E		            beq still_moving
   975
   976 				; edge detected
   977
   978 39C0			edge_detected
   979 39C0 20 53 3A		            jsr start_sound_edge
   980
   981 39C3 A5 AB		            lda ball_angle_end
   982 39C5 85 AA		            sta ball_angle_start
   983
   984 39C7 20 9A 3B		            jsr ball_current_to_start_position
   985 39CA 20 76 3B		            jsr prepare_ball_end_position
   986
   987 39CD 20 73 3A		            jsr update_score
   988 39D0 D0 37		            bne game_ends
   989
   990 				; switch turns
   991 39D2 A5 B5		            lda player_turn
   992 39D4 49 03		            eor #3              ; 1 => 2, 2 => 1
   993 39D6 85 B5		            sta player_turn
   994 39D8 20 56 37		            jsr turn_color_ball
   995 39DB 20 F4 3A		            jsr set_robot_angle_end
   996
   997 39DE			still_moving
   998 39DE A5 EB		            lda current_x+1
   999 39E0 85 A6		            sta ball_current_x
  1000 39E2 A5 ED		            lda current_y+1
  1001 39E4 85 A7		            sta ball_current_y
  1002
  1003 39E6 20 21 3C		            jsr show_ball
  1004
  1005 39E9 A9 00		            lda #0
  1006 39EB 8D 18 D0		            sta $d018           
  1007
  1008 				; anything in A to clear collisions
  1009 39EE 8D 1E D0		            sta HITCLR
  1010
  1011 39F1			exit_vbi
  1012
  1013 				; always set header stuff
  1014 39F1 A9 03		            lda #3
  1015 39F3 8D 08 D0		            sta SIZEP0
  1016 39F6 8D 09 D0		            sta SIZEP1
  1017
  1018 				; background in PM0/1 for header
  1019 39F9 A9 FF		            lda #255
  1020 39FB A2 07		            ldx #7
  1021 39FD			fill_pm_header
  1022 39FD 9D 00 0E		            sta p0_area,x
  1023 3A00 9D 80 0E		            sta p1_area,x
  1024 3A03 CA			            dex
  1025 3A04 10 F7		            bpl fill_pm_header
  1026
  1027 3A06 4C 62 E4		            jmp $e462
  1028
  1029 3A09			game_ends
  1030 3A09 A9 FF		            lda #255
  1031 3A0B 85 8F		            sta end_screen_delay
  1032
  1033 3A0D 20 7E 37		            jsr show_end_screen
  1034
  1035 3A10 A9 02		            lda #STATE_IN_END
  1036 3A12 85 8C		            sta game_state
  1037
  1038 3A14 4C F1 39		            jmp exit_vbi
  1039
  1040 3A17			start_sound_bat
  1041 3A17 A9 0A		            lda #10
  1042 3A19 85 8D		            sta volume_hit_bat
  1043 3A1B 60			            rts
  1044
  1045 3A1C			play_sound_end_game
  1046 3A1C 20 60 32		            jsr music_off
  1047
  1048 3A1F A5 8F		            lda end_screen_delay
  1049 3A21 C9 C0		            cmp #192
  1050 3A23 90 0F		            bcc silence_end
  1051 3A25 4A			            lsr
  1052 3A26 25 8F		            and end_screen_delay
  1053 3A28 4A			            lsr
  1054 3A29 09 20		            ora #$20
  1055 3A2B 8D 73 32		            sta SHADOW+4
  1056 				            ;lda end_screen_delay
  1057 3A2E A9 AA		            lda #$aa
  1058 3A30 8D 74 32		            sta SHADOW+5
  1059 3A33 60			            rts
  1060 3A34			silence_end
  1061 3A34 A9 00		            lda #0
  1062 3A36 8D 74 32		            sta SHADOW+5
  1063 3A39 60			            rts
  1064
  1065 3A3A			play_sound_bat
  1066 3A3A A5 8D		            lda volume_hit_bat
  1067 3A3C 30 14		            bmi silenced_bat
  1068
  1069 3A3E A5 B5		            lda player_turn
  1070 3A40 0A			            asl
  1071 3A41 0A			            asl
  1072 3A42 69 30		            adc #$30
  1073 3A44 E5 B3		            sbc angle_diff_bat
  1074 3A46 8D 73 32		            sta SHADOW+4    ; $d204
  1075 3A49 A5 8D		            lda volume_hit_bat
  1076 3A4B 09 A0		            ora #$a0
  1077 3A4D 8D 74 32		            sta SHADOW+5    ; $d205
  1078 3A50 C6 8D		            dec volume_hit_bat
  1079 3A52			silenced_bat
  1080 3A52 60			            rts
  1081
  1082 3A53			start_sound_edge
  1083 3A53 A9 04		            lda #4
  1084 3A55 85 8E		            sta volume_hit_edge
  1085 3A57 60			            rts
  1086
  1087 3A58			play_sound_edge
  1088 3A58 A5 8E		            lda volume_hit_edge
  1089 3A5A 30 16		            bmi silenced_edge
  1090 3A5C D0 06		            bne no_silenced_edge
  1091 3A5E 8D 74 32		            sta SHADOW+5    ; $d205
  1092 3A61 C6 8E		            dec volume_hit_edge
  1093 3A63 60			            rts            
  1094
  1095 3A64			no_silenced_edge
  1096 3A64 A9 08		            lda #$08
  1097 3A66 8D 73 32		            sta SHADOW+4    ; $d204
  1098 3A69 A5 8E		            lda volume_hit_edge
  1099 3A6B 09 26		            ora #$26
  1100 3A6D 8D 74 32		            sta SHADOW+5    ; $d205
  1101 3A70 C6 8E		            dec volume_hit_edge
  1102 3A72			silenced_edge
  1103 3A72 60			            rts
  1104
  1105 				; Update score
  1106 				; Score > max score, then exit A = 1, otherwise A = 0
  1107
  1108 3A73			update_score
  1109 3A73 A5 B5		            lda player_turn
  1110 3A75 C9 01		            cmp #1
  1111 3A77 D0 12		            bne was_player2_turn
  1112 				; was player 1 turn, so player 2 gets a point
  1113 3A79 20 70 3D		            jsr inc_score_p2
  1114 3A7C 20 42 3D		            jsr show_score_p2
  1115
  1116 3A7F AD 2F 51		            lda score_p2
  1117 3A82 C9 11		            cmp #MAX_SCORE
  1118 3A84 D0 17		            bne reset_edge_delay
  1119
  1120 3A86 A9 01		            lda #STATE_IN_MENU
  1121 3A88 85 8C		            sta game_state
  1122 3A8A 60			            rts
  1123
  1124 3A8B			was_player2_turn
  1125 3A8B 20 64 3D		            jsr inc_score_p1
  1126 3A8E 20 29 3D		            jsr show_score_p1
  1127
  1128 3A91 AD 2E 51		            lda score_p1
  1129 3A94 C9 11		            cmp #MAX_SCORE
  1130 3A96 D0 05		            bne reset_edge_delay
  1131
  1132 3A98 A9 01		            lda #STATE_IN_MENU
  1133 3A9A 85 8C		            sta game_state
  1134 3A9C 60			            rts
  1135
  1136 3A9D			reset_edge_delay
  1137 3A9D A9 0A		            lda #10
  1138 3A9F 85 A3		            sta edge_delay
  1139
  1140 3AA1			no_edge
  1141
  1142 3AA1 A9 00		            lda #0      ; no end game
  1143 				; anything in A to clear collisions
  1144 3AA3 8D 1E D0		            sta HITCLR
  1145 3AA6 60			            rts
  1146
  1147 				; player 1
  1148 				; - wipe shape at previous y-position
  1149 				; - move player using controller
  1150 				; - set sprite positions
  1151
  1152 3AA7			handle_player1
  1153 3AA7 20 91 3C		            jsr wipe_p1         ; wipe previous shape player 1
  1154
  1155 3AAA A5 8A		            lda player_mode
  1156 3AAC C9 02		            cmp #2
  1157 3AAE F0 0C		            beq do_p1_is_computer
  1158
  1159 3AB0 A2 00		            ldx #0              ; player 1
  1160 3AB2 20 83 34		            jsr main_driver
  1161 3AB5 20 49 3B		            jsr move_player
  1162 				            
  1163 3AB8 20 45 3C		            jsr show_p1
  1164 3ABB 60			            rts
  1165
  1166 				; p1 now controlled by computer
  1167 3ABC			do_p1_is_computer
  1168 3ABC A5 8C		            lda game_state
  1169
  1170 3ABE A2 00		            ldx #0              ; player 1
  1171 3AC0 20 1A 3B		            jsr robot_controller
  1172
  1173 3AC3 20 49 3B		            jsr move_player
  1174 3AC6 20 45 3C		            jsr show_p1
  1175 3AC9 60			            rts
  1176
  1177 				; player 2
  1178 				; - wipe shape at previous y-position
  1179 				; - move player using controller
  1180 				; - set sprite positions
  1181
  1182 3ACA			handle_player2
  1183 3ACA 20 A6 3C		            jsr wipe_p2         ; wipe previous shape player 2
  1184
  1185 3ACD A5 8A		            lda player_mode
  1186 3ACF D0 0C		            bne do_p2_is_computer
  1187
  1188 3AD1 A2 01		            ldx #1              ; player 2
  1189 3AD3 20 83 34		            jsr main_driver
  1190 3AD6 20 49 3B		            jsr move_player
  1191 				                        
  1192 3AD9 20 6B 3C		            jsr show_p2
  1193 3ADC 60			            rts
  1194
  1195 				; p2 now controlled by computer
  1196 3ADD			do_p2_is_computer
  1197 3ADD A5 8C		            lda game_state
  1198
  1199 3ADF A2 01		            ldx #1              ; player 2
  1200 3AE1 20 1A 3B		            jsr robot_controller
  1201
  1202 3AE4 20 49 3B		            jsr move_player
  1203 3AE7 20 6B 3C		            jsr show_p2
  1204
  1205 3AEA			not_in_game
  1206 3AEA 60			            rts
  1207
  1208 3AEB			reset_robot_angle_end
  1209 3AEB A9 00		            lda #0
  1210 3AED 85 BA		            sta robot1_angle_end
  1211 3AEF A9 80		            lda #128
  1212 3AF1 85 BB		            sta robot2_angle_end
  1213 3AF3 60			            rts
  1214
  1215 3AF4			set_robot_angle_end
  1216 3AF4 A6 B5		            ldx player_turn
  1217 3AF6 CA			            dex
  1218 3AF7 AD 0A D2		            lda RANDOM
  1219 3AFA 29 07		            and #7
  1220 3AFC 18			            clc
  1221 3AFD 65 AB		            adc ball_angle_end
  1222 3AFF 38			            sec
  1223 3B00 E9 03		            sbc #3
  1224 3B02 95 BA		            sta robot_angle_end,x
  1225
  1226 				; other robot (not your turn)
  1227 3B04 A5 B5		            lda player_turn
  1228 3B06 49 03		            eor #3
  1229 3B08 AA			            tax
  1230 3B09 CA			            dex
  1231
  1232 3B0A AD 0A D2		            lda RANDOM
  1233 3B0D 29 0F		            and #15
  1234 3B0F 18			            clc
  1235 3B10 65 AB		            adc ball_angle_end
  1236 3B12 38			            sec
  1237 3B13 E9 07		            sbc #7
  1238 3B15 49 80		            eor #128            ; other side
  1239 3B17 95 BA		            sta robot_angle_end,x
  1240
  1241 3B19 60			            rts
  1242
  1243 				; x = 0 (robot 1), x = 1 (robot 2)
  1244
  1245 3B1A			robot_controller
  1246 				;            lda ball_angle_end  ; current ball end
  1247 3B1A B5 BA		            lda robot_angle_end,x
  1248 3B1C 85 B0		            sta tmp_angle1
  1249 3B1E B5 9C		            lda p1_angle,x
  1250 3B20 85 B1		            sta tmp_angle2
  1251
  1252 3B22 20 7C 3D		            jsr calc_angle_diff
  1253
  1254 3B25 A5 B7		            lda tmp_angle_diff
  1255 3B27 F0 1F		            beq comp_in_catch_position
  1256 3B29 A5 B4		            lda tmp_angle_direction
  1257 3B2B D0 0E		            bne move_comp_clockwise
  1258
  1259 3B2D AD 0A D2		            lda RANDOM
  1260 3B30 29 03		            and #3
  1261 3B32 D0 14		            bne comp_in_catch_position
  1262 3B34 B5 9C		            lda p1_angle,x
  1263 3B36 65 88		            adc stick_slow_speed
  1264 3B38 95 9C		            sta p1_angle,x
  1265 3B3A 60			            rts
  1266 3B3B			move_comp_clockwise
  1267
  1268 3B3B AD 0A D2		            lda RANDOM
  1269 3B3E 29 03		            and #3
  1270 3B40 D0 06		            bne comp_in_catch_position
  1271
  1272 3B42 B5 9C		            lda p1_angle,x
  1273 3B44 E5 88		            sbc stick_slow_speed
  1274 3B46 95 9C		            sta p1_angle,x
  1275 3B48			comp_in_catch_position
  1276 3B48 60			            rts
  1277
  1278 				; move player 1/2
  1279 				; right - clockwise, left = anti-clockwise
  1280
  1281 				; X = 0, player 1
  1282 				; X = 1, player 2
  1283
  1284 				; Y = driver mode:
  1285 				; 0 : stick
  1286 				; 1 : paddle
  1287 				; 2 : mouse
  1288 				; 3 : computer
  1289 				            
  1290 3B49			move_player
  1291 3B49 B5 9C		            lda p1_angle,x
  1292 3B4B 29 7F		            and #127                    ; restrict angle to 0..179 degrees
  1293 3B4D 49 40		            eor #64                     ; perpendicular to the circle angle
  1294 3B4F 95 90		            sta p1_shape,x
  1295
  1296 3B51 B4 9C		            ldy p1_angle,x
  1297 3B53 B9 00 40		            lda inner_x_tab,y
  1298 3B56 4A			            lsr
  1299 3B57 69 20		            adc #inner_x_margin/2
  1300 3B59 95 94		            sta player1_x,x
  1301 3B5B B9 00 41		            lda inner_y_tab,y
  1302 3B5E 4A			            lsr
  1303 3B5F 95 98		            sta player1_y,x
  1304
  1305 3B61 B4 90		            ldy p1_shape,x
  1306 3B63 20 E0 3C		            jsr shape_to_ptr
  1307
  1308 3B66 60			            rts
  1309
  1310 				; Set ball at start position
  1311 				; - start angle current player
  1312 				; - start position by inner table
  1313 				; - collision delay set?
  1314
  1315 				; Set ball current position to start position
  1316 				; input:
  1317 				; X = angle of start position
  1318 				; output:
  1319 				; ball position: (ball_current_x, ball_current_y)
  1320 				; (tmp_x1, tmp_y1) = (ball_current_x, ball_current_y)
  1321 3B67			ball_to_start_position
  1322 3B67 BD 00 40		            lda inner_x_tab,x
  1323 3B6A 85 A6		            sta ball_current_x
  1324 3B6C 85 E6		            sta tmp_x1
  1325 3B6E BD 00 41		            lda inner_y_tab,x
  1326 3B71 85 A7		            sta ball_current_y
  1327 3B73 85 E7		            sta tmp_y1
  1328 3B75 60			            rts
  1329
  1330 				; Prepare ball end position
  1331 				; - end angle current player
  1332 				; - end position by outer table
  1333 				; - calculate step size x,y
  1334
  1335 				; Input:
  1336 				; - ball_angle_start
  1337 				; - ball speed
  1338 				; Output:
  1339 				; - ball_andle_end
  1340 				; - ball start position (tmp_x1, tmp_y1)
  1341 				; - ball end position (tmp_x2, tmp_y2)
  1342 				; - step size (step_x, step_y) for ball movement
  1343 3B76			prepare_ball_end_position
  1344 3B76 A5 AA		            lda ball_angle_start
  1345 3B78 49 80		            eor #128        ; other side
  1346 3B7A 85 AB		            sta ball_angle_end
  1347 3B7C AA			            tax
  1348 3B7D 20 01 3C		            jsr angle_to_end_position
  1349 				                        
  1350 3B80 20 40 3E		            jsr init_current_xy
  1351 				            
  1352 				; move current a little bit            
  1353 3B83 20 AD 3E		            jsr move_current_xy
  1354 				; ignore end indicator, since we only just started
  1355
  1356 3B86 A9 0A		            lda #10         ; ball can touch bat at start position, so use this delay
  1357 3B88 85 A4		            sta bat_collision_delay
  1358 3B8A 60			            rts
  1359
  1360 				; x = angle 0..255
  1361 3B8B			outer_angle_to_start_position
  1362 3B8B BD 00 10		            lda outer_x_256,x
  1363 3B8E 85 A6		            sta ball_current_x
  1364 3B90 85 E6		            sta tmp_x1
  1365 3B92 BD 00 11		            lda outer_y_256,x
  1366 3B95 85 A7		            sta ball_current_y
  1367 3B97 85 E7		            sta tmp_y1
  1368 3B99 60			            rts
  1369
  1370 3B9A			ball_current_to_start_position
  1371 3B9A A5 A6		            lda ball_current_x
  1372 3B9C 85 E6		            sta tmp_x1
  1373 3B9E A5 A7		            lda ball_current_y
  1374 3BA0 85 E7		            sta tmp_y1
  1375 3BA2 60			            rts
  1376
  1377 				; Ball collides with bat
  1378 				; - start ball angle = end ball angle
  1379 				; - calculate diff between bat and ball end angle
  1380 				; - calculate new end angle
  1381 				; - Set ball at start position
  1382 				; - Prepare ball end position
  1383
  1384 3BA3			bounce_bat_ball
  1385 				; set new start of ball
  1386 				; @todo check ball angles
  1387 				; set new ball start angle (= previous end angle)
  1388 3BA3 A5 AB		            lda ball_angle_end
  1389 3BA5 85 AA		            sta ball_angle_start
  1390 				            
  1391 				; alternative?
  1392 				            ;ldx ball_angle_start
  1393 				            ;jsr ball_to_start_position          
  1394 3BA7 20 9A 3B		            jsr ball_current_to_start_position
  1395
  1396 				; which player hit the ball?
  1397 				; collision bits:
  1398 				; xxxxx1x1 : 1 is player1 collision
  1399 				; xxxx1010 : 2 is player2 collision
  1400
  1401 3BAA A5 A0		            lda mp_collision
  1402 3BAC 4A			            lsr
  1403 3BAD 4A			            lsr
  1404 3BAE 05 A0		            ora mp_collision
  1405 3BB0 29 03		            and #%00000011      ; 01 = player1, 10 = player2, 11 = both
  1406
  1407 				; who's turn is it and who bounced the ball?
  1408
  1409 3BB2 25 B5		            and player_turn
  1410 3BB4 F0 06		            beq no_switch_turn
  1411
  1412 3BB6 A5 B5		            lda player_turn
  1413 3BB8 49 03		            eor #3              ; 1 => 2, 2 => 1
  1414 3BBA 85 B5		            sta player_turn
  1415
  1416 3BBC			no_switch_turn
  1417 3BBC 20 56 37		            jsr turn_color_ball
  1418
  1419 3BBF A5 B5		            lda player_turn
  1420 3BC1 49 03		            eor #3
  1421 3BC3 AA			            tax
  1422 3BC4 CA			            dex                 ; index 0,1 (player = 1,2)
  1423 3BC5 B5 9C		            lda p1_angle,x
  1424
  1425 				; Calculate diff between bat angle position and new ball start position
  1426 3BC7 85 B0		            sta tmp_angle1
  1427
  1428 3BC9 A5 AA		            lda ball_angle_start
  1429 3BCB 85 B1		            sta tmp_angle2
  1430
  1431 3BCD 20 7C 3D		            jsr calc_angle_diff
  1432
  1433 3BD0 0A			            asl
  1434 3BD1 0A			            asl
  1435 3BD2 0A			            asl
  1436 3BD3 85 B3		            sta angle_diff_bat
  1437
  1438 3BD5 A5 B0		            lda tmp_angle1
  1439 3BD7 18			            clc
  1440 3BD8 65 B2		            adc add_to_angle
  1441 3BDA 49 80		            eor #128            ; other side
  1442 3BDC 85 B0		            sta tmp_angle1
  1443 				            
  1444 3BDE A5 B4		            lda tmp_angle_direction
  1445 3BE0 D0 0A		            bne diff_clockwise
  1446 				; diff counter clockwise
  1447 3BE2 A5 B0		            lda tmp_angle1
  1448 3BE4 18			            clc
  1449 3BE5 65 B3		            adc angle_diff_bat
  1450 3BE7 85 B0		            sta tmp_angle1
  1451 3BE9 4C F3 3B		            jmp calc_done            
  1452
  1453 3BEC			diff_clockwise
  1454 3BEC A5 B0		            lda tmp_angle1
  1455 3BEE 38			            sec
  1456 3BEF E5 B3		            sbc angle_diff_bat
  1457 3BF1 85 B0		            sta tmp_angle1
  1458 				            
  1459 				; calculation done            
  1460 3BF3			calc_done
  1461 3BF3 A5 B0		            lda tmp_angle1
  1462 3BF5 85 AB		            sta ball_angle_end
  1463 3BF7 AA			            tax
  1464 3BF8 20 01 3C		            jsr angle_to_end_position
  1465
  1466 3BFB 20 F4 3A		            jsr set_robot_angle_end
  1467
  1468 3BFE 4C 40 3E		            jmp init_current_xy
  1469
  1470 				; x = angle 0..255
  1471 3C01			angle_to_end_position
  1472 3C01 BD 00 10		            lda outer_x_256,x
  1473 3C04 85 E8		            sta tmp_x2
  1474 3C06 BD 00 11		            lda outer_y_256,x
  1475 3C09 85 E9		            sta tmp_y2
  1476 3C0B 60			            rts
  1477
  1478 3C0C			wipe_ball
  1479 3C0C A5 A7		            lda ball_current_y
  1480 3C0E 4A			            lsr
  1481 3C0F 69 06		            adc #ball_top_margin
  1482 3C11 AA			            tax                 ; x = real y position on screen
  1483 3C12 A9 00		            lda #0
  1484 3C14 9D 80 0D		            sta msl_area,x
  1485 3C17 9D 81 0D		            sta msl_area+1,x
  1486 3C1A 9D 82 0D		            sta msl_area+2,x
  1487 3C1D 9D 83 0D		            sta msl_area+3,x
  1488 3C20 60			            rts
  1489
  1490 3C21			show_ball
  1491 3C21 A5 A7		            lda ball_current_y
  1492 3C23 4A			            lsr
  1493 3C24 69 06		            adc #ball_top_margin
  1494 3C26 AA			            tax                 ; x = real y position on screen
  1495
  1496 3C27 A9 02		            lda #%00000010
  1497 3C29 9D 80 0D		            sta msl_area,x
  1498 3C2C 9D 83 0D		            sta msl_area+3,x
  1499 3C2F A9 07		            lda #%00000111
  1500 3C31 9D 81 0D		            sta msl_area+1,x
  1501 3C34 9D 82 0D		            sta msl_area+2,x
  1502 				            
  1503 3C37 A5 A6		            lda ball_current_x
  1504 3C39 4A			            lsr
  1505 3C3A 69 45		            adc #ball_left_margin
  1506 3C3C 8D 05 D0		            sta HPOSM1
  1507 3C3F 69 02		            adc #2
  1508 3C41 8D 04 D0		            sta HPOSM0
  1509 				                        
  1510 3C44 60			            rts
  1511 				            
  1512 3C45			show_p1
  1513 				; y position
  1514 3C45 A5 98		            lda player1_y
  1515 3C47 18			            clc
  1516 3C48 69 01		            adc #upper_margin
  1517 3C4A AA			            tax
  1518
  1519 3C4B A0 00		            ldy #0
  1520 3C4D			show_shape1
  1521 3C4D B1 84		            lda (shape_ptr),y
  1522 3C4F 9D 00 0E		            sta p0_area,x 
  1523 3C52 C8			            iny
  1524 3C53 B1 84		            lda (shape_ptr),y
  1525 3C55 9D 00 0F		            sta p2_area,x
  1526 3C58 E8			            inx
  1527 3C59 C8			            iny
  1528 3C5A C0 20		            cpy #32
  1529 3C5C D0 EF		            bne show_shape1
  1530
  1531 				; x position
  1532 3C5E A5 94		            lda player1_x
  1533 3C60 18			            clc
  1534 3C61 69 20		            adc #left_margin
  1535 3C63 85 81		            sta shadow_HPOSP0
  1536 3C65 69 08		            adc #8
  1537 3C67 8D 02 D0		            sta HPOSP2
  1538 3C6A 60			            rts
  1539
  1540 3C6B			show_p2
  1541 				; y position
  1542 3C6B A5 99		            lda player2_y
  1543 3C6D 18			            clc
  1544 3C6E 69 01		            adc #upper_margin
  1545 3C70 AA			            tax
  1546
  1547 3C71 A0 00		            ldy #0
  1548 3C73			show_shape2
  1549 3C73 B1 84		            lda (shape_ptr),y
  1550 3C75 9D 80 0E		            sta p1_area,x
  1551 3C78 C8			            iny
  1552 3C79 B1 84		            lda (shape_ptr),y
  1553 3C7B 9D 80 0F		            sta p3_area,x
  1554 3C7E E8			            inx
  1555 3C7F C8			            iny
  1556 3C80 C0 20		            cpy #32
  1557 3C82 D0 EF		            bne show_shape2
  1558
  1559 				; x position
  1560 3C84 A5 95		            lda player2_x
  1561 3C86 18			            clc
  1562 3C87 69 20		            adc #left_margin
  1563 3C89 85 82		            sta shadow_HPOSP1
  1564 3C8B 69 08		            adc #8
  1565 3C8D 8D 03 D0		            sta HPOSP3
  1566 3C90 60			            rts
  1567
  1568 3C91			wipe_p1
  1569 3C91 A5 98		            lda player1_y
  1570 3C93 18			            clc
  1571 3C94 69 01		            adc #upper_margin
  1572 3C96 AA			            tax
  1573 				            
  1574 3C97 A0 10		            ldy #16
  1575 3C99 A9 00		            lda #0
  1576 3C9B			wipe_it1            
  1577 3C9B 9D 00 0E		            sta p0_area,x 
  1578 3C9E 9D 00 0F		            sta p2_area,x
  1579 3CA1 E8			            inx
  1580 3CA2 88			            dey
  1581 3CA3 D0 F6		            bne wipe_it1 
  1582 3CA5 60			            rts
  1583
  1584 3CA6			wipe_p2
  1585 3CA6 A5 99		            lda player2_y
  1586 3CA8 18			            clc
  1587 3CA9 69 01		            adc #upper_margin
  1588 3CAB AA			            tax
  1589 				            
  1590 3CAC A0 10		            ldy #16
  1591 3CAE A9 00		            lda #0
  1592 3CB0			wipe_it2            
  1593 3CB0 9D 80 0E		            sta p1_area,x
  1594 3CB3 9D 80 0F		            sta p3_area,x
  1595 3CB6 E8			            inx
  1596 3CB7 88			            dey
  1597 3CB8 D0 F6		            bne wipe_it2 
  1598 3CBA 60			            rts
  1599
  1600 3CBB			make_shape_index
  1601 3CBB A9 00		            lda #<pm_shapes
  1602 3CBD 85 84		            sta shape_ptr
  1603 3CBF A9 60		            lda #>pm_shapes
  1604 3CC1 85 85		            sta shape_ptr+1
  1605 				            
  1606 3CC3 A2 00		            ldx #0
  1607 3CC5			fill_pm_tab
  1608 3CC5 A5 84		            lda shape_ptr
  1609 3CC7 9D 00 14		            sta pm_shape_lo,x
  1610 3CCA A5 85		            lda shape_ptr+1
  1611 3CCC 9D 80 14		            sta pm_shape_hi,x
  1612 				            
  1613 3CCF A5 84		            lda shape_ptr
  1614 3CD1 18			            clc
  1615 3CD2 69 20		            adc #32
  1616 3CD4 85 84		            sta shape_ptr
  1617 3CD6 A5 85		            lda shape_ptr+1
  1618 3CD8 69 00		            adc #0
  1619 3CDA 85 85		            sta shape_ptr+1
  1620 				            
  1621 3CDC E8			            inx
  1622 3CDD 10 E6		            bpl fill_pm_tab
  1623 				            
  1624 3CDF 60			            rts
  1625 				            
  1626 				; there are 128 shapes, each 32 bytes
  1627
  1628 				; y = shape index
  1629 3CE0			shape_to_ptr
  1630 3CE0 B9 00 14		            lda pm_shape_lo,y
  1631 3CE3 85 84		            sta shape_ptr
  1632 3CE5 B9 80 14		            lda pm_shape_hi,y
  1633 3CE8 85 85		            sta shape_ptr+1
  1634
  1635 3CEA 60			            rts
  1636
  1637 				; turn 1024 tables into 256 bytes for ball edge lookup
  1638 3CEB			make_outer_256
  1639 3CEB A0 00		            ldy #0
  1640 3CED A2 00		            ldx #0
  1641 3CEF			conv_256
  1642 3CEF BD 00 44		            lda outer_x_tab,x
  1643 3CF2 99 00 10		            sta outer_x_256,y
  1644 3CF5 BD 00 45		            lda outer_x_tab+$100,x
  1645 3CF8 99 40 10		            sta outer_x_256+64,y
  1646 3CFB BD 00 46		            lda outer_x_tab+$200,x
  1647 3CFE 99 80 10		            sta outer_x_256+128,y
  1648 3D01 BD 00 47		            lda outer_x_tab+$300,x
  1649 3D04 99 C0 10		            sta outer_x_256+192,y
  1650 				            
  1651 3D07 BD 00 48		            lda outer_y_tab,x
  1652 3D0A 99 00 11		            sta outer_y_256,y
  1653 3D0D BD 00 49		            lda outer_y_tab+$100,x
  1654 3D10 99 40 11		            sta outer_y_256+64,y
  1655 3D13 BD 00 4A		            lda outer_y_tab+$200,x
  1656 3D16 99 80 11		            sta outer_y_256+128,y
  1657 3D19 BD 00 4B		            lda outer_y_tab+$300,x
  1658 3D1C 99 C0 11		            sta outer_y_256+192,y
  1659
  1660 3D1F E8			            inx
  1661 3D20 E8			            inx
  1662 3D21 E8			            inx
  1663 3D22 E8			            inx
  1664 3D23 C8			            iny
  1665 3D24 C0 40		            cpy #64
  1666 3D26 D0 C7		            bne conv_256            
  1667 3D28 60			            rts
  1668
  1669 3D29			show_score_p1
  1670 3D29 AD 2E 51		            lda score_p1
  1671 3D2C 4A			            lsr
  1672 3D2D 4A			            lsr
  1673 3D2E 4A			            lsr
  1674 3D2F 4A			            lsr
  1675 3D30 F0 02		            beq do_space1
  1676 3D32 09 10		            ora #16
  1677 3D34			do_space1
  1678 3D34 8D 0B 51		            sta score_chars_p1
  1679 3D37 AD 2E 51		            lda score_p1
  1680 3D3A 29 0F		            and #15
  1681 3D3C 09 10		            ora #16
  1682 3D3E 8D 0C 51		            sta score_chars_p1+1
  1683 3D41 60			            rts
  1684
  1685 3D42			show_score_p2
  1686 3D42 AD 2F 51		            lda score_p2
  1687 3D45 4A			            lsr
  1688 3D46 4A			            lsr
  1689 3D47 4A			            lsr
  1690 3D48 4A			            lsr
  1691 3D49 F0 02		            beq do_space2
  1692 3D4B 09 10		            ora #16
  1693 3D4D			do_space2
  1694 3D4D 8D 2B 51		            sta score_chars_p2
  1695 3D50 AD 2F 51		            lda score_p2
  1696 3D53 29 0F		            and #15
  1697 3D55 09 10		            ora #16
  1698 3D57 8D 2C 51		            sta score_chars_p2+1
  1699 3D5A 60			            rts
  1700 				                        
  1701 3D5B			reset_score
  1702 3D5B A9 00		            lda #0
  1703 3D5D 8D 2E 51		            sta score_p1
  1704 3D60 8D 2F 51		            sta score_p2
  1705 3D63 60			            rts            
  1706 				         
  1707 3D64			inc_score_p1
  1708 3D64 F8			            sed
  1709 3D65 AD 2E 51		            lda score_p1
  1710 3D68 18			            clc
  1711 3D69 69 01		            adc #1
  1712 3D6B 8D 2E 51		            sta score_p1    
  1713 3D6E D8			            cld
  1714 3D6F 60			            rts
  1715
  1716 3D70			inc_score_p2
  1717 3D70 F8			            sed
  1718 3D71 AD 2F 51		            lda score_p2
  1719 3D74 18			            clc
  1720 3D75 69 01		            adc #1
  1721 3D77 8D 2F 51		            sta score_p2
  1722 3D7A D8			            cld
  1723 3D7B 60			            rts
  1724
  1725 				; calculate the difference between angle1 and angle2
  1726
  1727 				; input:
  1728 				; tmp_angle1 (0..255)
  1729 				; tmp_angle2 (0..255)
  1730
  1731 				; output:
  1732 				; tmp_angle_diff, A: difference between angle1 and angle2
  1733 				; tmp_angle_direction: 0 = anti-clockwise, 1 = clockwise
  1734
  1735 3D7C			calc_angle_diff
  1736 3D7C A9 00		            lda #0
  1737 3D7E 85 B2		            sta add_to_angle
  1738 3D80 85 B4		            sta tmp_angle_direction
  1739
  1740 				; make sure we can compare angles, otherwise add $40 to angles
  1741 3D82 A5 B0		            lda tmp_angle1
  1742 3D84 C9 C0		            cmp #$c0
  1743 3D86 B0 06		            bcs too_large
  1744 3D88 A5 B1		            lda tmp_angle2
  1745 3D8A C9 C0		            cmp #$c0
  1746 3D8C 90 12		            bcc not_too_large
  1747 3D8E			too_large
  1748 3D8E A5 B0		            lda tmp_angle1
  1749 3D90 38			            sec
  1750 3D91 E9 40		            sbc #$40
  1751 3D93 85 B0		            sta tmp_angle1
  1752 				            
  1753 3D95 A5 B1		            lda tmp_angle2
  1754 3D97 38			            sec
  1755 3D98 E9 40		            sbc #$40
  1756 3D9A 85 B1		            sta tmp_angle2
  1757 				            
  1758 3D9C A9 40		            lda #$40
  1759 3D9E 85 B2		            sta add_to_angle
  1760
  1761 3DA0			not_too_large
  1762 3DA0 A5 B1		            lda tmp_angle2
  1763 3DA2 C5 B0		            cmp tmp_angle1
  1764 3DA4 90 0A		            bcc angle2_smaller_angle1
  1765 				; ball >= play
  1766 3DA6 38			            sec
  1767 3DA7 E5 B0		            sbc tmp_angle1
  1768 3DA9 85 B7		            sta tmp_angle_diff
  1769 				            
  1770 3DAB E6 B4		            inc tmp_angle_direction
  1771 3DAD 4C B7 3D		            jmp diff_calculated
  1772 				                        
  1773 3DB0			angle2_smaller_angle1
  1774 3DB0 A5 B0		            lda tmp_angle1
  1775 3DB2 38			            sec
  1776 3DB3 E5 B1		            sbc tmp_angle2
  1777 3DB5 85 B7		            sta tmp_angle_diff
  1778
  1779 3DB7			diff_calculated
  1780 3DB7 A5 B7		            lda tmp_angle_diff           
  1781 3DB9 60			            rts
  1782
  1783 				; X = angle
  1784 				; lookup magnitude of angle 0 to angle X
  1785 3DBA			angle_to_magnitude
  1786 3DBA BD 00 4C		            lda magnitudes_lo,x
  1787 3DBD 85 B8		            sta magnitude
  1788 3DBF BD 00 4D		            lda magnitudes_hi,x
  1789 3DC2 85 B9		            sta magnitude+1
  1790 3DC4 60			            rts
  1791
  1792 				; tmp_dx = abs(tmp_x2 - tmp_x1)
  1793 3DC5			calc_abs_tmp_dx
  1794 3DC5 A5 E8		            lda tmp_x2
  1795 3DC7 38			            sec
  1796 3DC8 E5 E6		            sbc tmp_x1
  1797 3DCA B0 05		            bcs x2_le
  1798 3DCC 49 FF		            eor #255
  1799 3DCE 18			            clc
  1800 3DCF 69 01		            adc #1
  1801 3DD1 85 F2		x2_le       sta tmp_dx
  1802
  1803 				; tmp_dy = abs(tmp_y2 - tmp_y1)
  1804 3DD3			calc_abs_tmp_dy
  1805 3DD3 A5 E9		            lda tmp_y2
  1806 3DD5 38			            sec
  1807 3DD6 E5 E7		            sbc tmp_y1
  1808 3DD8 B0 05		            bcs y2_le
  1809 3DDA 49 FF		            eor #255
  1810 3DDC 18			            clc
  1811 3DDD 69 01		            adc #1
  1812 3DDF 85 F3		y2_le       sta tmp_dy
  1813 3DE1 60			            rts
  1814 				            
  1815 3DE2			calc_dx_div_magnitude
  1816 3DE2 A9 00		            lda #0
  1817 3DE4 85 E2		            sta _dividend
  1818 3DE6 A5 F2		            lda tmp_dx
  1819 3DE8 85 E3		            sta _dividend+1
  1820
  1821 3DEA A5 B9		            lda magnitude+1
  1822 3DEC 85 E0		            sta _divisor
  1823 3DEE A9 00		            lda #0
  1824 3DF0 85 E1		            sta _divisor+1
  1825 				            
  1826 3DF2 20 1A 3E		            jsr _div16
  1827
  1828 				; todo multiply result with velocity            
  1829 3DF5 A5 E2		            lda _result
  1830 3DF7 85 EE		            sta step_x
  1831 3DF9 A5 E3		            lda _result+1
  1832 3DFB 85 EF		            sta step_x+1
  1833 				            
  1834 3DFD 60			            rts
  1835 				            
  1836 3DFE			calc_dy_div_magnitude
  1837 3DFE A9 00		            lda #0
  1838 3E00 85 E2		            sta _dividend
  1839 3E02 A5 F3		            lda tmp_dy
  1840 3E04 85 E3		            sta _dividend+1
  1841 				            
  1842 3E06 A5 B9		            lda magnitude+1
  1843 3E08 85 E0		            sta _divisor
  1844 3E0A A9 00		            lda #0
  1845 3E0C 85 E1		            sta _divisor+1
  1846
  1847 3E0E 20 1A 3E		            jsr _div16
  1848 				            
  1849 				; todo multiply result with velocity
  1850 3E11 A5 E2		            lda _result
  1851 3E13 85 F0		            sta step_y
  1852 3E15 A5 E3		            lda _result+1
  1853 3E17 85 F1		            sta step_y+1
  1854 				            
  1855 3E19 60			            rts
  1856
  1857 				; divide 16bit
  1858 				; https://codebase64.org/doku.php?id=base:16bit_division_16-bit_result
  1859
  1860 				; _result = _dividend / divisor
  1861
  1862 3E1A A9 00		_div16      lda #0          ;preset remainder to 0
  1863 3E1C 85 E4		            sta _remainder
  1864 3E1E 85 E5		            sta _remainder+1
  1865 3E20 A2 10		            ldx #16         ;repeat for each bit: ...
  1866
  1867 3E22 06 E2		_div_loop   asl _dividend    ;dividend lb & hb*2, msb -> Carry
  1868 3E24 26 E3		            rol _dividend+1  
  1869 3E26 26 E4		            rol _remainder   ;remainder lb & hb * 2 + msb from carry
  1870 3E28 26 E5		            rol _remainder+1
  1871 3E2A A5 E4		            lda _remainder
  1872 3E2C 38			            sec
  1873 3E2D E5 E0		            sbc _divisor ;substract divisor to see if it fits in
  1874 3E2F A8			            tay         ;lb result -> Y, for we may need it later
  1875 3E30 A5 E5		            lda _remainder+1
  1876 3E32 E5 E1		            sbc _divisor+1
  1877 3E34 90 06		            bcc _div_skip    ;if carry=0 then divisor didn't fit in yet
  1878
  1879 3E36 85 E5		            sta _remainder+1 ;else save substraction result as new remainder,
  1880 3E38 84 E4		            sty _remainder   
  1881 3E3A E6 E2		            inc _result  ;and INCrement result cause divisor fit in 1 times
  1882
  1883 3E3C CA			_div_skip   dex
  1884 3E3D D0 E3		            bne _div_loop 
  1885 3E3F 60			            rts
  1886
  1887 				; Calculations for step size
  1888
  1889 				; not optimised for speed or size
  1890 				; step should be set according to the angle
  1891
  1892 				; move in straight line (x1,y1) to (x2,y2)
  1893
  1894 				; 1. set start/end of line
  1895 				; set (tmp_x1, tmp_y1)
  1896 				; set (tmp_x2, tmp_y2)
  1897
  1898 				; 2. init. current_x, current_y
  1899 				; - set current x,y to start of line (tmp_x1, tmp_y2)
  1900 				; - calculates step sizes for x,y
  1901 				; - calculated directions for x,y
  1902 				;            jsr init_current_xy
  1903
  1904 				; 3. use current_x, current_y to plot or set a position
  1905 				;            lda current_x+1
  1906 				;            sta x_position
  1907 				;            lda current_y+1
  1908 				;            sta y_position
  1909 				;            jsr plot_pixel
  1910
  1911 				; 4. move current_x, current_y to next position on line
  1912 				; A=0 still moving
  1913 				;           move_current_xy
  1914
  1915 3E40			init_current_xy
  1916 3E40 A9 7F		            lda #$7f      ; was 128 for half pixel
  1917 3E42 85 EA		            sta current_x
  1918 3E44 85 EC		            sta current_y
  1919
  1920 3E46 A5 E6		            lda tmp_x1
  1921 3E48 85 EB		            sta current_x+1
  1922 				            
  1923 3E4A A5 E7		            lda tmp_y1
  1924 3E4C 85 ED		            sta current_y+1
  1925
  1926 				; dx = abs(tmp_x1 - tmp_x2)
  1927 3E4E 20 C5 3D		            jsr calc_abs_tmp_dx
  1928
  1929 				; dy = abs(tmp_y1 - tmp_y2)
  1930 3E51 20 D3 3D		            jsr calc_abs_tmp_dy
  1931
  1932 				; set directions
  1933 3E54 A5 E6		            lda tmp_x1
  1934 3E56 C5 E8		            cmp tmp_x2
  1935 3E58 90 04		            bcc x1_smaller_x2
  1936 				; x1 >= x2
  1937 3E5A A9 01		            lda #1
  1938 3E5C D0 02		            bne set_dir_x
  1939 3E5E			x1_smaller_x2
  1940 3E5E A9 00		            lda #0
  1941 3E60			set_dir_x
  1942 3E60 85 FA		            sta dir_x
  1943 				            
  1944 3E62 A5 E7		            lda tmp_y1
  1945 3E64 C5 E9		            cmp tmp_y2
  1946 3E66 90 04		            bcc y1_smaller_y2
  1947 				; y1 >= y2
  1948 3E68 A9 01		            lda #1
  1949 3E6A D0 02		            bne set_dir_y
  1950 3E6C			y1_smaller_y2
  1951 3E6C A9 00		            lda #0
  1952 3E6E			set_dir_y
  1953 3E6E 85 FB		            sta dir_y
  1954
  1955 				; Calculate diff between start angle and end angle
  1956
  1957 3E70 A5 AA		            lda ball_angle_start
  1958 3E72 85 B0		            sta tmp_angle1
  1959 3E74 A5 AB		            lda ball_angle_end
  1960 3E76 85 B1		            sta tmp_angle2
  1961 				            
  1962 3E78 20 7C 3D		            jsr calc_angle_diff
  1963
  1964 				; lookup magnitude of vector (tmp_x1, tmp_y1), (tmp_x2, tmp_y2)
  1965 3E7B A6 B7		            ldx tmp_angle_diff
  1966 3E7D 20 BA 3D		            jsr angle_to_magnitude
  1967 				            
  1968 3E80 20 E2 3D		            jsr calc_dx_div_magnitude
  1969 3E83 20 FE 3D		            jsr calc_dy_div_magnitude
  1970 				            
  1971 				; Calculate step size by ball speed
  1972 				            
  1973 				; step_x = step_x * speed
  1974 				            
  1975 3E86 A5 EE		            lda step_x
  1976 3E88 85 F6		            sta _multiplicand
  1977 3E8A A5 EF		            lda step_x+1
  1978 3E8C 85 F7		            sta _multiplicand+1
  1979 3E8E A5 AC		            lda ball_speed
  1980 3E90 85 F8		            sta _multiplier
  1981
  1982 3E92 20 F2 35		            jsr _multi8
  1983 				;result in .A (low byte, also in .X) and .Y (high byte)
  1984 3E95 85 EE		            sta step_x
  1985 3E97 84 EF		            sty step_x+1
  1986 3E99			skip_step_x_hi
  1987 				            
  1988 				; step_y = step_y * speed
  1989
  1990 3E99 A5 F0		            lda step_y
  1991 3E9B 85 F6		            sta _multiplicand
  1992 3E9D A5 F1		            lda step_y+1
  1993 3E9F 85 F7		            sta _multiplicand+1
  1994 3EA1 A5 AC		            lda ball_speed
  1995 3EA3 85 F8		            sta _multiplier
  1996
  1997 3EA5 20 F2 35		            jsr _multi8
  1998 				;result in .A (low byte, also in .X) and .Y (high byte)
  1999 3EA8 85 F0		            sta step_y
  2000 3EAA 84 F1		            sty step_y+1
  2001 3EAC			skip_step_y_hi
  2002
  2003 3EAC 60			            rts
  2004
  2005 				; Move ball position 
  2006 				; Add one step, until end reached
  2007 				; Input:
  2008 				; - step size (step_x, step_y)
  2009 				; - current ball position (current_x, current_y)
  2010 				; - end position (tmp_x2, tmp_y2)
  2011 				; Output:
  2012 				; A (0 = still moving, 1 = end reached)
  2013 3EAD			move_current_xy
  2014 3EAD A9 00		            lda #0
  2015 3EAF 85 FC		            sta line_end_x
  2016 3EB1 85 FD		            sta line_end_y
  2017
  2018 				; sets line end indicators here
  2019 3EB3 20 D0 3E		            jsr move_current_x
  2020 3EB6 20 02 3F		            jsr move_current_y
  2021
  2022 3EB9 A5 FC		            lda line_end_x
  2023 3EBB 25 FD		            and line_end_y
  2024 3EBD F0 10		            beq no_end_reached
  2025
  2026 3EBF			end_reached
  2027 				; set current to (x2,y2)
  2028 3EBF A5 E8		            lda tmp_x2
  2029 3EC1 85 EB		            sta current_x+1
  2030 3EC3 A5 E9		            lda tmp_y2
  2031 3EC5 85 ED		            sta current_y+1
  2032 				            
  2033 3EC7 A9 00		            lda #0
  2034 3EC9 85 EA		            sta current_x
  2035 3ECB 85 EC		            sta current_y
  2036 				            
  2037 3ECD A9 01		            lda #1 ; end reached
  2038 				            
  2039 3ECF			no_end_reached  ; A = 0
  2040 3ECF 60			            rts
  2041
  2042 3ED0			move_current_x
  2043 3ED0 A5 FA		            lda dir_x
  2044 3ED2 D0 14		            bne move_current_left
  2045
  2046 				; move right, add
  2047 3ED4 A5 EA		            lda current_x
  2048 3ED6 18			            clc
  2049 3ED7 65 EE		            adc step_x
  2050 3ED9 85 EA		            sta current_x
  2051 3EDB A5 EB		            lda current_x+1
  2052 3EDD 65 EF		            adc step_x+1
  2053 3EDF 85 EB		            sta current_x+1
  2054
  2055 3EE1 A5 EB		            lda current_x+1
  2056 3EE3 C5 E8		            cmp tmp_x2
  2057 3EE5 90 00		            bcc no_line_end
  2058 3EE7			exact_end_x
  2059 				;            lda #1
  2060 				;            sta line_end_x
  2061 3EE7			no_line_end
  2062 3EE7 60			            rts
  2063 				            
  2064 3EE8			move_current_left
  2065 3EE8 A5 EA		            lda current_x
  2066 3EEA 38			            sec
  2067 3EEB E5 EE		            sbc step_x
  2068 3EED 90 01		            bcc clear_skip
  2069 3EEF EA			            nop
  2070 3EF0			clear_skip
  2071 3EF0 85 EA		            sta current_x
  2072 3EF2 A5 EB		            lda current_x+1
  2073 3EF4 E5 EF		            sbc step_x+1
  2074 3EF6 85 EB		            sta current_x+1
  2075 3EF8 90 07		            bcc below_zero
  2076 				                        
  2077 3EFA A5 E8		            lda tmp_x2
  2078 3EFC C5 EB		            cmp current_x+1
  2079 3EFE 90 E7		            bcc no_line_end
  2080 				;            lda #1
  2081 				;            sta line_end_x
  2082 3F00 60			            rts
  2083 3F01			below_zero            
  2084 				;            lda #1
  2085 				;            sta line_end_x
  2086 				;            sta line_end_y
  2087 3F01 60			            rts
  2088 3F02			move_current_y
  2089 3F02 A5 FB		            lda dir_y
  2090 3F04 D0 14		            bne move_current_up
  2091
  2092 				; move down, add
  2093 3F06 A5 EC		            lda current_y
  2094 3F08 18			            clc
  2095 3F09 65 F0		            adc step_y
  2096 3F0B 85 EC		            sta current_y
  2097 3F0D A5 ED		            lda current_y+1
  2098 3F0F 65 F1		            adc step_y+1
  2099 3F11 85 ED		            sta current_y+1
  2100 				            
  2101 3F13 A5 ED		            lda current_y+1
  2102 3F15 C5 E9		            cmp tmp_y2
  2103 3F17 90 CE		            bcc no_line_end
  2104 3F19			exact_end_y
  2105 				;            lda #1
  2106 				;            sta line_end_y
  2107 3F19 60			            rts
  2108
  2109 3F1A			move_current_up
  2110 3F1A A5 EC		            lda current_y
  2111 3F1C 38			            sec
  2112 3F1D E5 F0		            sbc step_y
  2113 3F1F 85 EC		            sta current_y
  2114 3F21 A5 ED		            lda current_y+1
  2115 3F23 E5 F1		            sbc step_y+1
  2116 3F25 90 DA		            bcc below_zero
  2117 3F27 85 ED		            sta current_y+1
  2118 				            
  2119 3F29 A5 E9		            lda tmp_y2
  2120 3F2B C5 ED		            cmp current_y+1
  2121 3F2D 90 B8		            bcc no_line_end
  2122 				;            lda #1
  2123 				;            sta line_end_y
  2124 3F2F 60			            rts                            
  2125 				            
  2126 3F30			init_sprites
  2127 3F30 A2 00		            ldx #0
  2128 3F32 8A			            txa
  2129 3F33			set_p
  2130 3F33 9D 00 0E		            sta p0_area,x
  2131 3F36 9D 80 0E		            sta p1_area,x
  2132 3F39 9D 00 0F		            sta p2_area,x
  2133 3F3C 9D 80 0F		            sta p3_area,x
  2134 3F3F E8			            inx
  2135 3F40 10 F1		            bpl set_p
  2136
  2137 3F42 A9 31		            lda #%0110001  ; overlap OR colors, missile = 5th player, prio player 0..3
  2138 3F44 8D 6F 02		            sta GPRIOR
  2139
  2140 3F47 A9 0C		            lda #>pm_area
  2141 3F49 8D 07 D4		            sta PMBASE
  2142
  2143 3F4C A9 03		            lda #3          ; P/M both on
  2144 3F4E 8D 1D D0		            sta GRACTL
  2145
  2146 3F51 A9 90		            lda #$90
  2147 3F53 8D 02 D0		            sta HPOSP2
  2148 3F56 A9 A0		            lda #$A0
  2149 3F58 8D 03 D0		            sta HPOSP3  
  2150 3F5B 60			            rts
  2151
  2152 3F5C			init_colors
  2153 3F5C A9 5A		            lda #BASE_COLOR_P1+10
  2154 3F5E 8D C2 02		            sta PCOLR2
  2155 3F61 A9 BA		            lda #BASE_COLOR_P2+10
  2156 3F63 8D C3 02		            sta PCOLR3
  2157 				            
  2158 3F66 A9 00		            lda #0
  2159 3F68 8D C6 02		            sta COLOR2
  2160
  2161 3F6B A9 0E		            lda #HEADER_FG_COLOR
  2162 3F6D 8D C5 02		            sta COLOR1
  2163
  2164 3F70 A9 50		            lda #HEADER_P1_COLOR
  2165 3F72 8D C0 02		            sta PCOLR0
  2166 3F75 A9 B0		            lda #HEADER_P2_COLOR
  2167 3F77 8D C1 02		            sta PCOLR1
  2168
  2169 3F7A 60			            rts
  2170
  2171 3F7B			previous_consol
  2172 3F7B 00			            dta 0
  2173
  2174 3F7C			current_level_index
  2175 3F7C 00			            dta 0
  2176 = 0007			NR_OF_LEVELS = 7
  2177 = 0000			INIT_LEVEL_INDEX = 0
  2178 3F7D			level_speeds
  2179 3F7D 02 03 04 05 06 07 +             dta 2,3,4,5,6,7,8
  2180 				;level_speeds_lo
  2181 				;            dta 128
  2182 3F84			stick_slow_speed_tab
  2183 3F84 01 02 02 02 03 03 +             dta 1,2,2,2,3,3,3
  2184 3F8B			stick_fast_speed_tab
  2185 3F8B 02 02 03 03 04 04 +             dta 2,2,3,3,4,4,4
  2186
  2187 				; X = level (0..NR_OF_LEVELS)
  2188 3F92			set_level_ball_speed
  2189 3F92 BD 84 3F		            lda stick_slow_speed_tab,x
  2190 3F95 85 88		            sta stick_slow_speed
  2191 3F97 BD 8B 3F		            lda stick_fast_speed_tab,x
  2192 3F9A 85 89		            sta stick_fast_speed
  2193
  2194 3F9C BD 7D 3F		            lda level_speeds,x
  2195 3F9F 85 AC		            sta ball_speed
  2196 3FA1 8A			            txa
  2197 3FA2 18			            clc
  2198 3FA3 69 01		            adc #1
  2199 3FA5 09 10		            ora #16
  2200 3FA7 8D AB 52		            sta level_char
  2201 3FAA 60			            rts
  2202 				            
  2203 3FAB			increase_level
  2204 3FAB EE 7C 3F		            inc current_level_index
  2205 3FAE AD 7C 3F		            lda current_level_index
  2206 3FB1 C9 07		            cmp #NR_OF_LEVELS
  2207 3FB3 D0 05		            bne ok_level
  2208 3FB5 A9 00		            lda #INIT_LEVEL_INDEX
  2209 3FB7 8D 7C 3F		            sta current_level_index
  2210 3FBA			ok_level           
  2211 3FBA 60			            rts
  2212
  2213 3FBB			increase_player_mode
  2214 3FBB E6 8A		            inc player_mode
  2215 3FBD A5 8A		            lda player_mode
  2216 3FBF C9 03		            cmp #NR_OF_PLAYER_MODES
  2217 3FC1 D0 04		            bne ok_player_mode
  2218 3FC3 A9 00		            lda #INIT_PLAYER_MODE
  2219 3FC5 85 8A		            sta player_mode
  2220 3FC7			ok_player_mode
  2221 3FC7 85 8B		            sta player_mode_saved
  2222 3FC9 60			            rts
  2223
  2224 3FCA			show_player_mode
  2225 3FCA A6 8A		            ldx player_mode
  2226 3FCC BD 3F 53		            lda player_mode_lo,x
  2227 3FCF 8D F9 50		            sta menu_line2_ptr
  2228 3FD2 BD 42 53		            lda player_mode_hi,x
  2229 3FD5 8D FA 50		            sta menu_line2_ptr+1
  2230 3FD8 60			            rts
  2231
  2232 3FD9			            .align $100
  2233 4000			inner_x_tab
  2234 = 4100			inner_y_tab = *+$100
  2235 4000-41FF> 70 72 75 77 +             ins 'data\in210.dat'
  2236 				      
  2237 4200			            .align $400            
  2238 				; outer circle 1024 plot points on 360 degrees
  2239 4400			outer_x_tab
  2240 = 4800			outer_y_tab = *+1024
  2241 4400-4DFF> 70 70 71 72 +             ins 'data\out224.dat'
  2242 				           
  2243 4C00			            .align $400
  2244 				; table of magnitudes (length) between angle 0 and 0..255
  2245 				; fixed point 8.8 : hi.lo
  2246 4C00			magnitudes_lo
  2247 = 4D00			magnitudes_hi = *+256
  2248 4C00 00 BC 79 35 F1 AC +             ins 'data\magnitud.dat'
  2249
  2250 4E00			            .align $400
  2251 5000			display_list
  2252 5000-512F> C2		            dta $42+128         ; dli_header
  2253 5001 06 51		            dta a(score_line)
  2254
  2255 				; 102 x 40 = 4080 bytes            
  2256 5003 4F			            dta $4f
  2257 5004 00 70		            dta a(screen_mem1)
  2258 5006 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f
  2259 500D 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2260 5015 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2261 501D 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2262
  2263 5025 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2264 502D 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2265 5035 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2266 503D 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2267
  2268 5045 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2269 504D 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2270 5055			menu_dl_hook
  2271 5055 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2272 505D 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2273
  2274 5065 0F 0F 0F 0F 0F 0F	            dta $0f,$0f,$0f,$0f,$0f,$0f
  2275
  2276 				; 42 + 60 = 102, 4080 bytes
  2277 506B 4F			            dta $4f
  2278 506C 00 80		            dta a(screen_mem2)
  2279 506E 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f
  2280
  2281 5075 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2282 507D 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2283 5085 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2284 508D 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2285
  2286 5095 0F 0F		            dta $0f,$0f
  2287
  2288 				; 60 lines
  2289 5097			menu_dl_end
  2290 5097 4F			            dta $4f
  2291 5098 90 86		            dta a(screen_mem2+(42*SCREEN_WIDTH))
  2292 509A 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f
  2293 50A1 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2294 50A9 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2295 50B1 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2296
  2297 50B9 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2298 50C1 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2299 50C9 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2300 50D1 0F 0F 0F 0F		            dta $0f,$0f,$0f,$0f
  2301
  2302 				; 20 x 40 = 800
  2303 50D5 4F			            dta $4f
  2304 50D6 00 90		            dta a(screen_mem3)       
  2305 50D8 0F 0F 0F		            dta $0f,$0f,$0f
  2306 50DB 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2307 50E3 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2308 				            
  2309 50EB 41			            dta $41
  2310 50EC 00 50		            dta a(display_list)
  2311
  2312 50EE			menu_dl_part
  2313 50EE 80			            dta 128 ; dli_menu
  2314 50EF 20			            dta $20
  2315 50F0 42			            dta $42
  2316 50F1 00 52		            dta a(rotor_logo_text)
  2317 50F3 02			            dta 2
  2318 50F4 30			            dta $30
  2319 50F5 46			            dta $46
  2320 50F6			menu_line1_ptr
  2321 50F6 50 52		            dta a(controller_text)
  2322 50F8 46			            dta $46
  2323 50F9			menu_line2_ptr
  2324 50F9 64 52		            dta a(two_player_text)
  2325 50FB 46			            dta $46
  2326 50FC			menu_line3_ptr
  2327 50FC 9F 52		            dta a(level_text)
  2328 50FE 30			            dta $30
  2329 50FF 42			            dta $42
  2330 5100 B3 52		            dta a(start_text)
  2331 5102 10			            dta $10
  2332 5103 01			            dta $01 ; jump
  2333 5104 97 50		            dta a(menu_dl_end)
  2334
  2335 5106			score_line  
  2336 5106 00 2F 2E 25 00	            dta d' ONE '
  2337 510B			score_chars_p1
  2338 510B 0D 0D 00		            dta d'-- '
  2339
  2340 510E 00 00 00 00 00 00 +             dta d'          '
  2341 5118 00 00 00 00 00 00 +             dta d'          '
  2342
  2343 5122 00 00 00 00 00 34 +             dta d'     TWO '
  2344 512B			score_chars_p2
  2345 512B 0D 0D 00		            dta d'-- '
  2346
  2347 512E 00			score_p1    dta 0
  2348 512F 00			score_p2    dta 0
  2349
  2350 5130			            .align $100
  2351 5200			rotor_logo_text
  2352 5200-5344> 00 00 00 00 +             dta d'              '
  2353 520E 45 46 47 48 49 4A +             dta $45,$46,$47,$48,$49,$4a,$4b,$4c,$4d,$4e,$4f,$50
  2354 521A 40			            dta $40
  2355 521B 00 00 00 00 00 00 +             dta d'             '
  2356 5228 00 00 00 00 00 00 +             dta d'              '
  2357 5236 51 52 53 54 55 56 +             dta $51,$52,$53,$54,$55,$56,$57,$58,$59,$5a,$5b,$5c
  2358 5242 00 00 00 00 00 00 +             dta d'              '
  2359
  2360 5250			controller_text
  2361 5250 00 00 23 2F 2E 34 +             dta d'  CONTROL:'
  2362 525A			driver_screen
  2363 525A 00 00 00 00 00 00 +             dta d'          '
  2364
  2365 5264			two_player_text
  2366 5264 00 00 00 28 35 2D +             dta d'   HUMAN VS HUMAN   '
  2367
  2368 5278			one_player_text
  2369 5278 00 00 00 28 35 2D +             dta d'   HUMAN VS ROBOT  '
  2370
  2371 528B			demo_player_text
  2372 528B 00 00 00 00 00 00 +             dta d'        DEMO        '
  2373
  2374 529F			level_text
  2375 529F 00 00 00 00 00 00 +             dta d'      LEVEL '
  2376 52AB			level_char            
  2377 52AB 11 00 00 00 00 00 +             dta d'1       '
  2378
  2379 52B3			start_text
  2380 52B3 80 80 80 80 80 B3 +             dta d'     START or FIRE buttons to play!     '*
  2381 52DB			stick_text
  2382 52DB 33 34 29 23 2B 00 +             dta d'STICK   '
  2383 52E3			paddle_text
  2384 52E3 30 21 24 24 2C 25 +             dta d'PADDLE  '
  2385 52EB			mouse_text
  2386 52EB 2D 2F 35 33 25 00 +             dta d'MOUSE   '
  2387 52F3			computer_text
  2388 52F3 23 2F 2D 30 35 34 +             dta d'COMPUTER'
  2389
  2390 52FB			empty_text
  2391 52FB 00 00 00 00 00 00 +             dta d'                    '
  2392 530F			winner_one_text
  2393 530F 00 00 30 2C 21 39 +             dta d'  PLAYER ONE WINS!  '
  2394 5323			winner_two_text
  2395 5323 00 00 30 2C 21 39 +             dta d'  PLAYER TWO WINS!  '
  2396
  2397 5337			driver_text_lo
  2398 5337 DB			            dta <stick_text
  2399 5338 E3			            dta <paddle_text
  2400 5339 EB			            dta <mouse_text
  2401 533A F3			            dta <computer_text
  2402 				            
  2403 533B			driver_text_hi
  2404 533B 52			            dta >stick_text
  2405 533C 52			            dta >paddle_text
  2406 533D 52			            dta >mouse_text
  2407 533E 52			            dta >computer_text
  2408
  2409 533F			player_mode_lo
  2410 533F 64			            dta <two_player_text
  2411 5340 78			            dta <one_player_text
  2412 5341 8B			            dta <demo_player_text
  2413
  2414 5342			player_mode_hi
  2415 5342 52			            dta >two_player_text
  2416 5343 52			            dta >one_player_text
  2417 5344 52			            dta >demo_player_text
  2418
  2419 				; 4 KB
  2420 				; 128 x 32 bytes shapes
  2421 5345			            .align $1000
  2422 6000			pm_shapes
  2423 6000-7FEF> 01 00 01 00 +             ins 'data\pm_128_x_32.dat'
  2424
  2425 				; 9 KB for backdrop image
  2426 7000			            .align $1000
  2427 = 7000			screen_mem1 = * ; 4K
  2428 				;            org screen_mem1
  2429 7000 FF FF F1 07 D0 00 +             ins 'gfx\backdrop2.gr8',0,102*SCREEN_WIDTH
  2430
  2431 7FF0			            .align $1000
  2432 = 8000			screen_mem2 = * ; 4K
  2433 				;            org screen_mem2
  2434 8000-8FEF> A1 55 7F E0 +             ins 'gfx\backdrop2.gr8',102*SCREEN_WIDTH,102*SCREEN_WIDTH
  2435
  2436 8FF0			            .align $1000
  2437 = 9000			screen_mem3 = * ; 1K
  2438 				;            org screen_mem3
  2439 9000-931F> EE 2A AB 52 +             ins 'gfx\backdrop2.gr8',204*SCREEN_WIDTH,20*SCREEN_WIDTH
  2440
  2441 02E0-02E1> 54 35		            run main
