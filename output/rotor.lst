mads 1.9.9
Source: C:\Users\Freddy\Documents\Projects\wudsn\Freddy\2023\2023 ROTOR\rotor_abbuc\rotor.asm
     1 				; R O T O R (II)
     2
     3 				; F#READY, 2023-10-18
     4 				; Version 2.5.2
     5 				; For cartridge release
     6
     7 				; - added more gradual levels (level 1 - 7)
     8 				; - added single player support (against robot)
     9 				; - added demo mode
    10 				; - added support for Atari mouse
    11 				; - added autostart demo after about 2 minutes
    12
    13 				; Main idea:
    14 				; - two players ONE and TWO move in a circle
    15 				; - the ball gets color of player to indicate who should catch it
    16 				; - when the ball hits the circle, the other player gets a point
    17
    18 				            icl 'lib/labels.inc'
Source: C:\Users\Freddy\Documents\Projects\wudsn\Freddy\2023\2023 ROTOR\rotor_abbuc\lib\labels.inc
     1 				; labels for OS and hardware
     2
     3 = 0055			x_position  = $55
     4 = 0054			y_position  = $54
     5
     6 = 0058			SAVMSC      = $58       ; screen memory pointer
     7
     8 = F1D8			plot_pixel  = $f1d8
     9
    10 = 0200			VDSLST      = $200
    11
    12 = 02FB			ATACHR      = $2fb      ; drawing color
    13 = 02FB			draw_color  = ATACHR    ; alias
    14
    15 = 026F			GPRIOR      = $026f
    16
    17 = 0270			PADDL0      = $0270
    18 = 0271			PADDL1      = $0271
    19
    20 = 0278			STICK0      = $0278
    21 = 0279			STICK1      = $0279
    22
    23 = 0284			STRIG0      = $0284
    24 = 0285			STRIG1      = $0285
    25
    26 = 022F			SDMCTL      = $022f
    27 = 0230			SDLSTL      = $0230
    28 = 0231			SDLSTH      = $0231
    29
    30 = 02C0			PCOLR0      = $02c0
    31 = 02C1			PCOLR1      = $02c1
    32 = 02C2			PCOLR2      = $02c2
    33 = 02C3			PCOLR3      = $02c3
    34
    35 = 02C4			COLOR0      = $02c4
    36 = 02C5			COLOR1      = $02c5
    37 = 02C6			COLOR2      = $02c6
    38 = 02C7			COLOR3      = $02c7
    39
    40 = D000			HPOSP0      = $d000
    41 = D001			HPOSP1      = $d001
    42 = D002			HPOSP2      = $d002
    43 = D003			HPOSP3      = $d003
    44 = D004			HPOSM0      = $d004
    45 = D005			HPOSM1      = $d005
    46 = D006			HPOSM2      = $d006
    47 = D007			HPOSM3      = $d007
    48
    49 = D008			SIZEP0      = $d008
    50 = D009			SIZEP1      = $d009
    51 = D00A			SIZEP2      = $d00a
    52 = D00B			SIZEP3      = $d00b
    53 = D00C			SIZEM       = $d00c
    54
    55 				; collision
    56 = D000			M0PF        = $d000
    57 = D001			M1PF        = $d001
    58 = D002			M2PF        = $d002
    59 = D003			M3PF        = $d003
    60
    61 = D004			P0PF        = $d004
    62 = D005			P1PF        = $d005
    63 = D006			P2PF        = $d006
    64 = D007			P3PF        = $d007
    65
    66 = D008			M0PL        = $d008
    67 = D009			M1PL        = $d009
    68 = D00A			M2PL        = $d00a
    69 = D00B			M3PL        = $d00b
    70
    71 = D00C			P0PL        = $d00c
    72 = D00D			P1PL        = $d00d
    73 = D00E			P2PL        = $d00e
    74 = D00F			P3PL        = $d00f
    75
    76 = D012			COLPM0      = $d012
    77 = D013			COLPM1      = $d013
    78 = D014			COLPM2      = $d014
    79 = D015			COLPM3      = $d015
    80
    81 = D016			COLPF0      = $d016
    82 = D017			COLPF1      = $d017
    83 = D018			COLPF2      = $d018
    84 = D019			COLPF3      = $d019
    85 = D01A			COLBK       = $d01a
    86
    87 = D01D			GRACTL      = $d01d
    88 = D01E			HITCLR      = $d01e
    89 = D01F			CONSOL      = $d01f
    90
    91 = D200			AUDF1       = $d200
    92 = D201			AUDC1       = $d201
    93 = D202			AUDF2       = $d202
    94 = D203			AUDC2       = $d203
    95 = D204			AUDF3       = $d204
    96 = D205			AUDC3       = $d205
    97 = D206			AUDF4       = $d206
    98 = D207			AUDC4       = $d207
    99 = D208			AUDCTL      = $d208
   100
   101 = D209			KBCODE      = $d209
   102
   103 = D20A			RANDOM      = $d20a
   104
   105 = D20F			SKSTAT      = $d20f
   106
   107 = D300			PORTA       = $d300
   108
   109 = D407			PMBASE      = $d407
   110 = D40A			WSYNC       = $d40a
   111 = D40E			NMIEN       = $d40e
    19
    20 				; color scheme
    21 = 0050			BASE_COLOR_P1   = $50   ; purple
    22 = 00B0			BASE_COLOR_P2   = $b0   ; green
    23
    24 = 000E			HEADER_FG_COLOR = 14
    25 = 0050			HEADER_P1_COLOR = BASE_COLOR_P1
    26 = 00B0			HEADER_P2_COLOR = BASE_COLOR_P2
    27
    28 				; must be in decimal format, so $11 is 11
    29 = 0011			MAX_SCORE   = $11
    30
    31 = 0C00			pm_area     = $0c00
    32 = 0D80			msl_area    = pm_area+$180
    33 = 0E00			p0_area     = pm_area+$200
    34 = 0E80			p1_area     = pm_area+$280
    35 = 0F00			p2_area     = pm_area+$300
    36 = 0F80			p3_area     = pm_area+$380
    37
    38 				; outer tables 256 for 360 degrees
    39 = 1000			outer_x_256     = $1000
    40 = 1100			outer_y_256     = $1100
    41
    42 = 1200			screen_y_lo     = $1200
    43 = 1300			screen_y_hi     = $1300
    44
    45 = 1400			pm_shape_lo     = $1400 ; 128 bytes
    46 = 1480			pm_shape_hi     = $1480 ; 128 bytes
    47
    48 = 0140			WIDTH           = 320
    49 = 00C0			HEIGHT          = 192
    50
    51 = 0028			SCREEN_WIDTH    = 40
    52
    53 = 0030			outer_x_margin  = 48 ;47-32
    54 = 0040			inner_x_margin  = 64
    55
    56 = 00A0			circle_center_x = WIDTH/2
    57 = 0060			circle_center_y = HEIGHT/2
    58
    59 = 0006			ball_top_margin     = 6
    60 = 0045			ball_left_margin    = 64+5
    61
    62 				; pm upper margin
    63 = 0001			upper_margin    = 1
    64 = 0020			left_margin     = 32
    65
    66 = 0080			music_toggle    = $80
    67
    68 = 0081			shadow_HPOSP0   = $81
    69 = 0082			shadow_HPOSP1   = $82
    70
    71 = 0083			winner_color    = $83
    72
    73 = 0084			shape_ptr       = $84
    74 = 0086			tmp_screen      = $86
    75
    76 = 0088			stick_slow_speed = $88
    77 = 0089			stick_fast_speed = $89
    78
    79 = 008A			player_mode     = $8a
    80 = 0000			MODE_2_PLAYER   = 0
    81 = 0001			MODE_1_PLAYER   = 1
    82 = 0002			MODE_DEMO       = 2
    83 = 0003			NR_OF_PLAYER_MODES = 3
    84 = 0000			INIT_PLAYER_MODE = MODE_2_PLAYER
    85
    86 = 008B			player_mode_saved = $8b
    87
    88 = 008C			game_state      = $8c
    89 = 0000			STATE_IN_GAME   = 0
    90 = 0001			STATE_IN_MENU   = 1
    91 = 0002			STATE_IN_END    = 2
    92
    93 = 008D			volume_hit_bat  = $8d
    94 = 008E			volume_hit_edge = $8e
    95
    96 = 008F			end_screen_delay = $8f
    97
    98 				; player vars must be in sequence for zp,x indexing
    99
   100 = 0090			p1_shape        = $90
   101 = 0091			p2_shape        = $91
   102
   103 = 0094			player1_x       = $94
   104 = 0095			player2_x       = $95
   105
   106 = 0098			player1_y       = $98
   107 = 0099			player2_y       = $99
   108
   109 = 009C			p1_angle        = $9c
   110 = 009D			p2_angle        = $9d
   111
   112 = 00A0			mp_collision    = $a0
   113 = 00A1			in_collision    = $a1
   114 = 00A2			player_nr_hit   = $a2       ; which player hit the ball? 1=player1, 2=player2
   115 = 00A3			edge_delay      = $a3
   116 = 00A4			bat_collision_delay = $a4
   117
   118 				; ball vars
   119 = 00A6			ball_current_x      = $a6
   120 = 00A7			ball_current_y      = $a7
   121 = 00AA			ball_angle_start    = $aa
   122 = 00AB			ball_angle_end      = $ab
   123 = 00AC			ball_speed          = $ac
   124
   125 = 00AD			edge_collision      = $ad
   126 = 00AE			edge_hit_count      = $ae
   127
   128 = 00B0			tmp_angle1          = $b0
   129 = 00B1			tmp_angle2          = $b1
   130 = 00B2			add_to_angle        = $b2
   131 = 00B3			angle_diff_bat      = $b3
   132 = 00B4			tmp_angle_direction = $b4
   133 = 00B5			player_turn         = $b5       ; who's turn to hit ball? 1=player1, 2=player2
   134 = 00B6			game_restart        = $b6
   135 = 00B7			tmp_angle_diff      = $b7
   136 = 00B8			magnitude           = $b8       ; word
   137
   138 = 00BA			robot_angle_end     = $ba       ; 2 bytes
   139 = 00BA			robot1_angle_end    = robot_angle_end
   140 = 00BB			robot2_angle_end    = robot_angle_end+1
   141
   142 				; $c0 - $df free for music
   143
   144 = 00E0			_divisor    = $e0   ; word
   145 = 00E2			_dividend   = $e2   ; word
   146 = 00E4			_remainder  = $e4   ; word
   147 = 00E2			_result     = _dividend         ; save memory by reusing divident to store the result
   148
   149 = 00E6			tmp_x1      = $e6   ; byte
   150 = 00E7			tmp_y1      = $e7   ; byte
   151 = 00E8			tmp_x2      = $e8   ; byte
   152 = 00E9			tmp_y2      = $e9   ; byte
   153
   154 = 00EA			current_x   = $ea  ; word  8.8 fixed point
   155 = 00EC			current_y   = $ec  ; word  8.8 fixed point
   156
   157 = 00EE			step_x      = $ee  ; word  8.8 fixed point
   158 = 00F0			step_y      = $f0  ; word  8.8 fixed point
   159
   160 = 00F2			tmp_dx      = $f2  ; byte
   161 = 00F3			tmp_dy      = $f3  ; byte
   162
   163 = 00F6			_multiplicand   = $f6   ; word
   164 = 00F8			_multiplier     = $f8   ; byte
   165
   166 				; direction:
   167 				; 0 : x1<x2 or y1<y2 = add
   168 				; 1 ; x1>=y2 or y1>=y2 = subtract
   169
   170 = 00FA			dir_x       = $fa  ; byte
   171 = 00FB			dir_y       = $fb  ; byte
   172
   173 = 00FC			line_end_x  = $fc  ; byte
   174 = 00FD			line_end_y  = $fd  ; byte
   175
   176 				            icl 'intro.asm'
Source: C:\Users\Freddy\Documents\Projects\wudsn\Freddy\2023\2023 ROTOR\rotor_abbuc\intro.asm
     1 				; rotor intro 
     2
     3 				            org $0600
     4
     5 				first_screen_off
     6 FFFF> 0600-0618> A9 00	            lda #0
     7 0602 8D 2F 02		            sta 559
     8 0605 A5 14		            lda 20
     9 0607			wait_black
    10 0607 C5 14		            cmp 20
    11 0609 F0 FC		            beq wait_black
    12
    13 				; BASIC off
    14 060B AD 01 D3		            lda $d301
    15 060E 09 02		            ora #2
    16 0610 8D 01 D3		            sta $d301
    17
    18 0613 A9 01		            lda #1
    19 0615 8D 44 02		            sta 580
    20 0618 60			            rts
    21
    22 02E2-02E3> 00 06		            ini first_screen_off
    23
    24 0619			            org $9800
    25 9800			rotor_font
    26 9800-9D15> 00 00 00 00 +             ins 'font\rotor.fnt'
    27
    28 9C00			intro_main
    29 9C00 A9 48		            lda #<dl_intro
    30 9C02 8D 30 02		            sta $230
    31 9C05 A9 9C		            lda #>dl_intro
    32 9C07 8D 31 02		            sta $231
    33
    34 9C0A A9 98		            lda #>rotor_font
    35 9C0C 8D F4 02		            sta 756
    36
    37 9C0F A9 00		            lda #0
    38 9C11 8D C6 02		            sta 710
    39
    40 9C14 A9 22		            lda #34
    41 9C16 8D 2F 02		            sta 559
    42
    43 				; reset clock
    44 9C19 A9 00		            lda #0
    45 9C1B 85 14		            sta 20
    46 9C1D 85 13		            sta 19
    47 				            
    48 9C1F 60			            rts
    49
    50 9C20			footer_intro
    51 9C20 2B 6F 64 1A 26 03 +             dta d'Kod:F#READY  Music:IvoP  Gfx:IvoP,Fred_M'
    52
    53 9C48			dl_intro
    54 9C48 70 70 70		            dta $70,$70,$70
    55
    56 9C4B 4F			            dta $4f
    57 9C4C 10 A0		            dta a(intro_image)
    58 9C4E 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f
    59 9C55 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    60 9C5D 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    61 9C65 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    62
    63 9C6D 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    64 9C75 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    65 9C7D 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    66 9C85 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    67
    68 9C8D 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    69 9C95 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    70 9C9D 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    71 9CA5 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    72
    73 9CAD 0F 0F 0F 0F 0F 0F	            dta $0f,$0f,$0f,$0f,$0f,$0f
    74
    75 9CB3 4F			            dta $4f
    76 9CB4 00 B0		            dta a(intro_image+$ff0)
    77 9CB6 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f
    78 9CBD 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    79 9CC5 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    80 9CCD 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    81
    82 9CD5 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    83 9CDD 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    84 9CE5 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    85 9CED 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    86
    87 9CF5 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    88 9CFD 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f            
    89 9D05 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
    90 9D0D 0F 0F		            dta $0f,$0f
    91 				            
    92 9D0F 20			            dta $20
    93 9D10 42			            dta $42
    94 9D11 20 9C		            dta a(footer_intro)
    95
    96 9D13 41			            dta $41
    97 9D14 48 9C		            dta a(dl_intro)
    98 				            
    99 9D16			            org $a010
   100 A010			intro_image
   101 				            ;ins 'gfx\intro\intro_v6_gr8_inverted.gr8'
   102 A010-BE0F> 10 82 84 42 +             ins 'gfx\intro\intro_rotor2_v2.gr8'
   103
   104 02E2-02E3> 00 9C		            ini intro_main
   177
   178 				; real data is loaded at $2000 ($1700+$900)
   179 BE10			            org $1700
   180 1700			            icl 'music\rotor_music\rotor_music.asm'
Source: C:\Users\Freddy\Documents\Projects\wudsn\Freddy\2023\2023 ROTOR\rotor_abbuc\music\rotor_music\rotor_music.asm
     1 				;
     2 				; LZSS Compressed SAP player for 16 match bits
     3 				; --------------------------------------------
     4 				;
     5 				; (c) 2020 DMSC
     6 				; Code under MIT license, see LICENSE file.
     7 				;
     8 				; This player uses:
     9 				;  Match length: 8 bits  (1 to 256)
    10 				;  Match offset: 8 bits  (1 to 256)
    11 				;  Min length: 2
    12 				;  Total match bits: 16 bits
    13 				;
    14 				; Compress using:
    15 				;  lzss -b 16 -o 8 -m 1 input.rsap test.lz16
    16 				;
    17 				; Assemble this file with MADS assembler, the compressed song is expected in
    18 				; the `test.lz16` file at assembly time.
    19 				;
    20 				; The plater needs 256 bytes of buffer for each pokey register stored, for a
    21 				; full SAP file this is 2304 bytes.
    22 				;
    23
    24 = 0232			SSKCTL = $0232
    25 				;RANDOM = $d20a
    26 = D20F			SKCTL  = $d20f
    27
    28 = 00C0			zp_music    = $c0
    29 = 00C0			chn_copy    = zp_music    ; .ds     9
    30 = 00C9			chn_pos     = zp_music+9  ; .ds     9
    31 = 00D2			bptr        = zp_music+18 ; .ds     2
    32 = 00D4			cur_pos     = zp_music+20 ; .ds     1
    33 = 00D5			chn_bits    = zp_music+21 ; .ds     1
    34 = 00D6			bit_data    = zp_music+22 ; .byte   1
    35
    36 = 00D7			newsong     = zp_music+23 ; .ds     1       ; IVO
    37
    38 = 00D8			stereo_pokey    = zp_music+24 ;.ds     1
    39
    40 = D200			POKEY = $D200
    41
    42 				    ;org $9800
    43 1700			buffers
    44 = 1700			    .ds 256 * 9
    45
    46 2000			intro_data
    47 2000-3277> 01 01 A1 34 +         ins     'intro.lz16'
    48 22D8			intro_end
    49
    50 22D8			loop_data
    51 22D8 01 01 A1 34 00 10 +         ins     'loop.lz16'
    52 30D7			loop_end
    53
    54 30D7			.proc get_byte
    55 30D7 AD 34 12		    lda $1234
    56 30DA EE D8 30		    inc song_ptr
    57 30DD D0 03		    bne skip
    58 30DF EE D9 30		    inc song_ptr+1
    59 30E2			skip
    60 30E2 60			    rts
    61 				.endp
    62 = 30D8			song_ptr = get_byte + 1
    63
    64 30E3			start
    65
    66 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    67 				; Song Initialization - this runs in the first tick:
    68 				;
    69 30E3			.proc play_first_frame
    70
    71 30E3 20 D7 30		    jsr get_byte                    ; IVO START move init here
    72 30E6 8D 22 31		    sta play_frame.init_chn_bits
    73 30E9 A9 01		    lda #1                          ; IVO set to 1 at init(!)
    74 30EB 85 D6		    sta bit_data
    75 30ED A9 17		    lda #>buffers                   ; IVO reset cbuf+1 pointer
    76 30EF 8D 02 31		    sta cbuf+2                      ; IVO END
    77
    78 				    ; Init all channels:
    79 30F2 A2 08		    ldx #8
    80 30F4 A0 00		    ldy #0
    81 30F6 84 D7		    sty newsong                     ; IVO signal first frame is played
    82 30F8			clear
    83 				    ; Read just init value and store into buffer and POKEY
    84 30F8 20 D7 30		    jsr get_byte
    85 30FB 9D 6F 32		    sta SHADOW, x
    86 30FE 94 C0		    sty chn_copy, x
    87 3100			cbuf
    88 3100 8D FF 17		    sta buffers + 255
    89 3103 EE 02 31		    inc cbuf + 2
    90 3106 CA			    dex
    91 3107 10 EF		    bpl clear
    92
    93 				    ; Initialize buffer pointer:
    94 3109 84 D2		    sty bptr
    95 310B 84 D4		    sty cur_pos
    96 310D 60			    rts                     ; IVO turn into subroutine
    97 				.endp
    98
    99 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   100 				; Wait for next frame
   101 				;
   102 310E			.proc wait_frame
   103
   104 310E A5 14		    lda 20
   105 3110			delay
   106 3110 C5 14		    cmp 20
   107 3112 F0 FC		    beq delay
   108 3114 60			    rts                     ; IVO turn into subroutine
   109 				.endp
   110
   111 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   112 				; Play one frame of the song
   113 				;
   114 3115			.proc play_frame
   115 3115 A5 D7		    lda newsong
   116 3117 F0 02		    beq continue
   117 3119 D0 C8		    bne play_first_frame
   118
   119 311B			continue
   120 311B A4 D4		    ldy cur_pos                 ; IVO
   121
   122 311D A9 17		    lda #>buffers
   123 311F 85 D3		    sta bptr+1
   124
   125 = 3122			init_chn_bits=*+1
   126 3121 A9 00		    lda #0              ; IVO: 8 bits, but 9 streams. bug?
   127 3123 85 D5		    sta chn_bits
   128 3125 A2 08		    ldx #8
   129
   130 				    ; Loop through all "channels", one for each POKEY register
   131 3127			chn_loop:
   132 3127 46 D5		    lsr chn_bits
   133 3129 B0 29		    bcs skip_chn       ; C=1 : skip this channel
   134
   135 312B B5 C0		    lda chn_copy, x    ; Get status of this stream
   136 312D D0 16		    bne do_copy_byte   ; If > 0 we are copying bytes
   137
   138 				    ; We are decoding a new match/literal
   139 312F 46 D6		    lsr bit_data       ; Get next bit
   140 3131 D0 06		    bne got_bit
   141 3133 20 D7 30		    jsr get_byte       ; Not enough bits, refill!
   142 3136 6A			    ror                ; Extract a new bit and add a 1 at the high bit (from C set above)
   143 3137 85 D6		    sta bit_data       ;
   144 3139			got_bit:
   145 3139 20 D7 30		    jsr get_byte       ; Always read a byte, it could mean "match size/offset" or "literal byte"
   146 313C B0 0F		    bcs store          ; Bit = 1 is "literal", bit = 0 is "match"
   147
   148 313E 95 C9		    sta chn_pos, x     ; Store in "copy pos"
   149
   150 3140 20 D7 30		    jsr get_byte
   151 3143 95 C0		    sta chn_copy, x    ; Store in "copy length"
   152
   153 				                        ; And start copying first byte
   154 3145			do_copy_byte:
   155 3145 D6 C0		    dec chn_copy, x     ; Decrease match length, increase match position
   156 3147 F6 C9		    inc chn_pos, x
   157 3149 B4 C9		    ldy chn_pos, x
   158
   159 				    ; Now, read old data, jump to data store
   160 314B B1 D2		    lda (bptr), y
   161
   162 314D			store:
   163 314D A4 D4		    ldy cur_pos
   164 314F 9D 6F 32		    sta SHADOW, x        ; Store to output and buffer
   165 3152 91 D2		    sta (bptr), y
   166
   167 3154			skip_chn:
   168 				    ; Increment channel buffer pointer
   169 3154 E6 D3		    inc bptr+1
   170
   171 3156 CA			    dex
   172 3157 10 CE		    bpl chn_loop        ; Next channel
   173
   174 3159 E6 D4		    inc cur_pos
   175 315B 60			    rts                 ; IVO once per frame
   176 				.endp
   177
   178 				;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
   179 				; Check for ending of song and jump to the next frame
   180 				;
   181 315C			.proc check_end_song
   182 315C AD D9 30		    lda song_ptr + 1
   183 = 3160			song_end_high=*+1
   184 315F C9 00		    cmp #>0
   185 3161 D0 09		    bne not_equal           ; IVO turn into subroutine
   186 3163 AD D8 30		    lda song_ptr
   187 = 3167			song_end_low=*+1
   188 3166 C9 00		    cmp #<0
   189 3168 D0 02		    bne not_equal           ; IVO turn intro subroutine
   190
   191 316A 38			    sec                     ; IVO....
   192 316B 60			    rts
   193 316C			not_equal
   194 316C 18			    clc
   195 316D 60			    rts
   196 				.endp
   197
   198 				; IVO everything below
   199
   200 316E			.proc music_init
   201 316E 20 10 32		    jsr detect_2nd_pokey
   202 3171 20 49 32		    jsr clear_echo
   203
   204 3174 A9 8A 8D CF 31 A9 +     mwa #normal_volume adjust_volume.volume
   205 				;    mwa #half_volume adjust_volume.volume
   206 				;    mwa #quarter_volume adjust_volume.volume
   207
   208 317E A9 D8		    lda #<intro_end
   209 3180 8D 67 31		    sta check_end_song.song_end_low
   210 3183 A9 22		    lda #>intro_end
   211 3185 8D 60 31		    sta check_end_song.song_end_high
   212 3188 A9 00		    lda #<(intro_data)
   213 318A 8D D8 30		    sta song_ptr
   214 318D A9 20		    lda #>(intro_data)
   215 318F 8D D9 30		    sta song_ptr+1
   216 3192 A9 01		    lda #1
   217 3194 85 D7		    sta newsong
   218 3196 60			    rts
   219 				.endp
   220
   221 3197			.proc play_song
   222 3197			playloop
   223 3197 20 15 31		    jsr play_frame      ; generates tick two and beyond
   224 319A 20 BF 31		    jsr adjust_volume
   225
   226 319D 20 5C 31		    jsr check_end_song
   227 31A0 90 03		    bcc no_end_song
   228 31A2 20 A6 31		    jsr restart_music
   229 31A5			no_end_song
   230 31A5 60			    rts
   231 				.endp
   232
   233 31A6			.proc restart_music
   234 31A6 A9 D7		    lda #<loop_end
   235 31A8 8D 67 31		    sta check_end_song.song_end_low
   236 31AB A9 30		    lda #>loop_end
   237 31AD 8D 60 31		    sta check_end_song.song_end_high
   238 31B0 A9 D8		    lda #<(loop_data)
   239 31B2 8D D8 30		    sta song_ptr
   240 31B5 A9 22		    lda #>(loop_data)
   241 31B7 8D D9 30		    sta song_ptr+1
   242 31BA A9 01		    lda #1
   243 31BC 85 D7		    sta newsong
   244 31BE 60			    rts
   245 				.endp
   246
   247 31BF			.proc adjust_volume
   248 31BF A0 06		    ldy #6
   249 31C1			adjust
   250 31C1 B9 70 32		    lda SHADOW+1,y
   251 31C4 AA			    tax
   252 31C5 29 F0		    and #$f0
   253 31C7 99 70 32		    sta SHADOW+1,y
   254 31CA 8A			    txa
   255 31CB 29 0F		    and #$0f
   256 31CD AA			    tax
   257 = 31CF			volume=*+1
   258 31CE BD 34 12		    lda $1234,x
   259 31D1 19 70 32		    ora SHADOW+1,y
   260 31D4 99 70 32		    sta SHADOW+1,y
   261 31D7 88			    dey
   262 31D8 88			    dey
   263 31D9 10 E6		    bpl adjust
   264 				    
   265 31DB 60			    rts
   266 				.endp
   267
   268 31DC			.proc copy_shadow
   269 31DC A2 08		    ldx #8
   270 31DE			copy
   271 31DE BD 6F 32		    lda SHADOW,x
   272 31E1 9D 00 D2		    sta POKEY,x
   273 31E4 CA			    dex
   274 31E5 10 F7		    bpl copy
   275
   276 31E7 A5 D8		    lda stereo_pokey
   277 31E9 F0 0E		    beq end_copy
   278
   279 31EB A2 08		    ldx #8
   280 31ED			copy2
   281 31ED BD 81 32		    lda ECHO,x
   282 31F0 9D 10 D2		    sta POKEY+$10,x
   283 31F3 CA			    dex
   284 31F4 10 F7		    bpl copy2
   285
   286 31F6 20 54 32		    jsr shift_echo
   287
   288 31F9			end_copy
   289 31F9 60			    rts
   290 				.endp
   291
   292 31FA			.proc music_normal_volume
   293 31FA A9 8A 8D CF 31 A9 +     mwa #normal_volume adjust_volume.volume
   294 3204 60			    rts
   295 				.endp
   296
   297 3205			.proc music_low_volume
   298 3205 A9 AA 8D CF 31 A9 +     mwa #quarter_volume adjust_volume.volume
   299 320F 60			    rts
   300 				.endp
   301
   302 3210			.proc detect_2nd_pokey
   303 3210 20 0E 31		    jsr wait_frame
   304
   305 3213 A9 00 8D 32 02	    mva #0 SSKCTL
   306 3218 A9 00 8D 0F D2	    mva #0 SKCTL
   307 321D A9 00 8D 1F D2	    mva #0 SKCTL+$10        ; make sure a potential 2nd pokey is cleared
   308
   309 3222 20 0E 31		    jsr wait_frame
   310
   311 				    ; Restart SKCTL. This starts all the poly counters
   312
   313 3225 A9 03 8D 32 02	    mva #3 SSKCTL
   314 322A A9 03 8D 0F D2	    mva #3 SKCTL
   315
   316 322F 20 0E 31		    jsr wait_frame
   317
   318 				    ; Except when there's a seconds pokey!! Its counters are not restarted.
   319 				    ; Its RANDOM should not change.
   320
   321 3232 AD 1A D2		    lda RANDOM+$10
   322 3235 CD 1A D2		    cmp RANDOM+$10
   323 3238 F0 05		    beq detected_stereo         ; so equal means there's a 2nd pokey
   324
   325 323A			detected_mono
   326 323A A9 00 85 D8		    mva #0 stereo_pokey
   327 323E 60			    rts
   328
   329 323F			detected_stereo
   330 323F A9 01 85 D8		    mva #1 stereo_pokey
   331 3243 A9 03 8D 1F D2	    mva #3 SKCTL+$10            ; start second pokey here
   332 3248 60			    rts
   333 				.endp
   334
   335 3249			.proc clear_echo
   336 3249 A0 11		    ldy #(endecho-echobuffer)-1
   337 324B			clear_echo_loop
   338 324B A9 00 99 78 32	    mva #0 echobuffer,y
   339 3250 88 10 F8		    dey:bpl clear_echo_loop
   340 3253 60			    rts
   341 				.endp
   342
   343 3254			.proc shift_echo
   344 3254 A0 11		    ldy #(ECHO-echobuffer)-1+9
   345 3256			shift_loop
   346 3256 B9 6F 32 99 78 32	    mva SHADOW,y SHADOW+9,y
   347 325C 88 10 F7		    dey:bpl shift_loop
   348 325F 60			    rts
   349 				.endp
   350
   351 3260			.proc music_off
   352 3260 A9 00		    lda #0
   353 3262 8D 70 32		    sta shadow+1
   354 3265 8D 72 32		    sta shadow+3
   355 3268 8D 74 32		    sta shadow+5
   356 326B 8D 76 32		    sta shadow+7
   357 326E 60			    rts
   358 				.endp
   359
   360 326F			SHADOW              ; shadow pokey
   361 326F 00 00 00 00 00 00 + :9 .byte 0
   362
   363 				                    ; fake stereo effect:
   364 				                    ; 0*9 = small
   365 				                    ; 1*9 = medium
   366 				                    ; 2*9 = big
   367 				                    ; >3 too big imho
   368
   369 3278			echobuffer
   370 = 3278			    .ds 1*9        ; total of echobuffer+ECHO MUST NOT exceed 128 bytes
   371
   372 3281			ECHO
   373 = 3281			    .ds 9
   374 328A			endecho
   375
   376 328A			normal_volume
   377 328A-32BB> 00 01 02 03 +     dta 0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15
   378 329A			half_volume
   379 329A 00 01 01 02 02 03 +     dta 0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,7
   380 32AA			quarter_volume
   381 32AA 00 01 01 01 01 02 +     dta 0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,4
   181
   182 32BC			            icl 'lib/drivers.inc'       
Source: C:\Users\Freddy\Documents\Projects\wudsn\Freddy\2023\2023 ROTOR\rotor_abbuc\lib\drivers.inc
     1
     2 				; F#READY
     3
     4 = 32BC			driver_tmp      .ds 2
     5 = 32BE			driver_mode     .ds 1
     6
     7 = 00E5			paddle_vals = 229
     8 = 011F			paddle_add  = 287       ; 65536 / 229
     9
    10 32BF			            .align $100
    11 3300			paddle_to_256
    12 = 3300			            .ds $100
    13
    14 				; paddle initial value
    15 3400			prev_paddle_value
    16 = 3400			            .ds 2
    17
    18 				; previous mouse value (player 1,2)
    19 3402			prev_mouse_value
    20 = 3402			            .ds 2
    21
    22 3404			driver_init
    23 3404-4070> A9 03		            lda #3  ; unknown
    24 3406 8D BE 32		            sta driver_mode
    25
    26 3409 8D 02 34		            sta prev_mouse_value
    27 340C 8D 03 34		            sta prev_mouse_value+1
    28
    29 340F AD 70 02		            lda PADDL0
    30 3412 8D 00 34		            sta prev_paddle_value
    31 3415 AD 71 02		            lda PADDL1
    32 3418 8D 01 34		            sta prev_paddle_value+1
    33
    34 341B A9 00		            lda #0
    35 341D 85 9C		            sta p1_angle
    36 341F A9 80		            lda #128
    37 3421 85 9D		            sta p2_angle
    38
    39 				; init paddle table
    40
    41 3423 A9 00		            lda #0
    42 3425 8D BC 32		            sta driver_tmp
    43 3428 8D BD 32		            sta driver_tmp+1
    44 				            
    45 342B A2 00		            ldx #0
    46 342D			store_pv
    47 342D AD BD 32		            lda driver_tmp+1
    48 3430 9D 00 33		            sta paddle_to_256,x
    49 				            
    50 3433 AD BC 32		            lda driver_tmp
    51 3436 18			            clc
    52 3437 69 1F		            adc #<paddle_add
    53 3439 8D BC 32		            sta driver_tmp
    54 343C AD BD 32		            lda driver_tmp+1
    55 343F 69 01		            adc #>paddle_add
    56 3441 8D BD 32		            sta driver_tmp+1
    57 3444 E8			            inx
    58 3445 E0 E5		            cpx #paddle_vals
    59 3447 D0 E4		            bne store_pv
    60 3449 60			            rts
    61
    62 344A			reset_driver_mode
    63 344A A9 03		            lda #3  ; unknown
    64 344C 8D BE 32		            sta driver_mode     ; reset driver mode
    65 344F 60			            rts
    66
    67 				; stick detect by using left/right
    68 				; paddle by connecting/rotate
    69 				; mouse controller by movement
    70
    71 				; return A = driver mode
    72 				; 0 = stick detected
    73 				; 1 = paddle detected
    74 				; 2 = mouse detected
    75
    76 3450			driver_detect
    77 3450 A2 00		            ldx #0
    78 3452 20 88 34		            jsr detect_paddle
    79 3455 D0 07		            bne paddle_detected
    80 3457 A2 01		            ldx #1
    81 3459 20 88 34		            jsr detect_paddle
    82 345C F0 06		            beq no_paddle_detected
    83
    84 345E			paddle_detected
    85 345E A9 01		            lda #1
    86 3460 8D BE 32		            sta driver_mode
    87 3463 60			            rts
    88
    89 3464			no_paddle_detected
    90
    91 3464 AD BE 32		            lda driver_mode
    92 3467 C9 02		            cmp #2
    93 3469 F0 11		            beq mouse_detected
    94
    95 				; not connected: mouse or stick?
    96
    97 346B			detect_mouse_or_stick
    98 346B AD 78 02		            lda STICK0
    99 346E C9 0F		            cmp #15
   100 3470 D0 04		            bne mouse_or_stick
   101
   102 3472 AD BE 32		            lda driver_mode
   103 3475 60			            rts
   104
   105 3476			mouse_or_stick
   106 3476 AA			            tax
   107 3477 BD 9E 35		            lda stick_detect_table,x
   108 347A D0 06		            bne stick_detected
   109
   110 347C			mouse_detected
   111 347C A9 02		            lda #2
   112 347E 8D BE 32		            sta driver_mode
   113 3481 60			            rts
   114
   115 3482			stick_detected
   116 3482 A9 00		            lda #0
   117 3484 8D BE 32		            sta driver_mode
   118 3487 60			            rts
   119
   120 = 0008			PADDLE_JITTER = 8
   121
   122 3488			detect_paddle
   123 3488 BD 70 02		            lda PADDL0,x
   124 348B C9 DC		            cmp #228-PADDLE_JITTER
   125 348D B0 27		            bcs paddle_not_detected
   126 348F C9 08		            cmp #PADDLE_JITTER
   127 3491 90 23		            bcc paddle_not_detected
   128
   129 				; paddle in range 0+jitter .. 228-jitter
   130
   131 3493 A9 E4		            lda #228    ; prev_paddle_value,x
   132 3495 38			            sec
   133 3496 E9 08		            sbc #PADDLE_JITTER
   134 3498 C9 E4		            cmp #228    ;PADDL0,x
   135 349A B0 0B		            bcs paddle_is_detected
   136
   137 349C BD 00 34		            lda prev_paddle_value,x
   138 349F 18			            clc
   139 34A0 69 08		            adc #8
   140 34A2 DD 70 02		            cmp PADDL0,x
   141 34A5 B0 09		            bcs paddle_value_within_bounds
   142
   143 34A7			paddle_is_detected
   144 34A7 BD 70 02		            lda PADDL0,x
   145 34AA 9D 00 34		            sta prev_paddle_value,x
   146 34AD A9 01		            lda #1
   147 34AF 60			            rts
   148
   149 34B0			paddle_value_within_bounds
   150 34B0 BD 70 02		            lda PADDL0,x
   151 34B3 9D 00 34		            sta prev_paddle_value,x
   152
   153 34B6			paddle_not_detected
   154 34B6 A9 00		            lda #0
   155 34B8 60			            rts
   156
   157 				; move player 1/2
   158 				; right - clockwise, left = anti-clockwise
   159
   160 				; X = 0, player 1
   161 				; X = 1, player 2
   162
   163 				; A = driver mode:
   164 				; 0 : stick
   165 				; 1 : paddle
   166 				; 2 : mouse
   167 				; 3 : unknown
   168
   169 34B9			main_driver
   170 34B9 AC BE 32		            ldy driver_mode
   171 34BC B9 CB 34		            lda driver_lo,y
   172 34BF 8D C9 34		            sta driver_ptr
   173 34C2 B9 CF 34		            lda driver_hi,y
   174 34C5 8D CA 34		            sta driver_ptr+1
   175
   176 = 34C9			driver_ptr = *+1
   177 34C8 4C FF FF		            jmp $ffff  
   178
   179 34CB			driver_lo
   180 34CB D3			            dta <driver_stick
   181 34CC 41			            dta <driver_paddle
   182 34CD 77			            dta <driver_mouse
   183 34CE 9D			            dta <driver_unknown
   184
   185 34CF			driver_hi
   186 34CF 34			            dta >driver_stick
   187 34D0 35			            dta >driver_paddle
   188 34D1 35			            dta >driver_mouse
   189 34D2 35			            dta >driver_unknown
   190
   191 				; joystick driver
   192
   193 34D3			driver_stick
   194 34D3 BD 78 02		            lda STICK0,x
   195 34D6 C9 0F		            cmp #15
   196 34D8 F0 31		            beq move_done
   197 34DA C9 0B		            cmp #11
   198 34DC D0 16		            bne no_left
   199
   200 34DE B5 9C		            lda p1_angle,x
   201 34E0 38			            sec
   202 34E1 E5 88		            sbc stick_slow_speed
   203 34E3 95 9C		            sta p1_angle,x
   204
   205 34E5 BD 84 02		            lda STRIG0,x
   206 34E8 D0 07		            bne no_fast
   207
   208 34EA B5 9C		            lda p1_angle,x
   209 34EC 38			            sec
   210 34ED E5 89		            sbc stick_fast_speed
   211 34EF 95 9C		            sta p1_angle,x
   212 34F1			no_fast
   213 				            
   214 34F1 4C 0B 35		            jmp move_done
   215 34F4 C9 07		no_left     cmp #7
   216 34F6 D0 13		            bne move_done
   217
   218 34F8 B5 9C		            lda p1_angle,x
   219 34FA 18			            clc
   220 34FB 65 88		            adc stick_slow_speed
   221 34FD 95 9C		            sta p1_angle,x
   222
   223 34FF BD 84 02		            lda STRIG0,x
   224 3502 D0 07		            bne no_fast_right
   225
   226 3504 B5 9C		            lda p1_angle,x
   227 3506 18			            clc
   228 3507 65 89		            adc stick_fast_speed
   229 3509 95 9C		            sta p1_angle,x
   230 350B			no_fast_right
   231 350B			move_done
   232 350B 60			            rts
   233
   234 				; check if player1 button is pressed
   235 				; A=0 not pressed, 1=pressed
   236
   237 350C			is_player1_button_pressed
   238 350C AD BE 32		            lda driver_mode
   239 350F C9 01		            cmp #1
   240 3511 F0 07		            beq check_player1_paddle_fire
   241
   242 3513 AD 84 02		            lda STRIG0
   243 3516 F0 1C		            beq fire_pressed
   244 3518 D0 24		            bne fire_not_pressed
   245
   246 351A			check_player1_paddle_fire
   247 351A AD 78 02		            lda STICK0
   248 351D C9 0B		            cmp #11
   249 351F F0 13		            beq fire_pressed
   250 3521 D0 1B		            bne fire_not_pressed
   251
   252 				; X=port number to check (paddle uses only port 1)
   253 				; check fire button (paddle uses left/right stick as fire button)
   254 				; A=0 not pressed, 1=pressed
   255
   256 3523			is_both_buttons
   257 3523 AD BE 32		            lda driver_mode
   258 3526 C9 01		            cmp #1
   259 3528 F0 0D		            beq check_paddle_fire
   260
   261 352A AD 84 02		            lda STRIG0
   262 352D D0 0F		            bne fire_not_pressed
   263 352F AD 85 02		            lda STRIG1
   264 3532 D0 0A		            bne fire_not_pressed
   265
   266 3534			fire_pressed
   267 3534 A9 01		            lda #1
   268 3536 60			            rts
   269
   270 3537			check_paddle_fire
   271 3537 AD 78 02		            lda STICK0
   272 353A C9 03		            cmp #3
   273 353C F0 F6		            beq fire_pressed
   274
   275 353E			fire_not_pressed
   276 353E A9 00		            lda #0
   277 3540 60			            rts
   278
   279 				; paddle driver
   280 				            
   281 3541			driver_paddle            
   282 3541 BD 70 02		            lda PADDL0,x
   283 3544 9D 00 34		            sta prev_paddle_value,x
   284 3547 A8			            tay
   285 3548 B9 00 33		            lda paddle_to_256,y
   286 354B 5D BE 35		            eor paddle_offsets,x
   287 354E 95 9C		            sta p1_angle,x
   288 3550 60			            rts
   289
   290 				; keyboard driver (always player1)
   291 				; not used here, but might come in handy sometime
   292
   293 3551			driver_keyboard
   294 3551 A2 00		            ldx #0          ; player 1
   295
   296 3553 AD 0F D2		            lda SKSTAT
   297 3556 29 04		            and #4
   298 3558 D0 1C		            bne key_done
   299
   300 355A			still_pressed
   301 355A AD 09 D2		            lda KBCODE
   302 355D C9 16		            cmp #$16        ; $56 including SHIFT
   303 355F D0 0A		            bne no_z_key
   304
   305 3561 B5 9C		            lda p1_angle,x
   306 3563 18			            clc
   307 3564 65 88		            adc stick_slow_speed
   308 3566 95 9C		            sta p1_angle,x
   309
   310 3568 4C 76 35		            jmp key_done
   311
   312 356B C9 17		no_z_key    cmp #$17        ; $57 including SHIFT
   313 356D D0 07		            bne key_done
   314
   315 356F B5 9C		            lda p1_angle,x
   316 3571 38			            sec
   317 3572 E5 88		            sbc stick_slow_speed
   318 3574 95 9C		            sta p1_angle,x
   319 3576			key_done
   320 3576 60			            rts
   321
   322 				; mouse driver (Atari ST compatible)
   323
   324 3577			driver_mouse
   325 3577 60			            rts
   326 				;            lda STICK0,x
   327 				;            eor #15
   328 				;            jmp driver_mouse_main
   329
   330 3578			driver_mouse_fast_p1
   331 3578 AD 00 D3		            lda PORTA
   332 357B A2 00		            ldx #0
   333 357D 4C 89 35		            jmp driver_mouse_main
   334
   335 3580			driver_mouse_fast_p2
   336 3580 AD 00 D3		            lda PORTA
   337 3583 4A			            lsr
   338 3584 4A			            lsr
   339 3585 4A			            lsr
   340 3586 4A			            lsr
   341 3587 A2 01		            ldx #1
   342 				; have to call this many times per frame for each player
   343 3589			driver_mouse_main
   344 3589 29 03		            and #%00000011
   345 358B 48			            pha
   346 358C 1D 02 34		            ora prev_mouse_value,x
   347 358F A8			            tay
   348 3590 68			            pla
   349 3591 0A			            asl
   350 3592 0A			            asl
   351 3593 9D 02 34		            sta prev_mouse_value,x  ; store previous bits at 0000AA00 position for next time
   352
   353 3596 B9 AE 35		            lda mouse_transitions,y
   354 3599 75 9C		            adc p1_angle,x
   355 359B 95 9C		            sta p1_angle,x
   356
   357 359D			driver_unknown
   358 359D 60			            rts
   359
   360 359E			stick_detect_table
   361 359E 00			            dta 0       ; 0  -
   362 359F 00			            dta 0       ; 1  -
   363 35A0 00			            dta 0       ; 2  -
   364 35A1 00			            dta 0       ; 3  -
   365 35A2 00			            dta 0       ; 4  -
   366 35A3 01			            dta 1       ; 5  RIGHT/DOWN
   367 35A4 01			            dta 1       ; 6  RIGHT/UP
   368 35A5 01			            dta 1       ; 7  RIGHT
   369 35A6 00			            dta 0       ; 8  -
   370 35A7 01			            dta 1       ; 9  LEFT/DOWN
   371 35A8 01			            dta 1       ; 10 LEFT/UP
   372 35A9 01			            dta 1       ; 11 LEFT
   373 35AA 00			            dta 0       ; 12 -
   374 35AB 01			            dta 1       ; 13 DOWN
   375 35AC 01			            dta 1       ; 14 UP
   376 35AD 01			            dta 1       ; 15 (not connected = default stick)
   377
   378 				; nibble coded transitions for mouse
   379 				; 15,13,12,14 = anti-clockwise
   380 				; 15,14,12,13 = clockwise
   381 				; only lowest 2 bits change, so we need 16 values for all transitions
   382
   383 				; index is the combined value of nibble AABB
   384 				; where AA is previous bits and BB current bits
   385 35AE			mouse_transitions
   386 35AE 00			            dta 0   ; 00 -> 00 (12 -> 12)
   387 35AF 02			            dta 2   ; 00 -> 01 (12 -> 13)
   388 35B0 FE			            dta 254 ; 00 -> 10 (12 -> 14)
   389 35B1 00			            dta 0   ; 00 -> 11 (12 -> 15)
   390 35B2 FE			            dta 254 ; 01 -> 00 (13 -> 12)
   391 35B3 00			            dta 0   ; 01 -> 01 (13 -> 13)
   392 35B4 00			            dta 0   ; 01 -> 10 (13 -> 14)
   393 35B5 02			            dta 2   ; 01 -> 11 (13 -> 15)
   394 35B6 02			            dta 2   ; 10 -> 00 (14 -> 12)
   395 35B7 00			            dta 0   ; 10 -> 01 (14 -> 13)
   396 35B8 00			            dta 0   ; 10 -> 10 (14 -> 14)
   397 35B9 FE			            dta 254 ; 10 -> 11 (14 -> 15)
   398 35BA 00			            dta 0   ; 11 -> 00 (15 -> 12)
   399 35BB FE			            dta 254 ; 11 -> 01 (15 -> 13)
   400 35BC 02			            dta 2   ; 11 -> 10 (15 -> 14)
   401 35BD 00			            dta 0   ; 11 -> 11 (15 -> 15)
   402
   403 35BE			paddle_offsets
   404 35BE 00 00		            dta 0,0
   183
   184 35C0			reset_pressed
   185 35C0 20 00 9C		            jsr intro_main
   186
   187 35C3			main
   188 35C3 A9 FF		            lda #255
   189 35C5 8D FC 02		            sta 764
   190
   191 				; for fast loaders, wait 10 seconds or continue with spacebar
   192 35C8			wait_a_sec
   193 35C8 AD FC 02		            lda 764
   194 35CB C9 FF		            cmp #255
   195 35CD D0 06		            bne any_key_pressed
   196
   197 35CF A5 13		            lda 19
   198 35D1 C9 02		            cmp #2
   199 35D3 90 F3		            bcc wait_a_sec
   200
   201 35D5			any_key_pressed
   202 35D5 A9 FF		            lda #255
   203 35D7 8D FC 02		            sta 764
   204
   205 				; start the game!
   206 				 
   207 35DA A9 00		            lda #0
   208 35DC 8D 2F 02		            sta SDMCTL
   209 35DF 85 B6		            sta game_restart
   210 35E1 85 8F		            sta end_screen_delay
   211 35E3 85 83		            sta winner_color
   212
   213 35E5 A9 80		            lda #128
   214 35E7 85 8D		            sta volume_hit_bat
   215 35E9 85 8E		            sta volume_hit_edge
   216 35EB 85 80		            sta music_toggle        ; 128 = on, 0 = off
   217
   218 35ED A9 01		            lda #1
   219 35EF 8D 44 02		            sta 580 ; coldstart
   220
   221 				;            lda #1
   222 				;            sta 9   ; boot
   223
   224 				;            lda #<reset_pressed
   225 				;            sta $0a
   226 				;            lda #>reset_pressed
   227 				;            sta $0b
   228
   229 35F2 20 04 34		            jsr driver_init
   230
   231 35F5 20 53 3D		            jsr make_shape_index
   232
   233 35F8 20 83 3D		            jsr make_outer_256
   234
   235 35FB 20 53 37		            jsr make_screen_y_tab
   236
   237 35FE 20 9E 37		            jsr invert_backdrop
   238 3601 A9 60		            lda #$60
   239 3603 8D 9E 37		            sta invert_backdrop ; dirty hack to fix warm reset :P
   240
   241 3606 20 F3 3D		            jsr reset_score
   242 3609 20 C1 3D		            jsr show_score_p1
   243 360C 20 DA 3D		            jsr show_score_p2
   244
   245 360F 20 C8 3F		            jsr init_sprites
   246 3612 20 F4 3F		            jsr init_colors
   247
   248 				; init. game vars
   249 3615 A2 00		            ldx #INIT_LEVEL_INDEX
   250 3617 8E 14 40		            stx current_level_index
   251 361A 20 2A 40		            jsr set_level_ball_speed
   252
   253 361D A9 00		            lda #INIT_PLAYER_MODE
   254 361F 85 8A		            sta player_mode
   255 3621 85 8B		            sta player_mode_saved
   256 3623 20 62 40		            jsr show_player_mode
   257
   258 3626 A9 01		            lda #STATE_IN_MENU
   259 3628 85 8C		            sta game_state           ; start with menu
   260
   261 362A 20 6E 31		            jsr music_init
   262
   263 362D 20 E3 37		            jsr show_menu_options
   264
   265 3630 20 F5 38		            jsr reset_autostart_demo
   266
   267 3633 A9 00		            lda #<display_list
   268 3635 8D 30 02		            sta SDLSTL
   269 3638 A9 50		            lda #>display_list
   270 363A 8D 31 02		            sta SDLSTH
   271
   272 				; start vbi
   273
   274 363D A9 C0		            lda #$c0
   275 363F 8D 0E D4		            sta NMIEN
   276
   277 3642 A9 07		            lda #7          ; sets VVBLKI
   278 3644 A0 35		            ldy #<vbi
   279 3646 A2 38		            ldx #>vbi
   280 3648 20 5C E4		            jsr $e45c       ; SETVBV
   281
   282 364B			wait_mouse
   283 364B AD BE 32		            lda driver_mode
   284 364E C9 02		            cmp #2
   285 3650 D0 F9		            bne wait_mouse
   286
   287 3652 A5 8A		            lda player_mode
   288 3654 C9 01		            cmp #MODE_1_PLAYER
   289 3656 F0 03		            beq single_driver
   290 3658 20 80 35		            jsr driver_mouse_fast_p2
   291 365B			single_driver
   292 365B 20 78 35		            jsr driver_mouse_fast_p1
   293
   294 365E 4C 4B 36		            jmp wait_mouse
   295
   296 				;------------------------
   297 				; 8bit * 8bit = 16bit multiply
   298 				; By White Flame
   299 				; Multiplies _multiplicand by _multiplier and stores result in .A (low byte, also in .X) and .Y (high byte)
   300 				; uses extra zp var _multiplicand+1
   301
   302 				; .X and .Y get clobbered.  Change the tax/txa and tay/tya to stack or zp storage if this is an issue.
   303 				;  idea to store 16-bit accumulator in .X and .Y instead of zp from bogax
   304
   305 				; In this version, both inputs must be unsigned
   306 				; Remove the noted line to turn this into a 16bit(either) * 8bit(unsigned) = 16bit multiply.
   307
   308 3661			_multi8
   309 3661 A9 00		            lda #$00
   310 3663 A8			            tay
   311 				            ;sty _multiplicand+1          ; remove this line for 16*8=16bit multiply
   312 3664 F0 0D		            beq _enter_loop
   313 3666			_do_add
   314 3666 18			            clc
   315 3667 65 F6		            adc _multiplicand
   316 3669 AA			            tax
   317
   318 366A 98			            tya
   319 366B 65 F7		            adc _multiplicand+1
   320 366D A8			            tay
   321 366E 8A			            txa
   322 366F			_mul_loop
   323 366F 06 F6		            asl _multiplicand
   324 3671 26 F7		            rol _multiplicand+1
   325 3673			_enter_loop                     ; accumulating multiply entry point (enter with .A=lo, .Y=hi)
   326 3673 46 F8		            lsr _multiplier
   327 3675 B0 EF		            bcs _do_add
   328 3677 D0 F6		            bne _mul_loop
   329 3679 60			            rts
   330
   331 				; reset PM0/1 to playfield settings
   332 367A			dli_header
   333 367A 48			            pha
   334
   335 367B A9 08		            lda #8
   336 367D 8D 17 D0		            sta COLPF1
   337
   338 3680 A5 81		            lda shadow_HPOSP0
   339 3682 8D 00 D0		            sta HPOSP0
   340 3685 A5 82		            lda shadow_HPOSP1
   341 3687 8D 01 D0		            sta HPOSP1
   342
   343 368A A9 00		            lda #0
   344 368C 8D 08 D0		            sta SIZEP0
   345 368F 8D 09 D0		            sta SIZEP1
   346
   347 3692 A9 5A		            lda #BASE_COLOR_P1+10
   348 3694 8D 12 D0		            sta COLPM0
   349 3697 A9 BA		            lda #BASE_COLOR_P2+10
   350 3699 8D 13 D0		            sta COLPM1
   351
   352 369C A9 BA		            lda #<dli_menu
   353 369E 8D 00 02		            sta VDSLST
   354 36A1 A9 36		            lda #>dli_menu
   355 36A3 8D 01 02		            sta VDSLST+1
   356
   357 36A6 8A			            txa
   358 36A7 48			            pha
   359 36A8 98			            tya
   360 36A9 48			            pha
   361
   362 36AA 20 DC 31		            jsr copy_shadow
   363 36AD A5 80		            lda music_toggle
   364 36AF F0 03		            beq skip_music
   365 36B1 20 97 31		            jsr play_song
   366 36B4			skip_music
   367
   368 36B4 68			            pla
   369 36B5 A8			            tay
   370 36B6 68			            pla
   371 36B7 AA			            tax
   372
   373 36B8 68			            pla
   374 36B9 40			            rti
   375
   376 36BA			dli_menu
   377 36BA 48			            pha
   378 36BB 8A			            txa
   379 36BC 48			            pha
   380
   381 36BD A9 0E		            lda #$0e
   382 36BF 8D 0A D4		            sta WSYNC
   383 36C2 8D 1A D0		            sta COLBK
   384 36C5 A9 0A		            lda #$0a
   385 36C7 8D 0A D4		            sta WSYNC
   386 36CA 8D 1A D0		            sta COLBK
   387 36CD A9 00		            lda #0
   388 36CF 8D 0A D4		            sta WSYNC
   389 36D2 8D 1A D0		            sta COLBK
   390
   391 36D5 A2 00		            ldx #0
   392 36D7			color_it1
   393 36D7 BD 1B 37		            lda menu_colpf2,x
   394 36DA 8D 0A D4		            sta WSYNC
   395 36DD 8D 18 D0		            sta COLPF2
   396 36E0 E8			            inx
   397 36E1 E0 12		            cpx #18
   398 36E3 D0 F2		            bne color_it1
   399
   400 36E5 A2 00		            ldx #0
   401 36E7			color_it2
   402 36E7 BD 2D 37		            lda menu_colpf0,x
   403 36EA 05 83		            ora winner_color
   404 36EC 8D 0A D4		            sta WSYNC
   405 36EF 8D 16 D0		            sta COLPF0
   406 36F2 E8			            inx
   407 36F3 E0 26		            cpx #38
   408 36F5 D0 F0		            bne color_it2
   409
   410 36F7 A9 00		            lda #0
   411 36F9 8D 0A D4		            sta WSYNC
   412 36FC 8D 1A D0		            sta COLBK
   413 36FF A9 0A		            lda #$0a
   414 3701 8D 0A D4		            sta WSYNC
   415 3704 8D 1A D0		            sta COLBK
   416 3707 A9 0E		            lda #$0e
   417 3709 8D 0A D4		            sta WSYNC
   418 370C 8D 1A D0		            sta COLBK
   419 370F A9 00		            lda #0
   420 3711 8D 0A D4		            sta WSYNC
   421 3714 8D 1A D0		            sta COLBK
   422 				            
   423 3717 68			            pla
   424 3718 AA			            tax
   425 3719 68			            pla
   426 371A 40			            rti
   427
   428 371B			menu_colpf2
   429 371B 50			            dta BASE_COLOR_P1
   430 371C 50			            dta BASE_COLOR_P1
   431 371D 50			            dta BASE_COLOR_P1
   432 371E 50			            dta BASE_COLOR_P1
   433 371F 50			            dta BASE_COLOR_P1
   434 3720 50			            dta BASE_COLOR_P1
   435 3721 50			            dta BASE_COLOR_P1
   436 3722 50			            dta BASE_COLOR_P1
   437
   438 3723 B0			            dta BASE_COLOR_P2
   439 3724 B0			            dta BASE_COLOR_P2
   440 3725 B0			            dta BASE_COLOR_P2
   441 3726 B0			            dta BASE_COLOR_P2
   442 3727 B0			            dta BASE_COLOR_P2
   443 3728 B0			            dta BASE_COLOR_P2
   444 3729 B0			            dta BASE_COLOR_P2
   445 372A B0			            dta BASE_COLOR_P2
   446
   447 372B 00 00		            dta 0,0
   448
   449 372D			menu_colpf0
   450 				;            dta 0,0,$28,$28,$2a,$2a,$2c,$2c
   451 				;            dta $7c,$7c,$7a,$7a,$78,$78,0,0
   452 372D 00 00		            dta 0,0
   453 372F 00 0E 0E 0C 0A 08 +             dta 0,14,14,12,10,8,6,0
   454 3737 00 0E 0E 0C 0A 08 +             dta 0,14,14,12,10,8,6,0
   455 373F 00 0E 0E 0C 0A 08 +             dta 0,14,14,12,10,8,6,0
   456 3747 00 00 00 00		            dta 0,0,0,0
   457 374B 00 00 00 00 00 00 +             dta 0,0,0,0,0,0,0,0
   458
   459 				; make pointers from y-position to screen memory
   460 				; screen memory is 3 blocks
   461 				; screen_mem1 : 102 lines, 4080 bytes
   462 				; screen_mem2 : 102 lines, 4080 bytes
   463 				; screen_mem3 :  20 lines,  800 bytes
   464
   465 3753			make_screen_y_tab
   466 3753 A9 00		            lda #<screen_mem1
   467 3755 85 86		            sta tmp_screen
   468 3757 A9 70		            lda #>screen_mem1
   469 3759 85 87		            sta tmp_screen+1
   470
   471 375B A2 00		            ldx #0
   472 375D			fill_y_tab1
   473 375D 20 86 37		            jsr store_y_line
   474 3760 E8			            inx
   475 3761 E0 66		            cpx #102
   476 3763 D0 F8		            bne fill_y_tab1
   477
   478 				; x = 102
   479 3765 A9 00		            lda #<screen_mem2
   480 3767 85 86		            sta tmp_screen
   481 3769 A9 80		            lda #>screen_mem2
   482 376B 85 87		            sta tmp_screen+1
   483
   484 376D			fill_y_tab2
   485 376D 20 86 37		            jsr store_y_line
   486 3770 E8			            inx
   487 3771 E0 CC		            cpx #204
   488 3773 D0 F8		            bne fill_y_tab2
   489
   490 3775 A9 00		            lda #<screen_mem3
   491 3777 85 86		            sta tmp_screen
   492 3779 A9 90		            lda #>screen_mem3
   493 377B 85 87		            sta tmp_screen+1
   494
   495 				; x = 204
   496 377D			fill_y_tab3
   497 377D 20 86 37		            jsr store_y_line
   498 3780 E8			            inx
   499 3781 E0 E0		            cpx #224
   500 3783 D0 F8		            bne fill_y_tab3
   501 3785 60			            rts
   502
   503 3786			store_y_line
   504 3786 A5 86		            lda tmp_screen
   505 3788 9D 00 12		            sta screen_y_lo,x
   506 378B A5 87		            lda tmp_screen+1
   507 378D 9D 00 13		            sta screen_y_hi,x
   508 				            
   509 3790 A5 86		            lda tmp_screen
   510 3792 18			            clc
   511 3793 69 28		            adc #SCREEN_WIDTH
   512 3795 85 86		            sta tmp_screen
   513 3797 A5 87		            lda tmp_screen+1
   514 3799 69 00		            adc #0
   515 379B 85 87		            sta tmp_screen+1
   516 379D 60			            rts
   517
   518 				; @todo invert backdrop image
   519 				; now we have to do it here :P
   520 379E			invert_backdrop
   521 379E A9 00		            lda #<screen_mem1
   522 37A0 85 86		            sta tmp_screen
   523 37A2 A9 70		            lda #>screen_mem1
   524 37A4 85 87		            sta tmp_screen+1
   525 				            
   526 37A6 A2 10		            ldx #16     ; 16 pages = 4K
   527 37A8 20 C6 37		            jsr do_x_pages
   528 				           
   529 37AB A9 00		            lda #<screen_mem2
   530 37AD 85 86		            sta tmp_screen
   531 37AF A9 80		            lda #>screen_mem2
   532 37B1 85 87		            sta tmp_screen+1
   533 				            
   534 37B3 A2 10		            ldx #16     ; 16 pages = 4K
   535 37B5 20 C6 37		            jsr do_x_pages
   536
   537 37B8 A9 00		            lda #<screen_mem3
   538 37BA 85 86		            sta tmp_screen
   539 37BC A9 90		            lda #>screen_mem3
   540 37BE 85 87		            sta tmp_screen+1
   541 				            
   542 37C0 A2 04		            ldx #4     ; 4 pages = 1K
   543 37C2 20 C6 37		            jsr do_x_pages
   544 37C5 60			            rts
   545
   546 				; invert x pages, starting from tmp_screen
   547
   548 37C6			do_x_pages
   549 37C6 A0 00		            ldy #0
   550 37C8			do_page
   551 37C8 B1 86		            lda (tmp_screen),y
   552 37CA 49 FF		            eor #$ff
   553 37CC 91 86		            sta (tmp_screen),y
   554 37CE C8			            iny
   555 37CF D0 F7		            bne do_page 
   556
   557 37D1 E6 87		            inc tmp_screen+1
   558 37D3 CA			            dex
   559 37D4 D0 F2		            bne do_page
   560 37D6 60			            rts
   561
   562 37D7			turn_color_ball
   563 37D7 A6 B5		            ldx player_turn
   564 37D9 BD E0 37		            lda color_turn,x
   565 37DC 8D C7 02		            sta COLOR3
   566 37DF 60			            rts
   567 				            
   568 37E0 00 56 B6		color_turn  dta 0,BASE_COLOR_P1+6,BASE_COLOR_P2+6                           
   569
   570 37E3			show_menu_options
   571 37E3 A9 50		            lda #<controller_text
   572 37E5 8D F6 50		            sta menu_line1_ptr
   573 37E8 A9 52		            lda #>controller_text
   574 37EA 8D F7 50		            sta menu_line1_ptr+1
   575
   576 37ED 20 62 40		            jsr show_player_mode
   577
   578 37F0 A9 9F		            lda #<level_text
   579 37F2 8D FC 50		            sta menu_line3_ptr
   580 37F5 A9 52		            lda #>level_text
   581 37F7 8D FD 50		            sta menu_line3_ptr+1
   582
   583 37FA A9 00		            lda #0
   584 37FC 85 83		            sta winner_color
   585 37FE 60			            rts
   586
   587 37FF			show_end_screen
   588 37FF A9 FB		            lda #<empty_text
   589 3801 8D F6 50		            sta menu_line1_ptr
   590 3804 8D FC 50		            sta menu_line3_ptr
   591 3807 A9 52		            lda #>empty_text
   592 3809 8D F7 50		            sta menu_line1_ptr+1
   593 380C 8D FD 50		            sta menu_line3_ptr+1
   594
   595 380F AD 2E 51		            lda score_p1
   596 3812 CD 2F 51		            cmp score_p2
   597 3815 90 0F		            bcc player_2_wins
   598
   599 3817 A9 0F		            lda #<winner_one_text
   600 3819 8D F9 50		            sta menu_line2_ptr
   601 381C A9 53		            lda #>winner_one_text
   602 381E 8D FA 50		            sta menu_line2_ptr+1
   603
   604 3821 A9 50		            lda #BASE_COLOR_P1
   605 3823 85 83		            sta winner_color
   606 3825 60			            rts
   607
   608 3826			player_2_wins
   609 3826 A9 23		            lda #<winner_two_text
   610 3828 8D F9 50		            sta menu_line2_ptr
   611 382B A9 53		            lda #>winner_two_text
   612 382D 8D FA 50		            sta menu_line2_ptr+1
   613
   614 3830 A9 B0		            lda #BASE_COLOR_P2
   615 3832 85 83		            sta winner_color
   616
   617 3834 60			            rts
   618
   619 				; A, X, Y are already saved by the OS
   620 3835			vbi
   621 				;            lda #$28
   622 				;            sta $d01a
   623
   624 				; toggle music on/off with spacebar
   625 3835 AD FC 02		            lda 764
   626 3838 C9 3A		            cmp #$3a
   627 383A D0 06		            bne no_reset_detection
   628 383C 20 4A 34		            jsr reset_driver_mode
   629 383F 4C 51 38		            jmp clear_key
   630
   631 3842			no_reset_detection
   632 3842 C9 21		            cmp #$21
   633 3844 D0 10		            bne no_spacebar
   634 3846 A5 80		            lda music_toggle
   635 3848 49 80		            eor #128
   636 384A 85 80		            sta music_toggle
   637 384C D0 03		            bne music_turned_on
   638 384E 20 60 32		            jsr music_off
   639
   640 3851			clear_key
   641 3851			music_turned_on
   642 3851 A9 FF		            lda #255
   643 3853 8D FC 02		            sta 764
   644
   645 3856			no_spacebar
   646 3856 20 D2 3A		            jsr play_sound_bat
   647 3859 20 F0 3A		            jsr play_sound_edge
   648
   649 385C A9 7A		            lda #<dli_header
   650 385E 8D 00 02		            sta VDSLST
   651 3861 A9 36		            lda #>dli_header
   652 3863 8D 01 02		            sta VDSLST+1
   653
   654 3866 A9 2E		            lda #%00101110  ; enable P/M DMA
   655 3868 8D 2F 02		            sta SDMCTL
   656 386B A9 00		            lda #0
   657 386D 85 4D		            sta 77      ; attract off
   658 386F A9 98		            lda #>rotor_font
   659 3871 8D F4 02		            sta 756
   660
   661 3874 A9 30		            lda #$30
   662 3876 8D 00 D0		            sta HPOSP0
   663 3879 A9 B0		            lda #$b0
   664 387B 8D 01 D0		            sta HPOSP1
   665
   666 				; menu switching thingy
   667
   668 387E AD 1F D0		            lda CONSOL
   669 3881 C9 03		            cmp #3  ; option button
   670 3883 D0 17		            bne no_option_pressed
   671 3885 A5 8C		            lda game_state
   672 3887 C9 01		            cmp #STATE_IN_MENU
   673 3889 F0 35		            beq check_game_state
   674
   675 				; prevent menu option directly after leaving in-game state
   676 388B A9 03		            lda #3
   677 388D 8D 13 40		            sta previous_consol
   678
   679 3890			go_menu_mode
   680 3890 20 A4 3C		            jsr wipe_ball
   681
   682 3893 20 FA 31		            jsr music_normal_volume
   683
   684 3896 20 E3 38		            jsr switch_to_menu
   685
   686 3899 4C C0 38		            jmp check_game_state
   687
   688 389C			no_option_pressed
   689 389C C9 06		            cmp #6  ; start pressed
   690 389E D0 07		            bne check_autostart
   691 38A0 20 23 39		            jsr is_driver_unknown
   692 38A3 F0 02		            beq check_autostart
   693 38A5 D0 05		            bne reset_game
   694
   695 38A7			check_autostart
   696 				; check autostart state
   697
   698 38A7 AD F2 38		            lda autostart_demo
   699 38AA F0 14		            beq check_game_state
   700
   701 				; reset game
   702
   703 38AC			reset_game
   704 38AC 20 05 32		            jsr music_low_volume
   705
   706 38AF 20 A4 3C		            jsr wipe_ball
   707
   708 38B2 20 83 3B		            jsr reset_robot_angle_end
   709
   710 38B5 A9 01		            lda #1
   711 38B7 85 B6		            sta game_restart
   712
   713 38B9 20 F5 38		            jsr reset_autostart_demo
   714
   715 38BC A9 00		            lda #STATE_IN_GAME
   716 38BE 85 8C		            sta game_state
   717
   718 38C0			check_game_state
   719 38C0 A5 8C		            lda game_state
   720 38C2 D0 03		            bne no_main_game_state
   721 38C4 4C CE 39		            jmp main_game_vbi
   722
   723 38C7			no_main_game_state
   724 38C7 C9 02		            cmp #STATE_IN_END
   725 38C9 D0 5E		            bne menu_vbi
   726
   727 				; end screen vbi
   728 38CB A5 8F		            lda end_screen_delay
   729 38CD D0 0C		            bne stay_in_end_screen
   730
   731 38CF 20 A6 31		            jsr restart_music
   732 38D2 20 FA 31		            jsr music_normal_volume
   733
   734 38D5 20 E3 38		            jsr switch_to_menu
   735
   736 38D8 4C 29 39		            jmp menu_vbi
   737
   738 38DB			stay_in_end_screen
   739 38DB 20 B4 3A		            jsr play_sound_end_game
   740 38DE C6 8F		            dec end_screen_delay
   741 38E0 4C 7F 39		            jmp wait_depressed
   742
   743 38E3			switch_to_menu
   744 38E3 A5 8B		            lda player_mode_saved
   745 38E5 85 8A		            sta player_mode
   746
   747 38E7 20 E3 37		            jsr show_menu_options
   748
   749 38EA 20 4A 34		            jsr reset_driver_mode
   750
   751 38ED A9 01		            lda #STATE_IN_MENU
   752 38EF 85 8C		            sta game_state
   753 38F1 60			            rts
   754
   755 				; demo autostart
   756
   757 38F2 00			autostart_demo  dta 0
   758 38F3 00 00		autostart_timer dta 0,0
   759
   760 38F5			reset_autostart_demo
   761 38F5 A9 00		            lda #0
   762 38F7 8D F2 38		            sta autostart_demo      ; do not start again
   763 38FA 8D F3 38		            sta autostart_timer
   764 38FD A9 1E		            lda #30                 ; N * 5 seconds (roughly)
   765 38FF 8D F4 38		            sta autostart_timer+1
   766 3902 60			            rts
   767
   768 3903			handle_autostart_timer
   769 3903 AD F3 38		            lda autostart_timer
   770 3906 0D F4 38		            ora autostart_timer+1
   771 3909 F0 17		            beq idle_timer
   772 390B CE F3 38		            dec autostart_timer
   773 390E D0 12		            bne running_timer
   774 3910 CE F4 38		            dec autostart_timer+1
   775 3913 D0 0D		            bne running_timer
   776
   777 				; timer reached zero
   778 3915 A9 01		            lda #1
   779 3917 8D F2 38		            sta autostart_demo
   780 391A A5 8A		            lda player_mode
   781 391C 85 8B		            sta player_mode_saved
   782 391E A9 02		            lda #2
   783 3920 85 8A		            sta player_mode
   784
   785 3922			running_timer
   786 3922			idle_timer
   787 3922 60			            rts
   788
   789 3923			is_driver_unknown
   790 3923 AD BE 32		            lda driver_mode
   791 3926 C9 03		            cmp #3
   792 3928 60			            rts
   793
   794 				; within menu vbi
   795
   796 3929			menu_vbi
   797 3929 20 03 39		            jsr handle_autostart_timer
   798
   799 392C A5 8A		            lda player_mode
   800 392E F0 0D		            beq check_human_buttons
   801
   802 3930 20 0C 35		            jsr is_player1_button_pressed
   803 3933 F0 15		            beq check_consol_buttons
   804 3935 20 23 39		            jsr is_driver_unknown
   805 3938 F0 10		            beq check_consol_buttons
   806 393A 4C AC 38		            jmp reset_game
   807
   808 393D			check_human_buttons
   809 393D 20 23 35		            jsr is_both_buttons
   810 3940 F0 08		            beq check_consol_buttons
   811 3942 20 23 39		            jsr is_driver_unknown
   812 3945 F0 03		            beq check_consol_buttons
   813 3947 4C AC 38		            jmp reset_game
   814
   815 394A			check_consol_buttons
   816 394A AD 1F D0		            lda CONSOL
   817 394D C9 05		            cmp #5          ; select
   818 394F D0 18		            bne no_level_select
   819 				            
   820 3951 AD 13 40		            lda previous_consol
   821 3954 C9 05		            cmp #5
   822 3956 F0 27		            beq wait_depressed
   823
   824 3958 20 43 40		            jsr increase_level
   825 395B AE 14 40		            ldx current_level_index
   826 395E 20 2A 40		            jsr set_level_ball_speed
   827
   828 3961 A9 05		            lda #5
   829 3963 8D 13 40		            sta previous_consol
   830 3966 4C 7F 39		            jmp wait_depressed
   831
   832 3969			no_level_select
   833 3969 C9 03		            cmp #3          ; option
   834 396B D0 0F		            bne no_player_mode_select
   835
   836 396D AD 13 40		            lda previous_consol
   837 3970 C9 03		            cmp #3
   838 3972 F0 0B		            beq wait_depressed
   839
   840 3974 20 53 40		            jsr increase_player_mode
   841 3977 20 62 40		            jsr show_player_mode
   842
   843 397A A9 03		            lda #3
   844 397C			no_player_mode_select
   845 397C 8D 13 40		            sta previous_consol
   846
   847 397F			wait_depressed
   848 397F A9 01		            lda #1      ; dl jump
   849 3981 8D 55 50		            sta menu_dl_hook
   850 3984 A9 EE		            lda #<menu_dl_part
   851 3986 8D 56 50		            sta menu_dl_hook+1
   852 3989 A9 50		            lda #>menu_dl_part
   853 398B 8D 57 50		            sta menu_dl_hook+2
   854
   855 				; detect/show controller type (used for both players)
   856 398E 20 B5 39		            jsr detect_show_driver
   857
   858 3991 A5 8A		            lda player_mode
   859 3993 C9 00		            cmp #MODE_2_PLAYER
   860 3995 F0 15		            beq no_robot_in_menu
   861
   862 3997 C9 01		            cmp #MODE_1_PLAYER
   863 3999 F0 0B		            beq one_robot_in_menu
   864 				; demo mode, both robots in menu
   865 399B A5 9C		            lda p1_angle
   866 399D C5 BA		            cmp robot1_angle_end
   867 399F D0 05		            bne robot1_moves_to_goal
   868
   869 39A1 AD 0A D2		            lda RANDOM
   870 39A4 85 BA		            sta robot1_angle_end
   871
   872 39A6			robot1_moves_to_goal
   873 39A6			one_robot_in_menu
   874 39A6 A5 9C		            lda p1_angle
   875 39A8 49 80		            eor #128
   876 39AA 85 BB		            sta robot2_angle_end
   877
   878 39AC			no_robot_in_menu
   879 39AC 20 3F 3B		            jsr handle_player1
   880 39AF 20 62 3B		            jsr handle_player2
   881
   882 39B2 4C 89 3A		            jmp exit_vbi
   883
   884 				; X = port/driver to detect
   885 39B5			detect_show_driver
   886 39B5 20 50 34		            jsr driver_detect
   887 39B8 A8			            tay
   888 39B9 B9 37 53		            lda driver_text_lo,y
   889 39BC 85 86		            sta tmp_screen
   890 39BE B9 3B 53		            lda driver_text_hi,y
   891 39C1 85 87		            sta tmp_screen+1
   892
   893 39C3 A0 07		            ldy #7
   894 39C5			show_driv
   895 39C5 B1 86		            lda (tmp_screen),y
   896 39C7 99 5A 52		            sta driver_screen,y
   897 39CA 88			            dey
   898 39CB 10 F8		            bpl show_driv
   899 39CD 60			            rts
   900
   901 				; main game vbi
   902 39CE			main_game_vbi
   903 39CE A5 B6		            lda game_restart
   904 39D0 F0 33		            beq no_restart
   905
   906 				; restart game
   907
   908 39D2 20 CC 3A		            jsr silence_end
   909
   910 39D5 A9 00		            lda #0
   911 39D7 85 B6		            sta game_restart
   912 				            
   913 39D9 20 F3 3D		            jsr reset_score
   914 39DC 20 C1 3D		            jsr show_score_p1
   915 39DF 20 DA 3D		            jsr show_score_p2
   916
   917 39E2 A6 9C		            ldx p1_angle
   918 39E4 86 AA		            stx ball_angle_start
   919 39E6 20 FF 3B		            jsr ball_to_start_position
   920 39E9 20 0E 3C		            jsr prepare_ball_end_position
   921
   922 39EC A9 00		            lda #0
   923 39EE 85 A0		            sta mp_collision
   924 39F0 85 A1		            sta in_collision
   925 39F2 85 A3		            sta edge_delay
   926 39F4 85 AD		            sta edge_collision
   927 39F6 85 AE		            sta edge_hit_count
   928 39F8 8D 1E D0		            sta HITCLR
   929
   930 39FB A9 02		            lda #2
   931 39FD 85 B5		            sta player_turn
   932
   933 39FF 20 D7 37		            jsr turn_color_ball
   934 3A02 4C 89 3A		            jmp exit_vbi
   935
   936 3A05			no_restart
   937 				; remove menu hook
   938 3A05 A9 0F		            lda #$0f        ; dl gfx 8
   939 3A07 8D 55 50		            sta menu_dl_hook
   940 3A0A 8D 56 50		            sta menu_dl_hook+1
   941 3A0D 8D 57 50		            sta menu_dl_hook+2
   942
   943 3A10 AD 08 D0		            lda M0PL
   944 3A13 85 A0		            sta mp_collision
   945 3A15 AD 09 D0		            lda M1PL
   946 3A18 05 A0		            ora mp_collision
   947 3A1A 85 A0		            sta mp_collision
   948
   949 3A1C AD 00 D0		            lda M0PF
   950 3A1F 85 AD		            sta edge_collision
   951 3A21 AD 01 D0		            lda M1PF
   952 3A24 05 AD		            ora edge_collision
   953 3A26 85 AD		            sta edge_collision
   954 				;           beq no_edge_collision
   955
   956 				;            inc edge_hit_count
   957 				;            lda edge_hit_count
   958 				;            cmp #2
   959 				;            bcc edge_hit_counting
   960
   961 				;            sei
   962 				;lalala      jmp lalala
   963
   964 				;no_edge_collision
   965 				;            lda #0
   966 				;            sta edge_hit_count
   967
   968 3A28			edge_hit_counting
   969 3A28 20 3F 3B		            jsr handle_player1
   970 3A2B 20 62 3B		            jsr handle_player2
   971
   972 				; handle ball
   973
   974 3A2E 20 A4 3C		            jsr wipe_ball         
   975
   976 				; Check ball collision with bat
   977
   978 3A31 A5 A4		            lda bat_collision_delay
   979 3A33 F0 05		            beq check_allowed
   980 3A35 C6 A4		            dec bat_collision_delay
   981 3A37 4C 51 3A		            jmp move_one
   982
   983 3A3A			check_allowed
   984 3A3A A5 A0		            lda mp_collision
   985 3A3C F0 0F		            beq reset_in_collision
   986
   987 3A3E A5 A1		            lda in_collision
   988 3A40 D0 0F		            bne no_first_hit
   989
   990 3A42 E6 A1		            inc in_collision            
   991 3A44 20 3B 3C		            jsr bounce_bat_ball 
   992 				            
   993 3A47 20 AF 3A		            jsr start_sound_bat          
   994 				            
   995 3A4A 4C 51 3A		            jmp move_one
   996 				            
   997 3A4D			reset_in_collision
   998 3A4D A9 00		            lda #0
   999 3A4F 85 A1		            sta in_collision        
  1000
  1001 3A51			move_one
  1002 3A51			no_first_hit
  1003 3A51 20 45 3F		            jsr move_current_xy
  1004
  1005 3A54 A5 AD		            lda edge_collision
  1006 3A56 F0 1E		            beq still_moving
  1007
  1008 				; edge detected
  1009
  1010 3A58			edge_detected
  1011 3A58 20 EB 3A		            jsr start_sound_edge
  1012
  1013 3A5B A5 AB		            lda ball_angle_end
  1014 3A5D 85 AA		            sta ball_angle_start
  1015
  1016 3A5F 20 32 3C		            jsr ball_current_to_start_position
  1017 3A62 20 0E 3C		            jsr prepare_ball_end_position
  1018
  1019 3A65 20 0B 3B		            jsr update_score
  1020 3A68 D0 37		            bne game_ends
  1021
  1022 				; switch turns
  1023 3A6A A5 B5		            lda player_turn
  1024 3A6C 49 03		            eor #3              ; 1 => 2, 2 => 1
  1025 3A6E 85 B5		            sta player_turn
  1026 3A70 20 D7 37		            jsr turn_color_ball
  1027 3A73 20 8C 3B		            jsr set_robot_angle_end
  1028
  1029 3A76			still_moving
  1030 3A76 A5 EB		            lda current_x+1
  1031 3A78 85 A6		            sta ball_current_x
  1032 3A7A A5 ED		            lda current_y+1
  1033 3A7C 85 A7		            sta ball_current_y
  1034
  1035 3A7E 20 B9 3C		            jsr show_ball
  1036
  1037 3A81 A9 00		            lda #0
  1038 3A83 8D 18 D0		            sta $d018           
  1039
  1040 				; anything in A to clear collisions
  1041 3A86 8D 1E D0		            sta HITCLR
  1042
  1043 3A89			exit_vbi
  1044
  1045 				; always set header stuff
  1046 3A89 A9 03		            lda #3
  1047 3A8B 8D 08 D0		            sta SIZEP0
  1048 3A8E 8D 09 D0		            sta SIZEP1
  1049
  1050 				; background in PM0/1 for header
  1051 3A91 A9 FF		            lda #255
  1052 3A93 A2 07		            ldx #7
  1053 3A95			fill_pm_header
  1054 3A95 9D 00 0E		            sta p0_area,x
  1055 3A98 9D 80 0E		            sta p1_area,x
  1056 3A9B CA			            dex
  1057 3A9C 10 F7		            bpl fill_pm_header
  1058
  1059 				;            lda #$04
  1060 				;            sta $d01a
  1061 3A9E 4C 62 E4		            jmp $e462
  1062
  1063 3AA1			game_ends
  1064 3AA1 A9 FF		            lda #255
  1065 3AA3 85 8F		            sta end_screen_delay
  1066
  1067 3AA5 20 FF 37		            jsr show_end_screen
  1068
  1069 3AA8 A9 02		            lda #STATE_IN_END
  1070 3AAA 85 8C		            sta game_state
  1071
  1072 3AAC 4C 89 3A		            jmp exit_vbi
  1073
  1074 3AAF			start_sound_bat
  1075 3AAF A9 0A		            lda #10
  1076 3AB1 85 8D		            sta volume_hit_bat
  1077 3AB3 60			            rts
  1078
  1079 3AB4			play_sound_end_game
  1080 3AB4 20 60 32		            jsr music_off
  1081
  1082 3AB7 A5 8F		            lda end_screen_delay
  1083 3AB9 C9 C0		            cmp #192
  1084 3ABB 90 0F		            bcc silence_end
  1085 3ABD 4A			            lsr
  1086 3ABE 25 8F		            and end_screen_delay
  1087 3AC0 4A			            lsr
  1088 3AC1 09 20		            ora #$20
  1089 3AC3 8D 73 32		            sta SHADOW+4
  1090 				            ;lda end_screen_delay
  1091 3AC6 A9 AA		            lda #$aa
  1092 3AC8 8D 74 32		            sta SHADOW+5
  1093 3ACB 60			            rts
  1094 3ACC			silence_end
  1095 3ACC A9 00		            lda #0
  1096 3ACE 8D 74 32		            sta SHADOW+5
  1097 3AD1 60			            rts
  1098
  1099 3AD2			play_sound_bat
  1100 3AD2 A5 8D		            lda volume_hit_bat
  1101 3AD4 30 14		            bmi silenced_bat
  1102
  1103 3AD6 A5 B5		            lda player_turn
  1104 3AD8 0A			            asl
  1105 3AD9 0A			            asl
  1106 3ADA 69 30		            adc #$30
  1107 3ADC E5 B3		            sbc angle_diff_bat
  1108 3ADE 8D 73 32		            sta SHADOW+4    ; $d204
  1109 3AE1 A5 8D		            lda volume_hit_bat
  1110 3AE3 09 A0		            ora #$a0
  1111 3AE5 8D 74 32		            sta SHADOW+5    ; $d205
  1112 3AE8 C6 8D		            dec volume_hit_bat
  1113 3AEA			silenced_bat
  1114 3AEA 60			            rts
  1115
  1116 3AEB			start_sound_edge
  1117 3AEB A9 04		            lda #4
  1118 3AED 85 8E		            sta volume_hit_edge
  1119 3AEF 60			            rts
  1120
  1121 3AF0			play_sound_edge
  1122 3AF0 A5 8E		            lda volume_hit_edge
  1123 3AF2 30 16		            bmi silenced_edge
  1124 3AF4 D0 06		            bne no_silenced_edge
  1125 3AF6 8D 74 32		            sta SHADOW+5    ; $d205
  1126 3AF9 C6 8E		            dec volume_hit_edge
  1127 3AFB 60			            rts            
  1128
  1129 3AFC			no_silenced_edge
  1130 3AFC A9 08		            lda #$08
  1131 3AFE 8D 73 32		            sta SHADOW+4    ; $d204
  1132 3B01 A5 8E		            lda volume_hit_edge
  1133 3B03 09 26		            ora #$26
  1134 3B05 8D 74 32		            sta SHADOW+5    ; $d205
  1135 3B08 C6 8E		            dec volume_hit_edge
  1136 3B0A			silenced_edge
  1137 3B0A 60			            rts
  1138
  1139 				; Update score
  1140 				; Score > max score, then exit A = 1, otherwise A = 0
  1141
  1142 3B0B			update_score
  1143 3B0B A5 B5		            lda player_turn
  1144 3B0D C9 01		            cmp #1
  1145 3B0F D0 12		            bne was_player2_turn
  1146 				; was player 1 turn, so player 2 gets a point
  1147 3B11 20 08 3E		            jsr inc_score_p2
  1148 3B14 20 DA 3D		            jsr show_score_p2
  1149
  1150 3B17 AD 2F 51		            lda score_p2
  1151 3B1A C9 11		            cmp #MAX_SCORE
  1152 3B1C D0 17		            bne reset_edge_delay
  1153
  1154 3B1E A9 01		            lda #STATE_IN_MENU
  1155 3B20 85 8C		            sta game_state
  1156 3B22 60			            rts
  1157
  1158 3B23			was_player2_turn
  1159 3B23 20 FC 3D		            jsr inc_score_p1
  1160 3B26 20 C1 3D		            jsr show_score_p1
  1161
  1162 3B29 AD 2E 51		            lda score_p1
  1163 3B2C C9 11		            cmp #MAX_SCORE
  1164 3B2E D0 05		            bne reset_edge_delay
  1165
  1166 3B30 A9 01		            lda #STATE_IN_MENU
  1167 3B32 85 8C		            sta game_state
  1168 3B34 60			            rts
  1169
  1170 3B35			reset_edge_delay
  1171 3B35 A9 0A		            lda #10
  1172 3B37 85 A3		            sta edge_delay
  1173
  1174 3B39			no_edge
  1175
  1176 3B39 A9 00		            lda #0      ; no end game
  1177 				; anything in A to clear collisions
  1178 3B3B 8D 1E D0		            sta HITCLR
  1179 3B3E 60			            rts
  1180
  1181 				; player 1
  1182 				; - wipe shape at previous y-position
  1183 				; - move player using controller
  1184 				; - set sprite positions
  1185
  1186 3B3F			handle_player1
  1187 3B3F 20 29 3D		            jsr wipe_p1         ; wipe previous shape player 1
  1188
  1189 3B42 A5 8A		            lda player_mode
  1190 3B44 C9 02		            cmp #2
  1191 3B46 F0 0C		            beq do_p1_is_computer
  1192
  1193 3B48 A2 00		            ldx #0              ; player 1
  1194 3B4A 20 B9 34		            jsr main_driver
  1195 3B4D 20 E1 3B		            jsr move_player
  1196 				            
  1197 3B50 20 DD 3C		            jsr show_p1
  1198 3B53 60			            rts
  1199
  1200 				; p1 now controlled by computer
  1201 3B54			do_p1_is_computer
  1202 3B54 A5 8C		            lda game_state
  1203
  1204 3B56 A2 00		            ldx #0              ; player 1
  1205 3B58 20 B2 3B		            jsr robot_controller
  1206
  1207 3B5B 20 E1 3B		            jsr move_player
  1208
  1209 3B5E 20 DD 3C		            jsr show_p1
  1210 3B61 60			            rts
  1211
  1212 				; player 2
  1213 				; - wipe shape at previous y-position
  1214 				; - move player using controller
  1215 				; - set sprite positions
  1216
  1217 3B62			handle_player2
  1218 3B62 20 3E 3D		            jsr wipe_p2         ; wipe previous shape player 2
  1219
  1220 3B65 A5 8A		            lda player_mode
  1221 3B67 D0 0C		            bne do_p2_is_computer
  1222
  1223 3B69 A2 01		            ldx #1              ; player 2
  1224 3B6B 20 B9 34		            jsr main_driver
  1225
  1226 3B6E 20 E1 3B		            jsr move_player
  1227 3B71 20 03 3D		            jsr show_p2
  1228 3B74 60			            rts
  1229
  1230 				; p2 now controlled by computer
  1231 3B75			do_p2_is_computer
  1232 3B75 A5 8C		            lda game_state
  1233
  1234 3B77 A2 01		            ldx #1              ; player 2
  1235 3B79 20 B2 3B		            jsr robot_controller
  1236
  1237 3B7C 20 E1 3B		            jsr move_player
  1238 3B7F 20 03 3D		            jsr show_p2
  1239
  1240 3B82			not_in_game
  1241 3B82 60			            rts
  1242
  1243 3B83			reset_robot_angle_end
  1244 3B83 A9 00		            lda #0
  1245 3B85 85 BA		            sta robot1_angle_end
  1246 3B87 A9 80		            lda #128
  1247 3B89 85 BB		            sta robot2_angle_end
  1248 3B8B 60			            rts
  1249
  1250 3B8C			set_robot_angle_end
  1251 3B8C A6 B5		            ldx player_turn
  1252 3B8E CA			            dex
  1253 3B8F AD 0A D2		            lda RANDOM
  1254 3B92 29 07		            and #7
  1255 3B94 18			            clc
  1256 3B95 65 AB		            adc ball_angle_end
  1257 3B97 38			            sec
  1258 3B98 E9 03		            sbc #3
  1259 3B9A 95 BA		            sta robot_angle_end,x
  1260
  1261 				; other robot (not your turn)
  1262 3B9C A5 B5		            lda player_turn
  1263 3B9E 49 03		            eor #3
  1264 3BA0 AA			            tax
  1265 3BA1 CA			            dex
  1266
  1267 3BA2 AD 0A D2		            lda RANDOM
  1268 3BA5 29 0F		            and #15
  1269 3BA7 18			            clc
  1270 3BA8 65 AB		            adc ball_angle_end
  1271 3BAA 38			            sec
  1272 3BAB E9 07		            sbc #7
  1273 3BAD 49 80		            eor #128            ; other side
  1274 3BAF 95 BA		            sta robot_angle_end,x
  1275
  1276 3BB1 60			            rts
  1277
  1278 				; x = 0 (robot 1), x = 1 (robot 2)
  1279
  1280 3BB2			robot_controller
  1281 				;            lda ball_angle_end  ; current ball end
  1282 3BB2 B5 BA		            lda robot_angle_end,x
  1283 3BB4 85 B0		            sta tmp_angle1
  1284 3BB6 B5 9C		            lda p1_angle,x
  1285 3BB8 85 B1		            sta tmp_angle2
  1286
  1287 3BBA 20 14 3E		            jsr calc_angle_diff
  1288
  1289 3BBD A5 B7		            lda tmp_angle_diff
  1290 3BBF F0 1F		            beq comp_in_catch_position
  1291 3BC1 A5 B4		            lda tmp_angle_direction
  1292 3BC3 D0 0E		            bne move_comp_clockwise
  1293
  1294 3BC5 AD 0A D2		            lda RANDOM
  1295 3BC8 29 03		            and #3
  1296 3BCA D0 14		            bne comp_in_catch_position
  1297 3BCC B5 9C		            lda p1_angle,x
  1298 3BCE 65 88		            adc stick_slow_speed
  1299 3BD0 95 9C		            sta p1_angle,x
  1300 3BD2 60			            rts
  1301 3BD3			move_comp_clockwise
  1302
  1303 3BD3 AD 0A D2		            lda RANDOM
  1304 3BD6 29 03		            and #3
  1305 3BD8 D0 06		            bne comp_in_catch_position
  1306
  1307 3BDA B5 9C		            lda p1_angle,x
  1308 3BDC E5 88		            sbc stick_slow_speed
  1309 3BDE 95 9C		            sta p1_angle,x
  1310 3BE0			comp_in_catch_position
  1311 3BE0 60			            rts
  1312
  1313 				; move player 1/2
  1314 				; right - clockwise, left = anti-clockwise
  1315
  1316 				; X = 0, player 1
  1317 				; X = 1, player 2
  1318
  1319 				; Y = driver mode:
  1320 				; 0 : stick
  1321 				; 1 : paddle
  1322 				; 2 : mouse
  1323 				; 3 : computer
  1324 				            
  1325 3BE1			move_player
  1326 3BE1 B5 9C		            lda p1_angle,x
  1327 3BE3 29 7F		            and #127                    ; restrict angle to 0..179 degrees
  1328 3BE5 49 40		            eor #64                     ; perpendicular to the circle angle
  1329 3BE7 95 90		            sta p1_shape,x
  1330
  1331 3BE9 B4 9C		            ldy p1_angle,x
  1332 3BEB B9 00 41		            lda inner_x_tab,y
  1333 3BEE 4A			            lsr
  1334 3BEF 69 20		            adc #inner_x_margin/2
  1335 3BF1 95 94		            sta player1_x,x
  1336 3BF3 B9 00 42		            lda inner_y_tab,y
  1337 3BF6 4A			            lsr
  1338 3BF7 95 98		            sta player1_y,x
  1339
  1340 3BF9 B4 90		            ldy p1_shape,x
  1341 3BFB 20 78 3D		            jsr shape_to_ptr
  1342
  1343 3BFE 60			            rts
  1344
  1345 				; Set ball at start position
  1346 				; - start angle current player
  1347 				; - start position by inner table
  1348 				; - collision delay set?
  1349
  1350 				; Set ball current position to start position
  1351 				; input:
  1352 				; X = angle of start position
  1353 				; output:
  1354 				; ball position: (ball_current_x, ball_current_y)
  1355 				; (tmp_x1, tmp_y1) = (ball_current_x, ball_current_y)
  1356 3BFF			ball_to_start_position
  1357 3BFF BD 00 41		            lda inner_x_tab,x
  1358 3C02 85 A6		            sta ball_current_x
  1359 3C04 85 E6		            sta tmp_x1
  1360 3C06 BD 00 42		            lda inner_y_tab,x
  1361 3C09 85 A7		            sta ball_current_y
  1362 3C0B 85 E7		            sta tmp_y1
  1363 3C0D 60			            rts
  1364
  1365 				; Prepare ball end position
  1366 				; - end angle current player
  1367 				; - end position by outer table
  1368 				; - calculate step size x,y
  1369
  1370 				; Input:
  1371 				; - ball_angle_start
  1372 				; - ball speed
  1373 				; Output:
  1374 				; - ball_andle_end
  1375 				; - ball start position (tmp_x1, tmp_y1)
  1376 				; - ball end position (tmp_x2, tmp_y2)
  1377 				; - step size (step_x, step_y) for ball movement
  1378 3C0E			prepare_ball_end_position
  1379 3C0E A5 AA		            lda ball_angle_start
  1380 3C10 49 80		            eor #128        ; other side
  1381 3C12 85 AB		            sta ball_angle_end
  1382 3C14 AA			            tax
  1383 3C15 20 99 3C		            jsr angle_to_end_position
  1384 				                        
  1385 3C18 20 D8 3E		            jsr init_current_xy
  1386 				            
  1387 				; move current a little bit            
  1388 3C1B 20 45 3F		            jsr move_current_xy
  1389 				; ignore end indicator, since we only just started
  1390
  1391 3C1E A9 0A		            lda #10         ; ball can touch bat at start position, so use this delay
  1392 3C20 85 A4		            sta bat_collision_delay
  1393 3C22 60			            rts
  1394
  1395 				; x = angle 0..255
  1396 3C23			outer_angle_to_start_position
  1397 3C23 BD 00 10		            lda outer_x_256,x
  1398 3C26 85 A6		            sta ball_current_x
  1399 3C28 85 E6		            sta tmp_x1
  1400 3C2A BD 00 11		            lda outer_y_256,x
  1401 3C2D 85 A7		            sta ball_current_y
  1402 3C2F 85 E7		            sta tmp_y1
  1403 3C31 60			            rts
  1404
  1405 3C32			ball_current_to_start_position
  1406 3C32 A5 A6		            lda ball_current_x
  1407 3C34 85 E6		            sta tmp_x1
  1408 3C36 A5 A7		            lda ball_current_y
  1409 3C38 85 E7		            sta tmp_y1
  1410 3C3A 60			            rts
  1411
  1412 				; Ball collides with bat
  1413 				; - start ball angle = end ball angle
  1414 				; - calculate diff between bat and ball end angle
  1415 				; - calculate new end angle
  1416 				; - Set ball at start position
  1417 				; - Prepare ball end position
  1418
  1419 3C3B			bounce_bat_ball
  1420 				; set new start of ball
  1421 				; @todo check ball angles
  1422 				; set new ball start angle (= previous end angle)
  1423 3C3B A5 AB		            lda ball_angle_end
  1424 3C3D 85 AA		            sta ball_angle_start
  1425 				            
  1426 				; alternative?
  1427 				            ;ldx ball_angle_start
  1428 				            ;jsr ball_to_start_position          
  1429 3C3F 20 32 3C		            jsr ball_current_to_start_position
  1430
  1431 				; which player hit the ball?
  1432 				; collision bits:
  1433 				; xxxxx1x1 : 1 is player1 collision
  1434 				; xxxx1010 : 2 is player2 collision
  1435
  1436 3C42 A5 A0		            lda mp_collision
  1437 3C44 4A			            lsr
  1438 3C45 4A			            lsr
  1439 3C46 05 A0		            ora mp_collision
  1440 3C48 29 03		            and #%00000011      ; 01 = player1, 10 = player2, 11 = both
  1441
  1442 				; who's turn is it and who bounced the ball?
  1443
  1444 3C4A 25 B5		            and player_turn
  1445 3C4C F0 06		            beq no_switch_turn
  1446
  1447 3C4E A5 B5		            lda player_turn
  1448 3C50 49 03		            eor #3              ; 1 => 2, 2 => 1
  1449 3C52 85 B5		            sta player_turn
  1450
  1451 3C54			no_switch_turn
  1452 3C54 20 D7 37		            jsr turn_color_ball
  1453
  1454 3C57 A5 B5		            lda player_turn
  1455 3C59 49 03		            eor #3
  1456 3C5B AA			            tax
  1457 3C5C CA			            dex                 ; index 0,1 (player = 1,2)
  1458 3C5D B5 9C		            lda p1_angle,x
  1459
  1460 				; Calculate diff between bat angle position and new ball start position
  1461 3C5F 85 B0		            sta tmp_angle1
  1462
  1463 3C61 A5 AA		            lda ball_angle_start
  1464 3C63 85 B1		            sta tmp_angle2
  1465
  1466 3C65 20 14 3E		            jsr calc_angle_diff
  1467
  1468 3C68 0A			            asl
  1469 3C69 0A			            asl
  1470 3C6A 0A			            asl
  1471 3C6B 85 B3		            sta angle_diff_bat
  1472
  1473 3C6D A5 B0		            lda tmp_angle1
  1474 3C6F 18			            clc
  1475 3C70 65 B2		            adc add_to_angle
  1476 3C72 49 80		            eor #128            ; other side
  1477 3C74 85 B0		            sta tmp_angle1
  1478 				            
  1479 3C76 A5 B4		            lda tmp_angle_direction
  1480 3C78 D0 0A		            bne diff_clockwise
  1481 				; diff counter clockwise
  1482 3C7A A5 B0		            lda tmp_angle1
  1483 3C7C 18			            clc
  1484 3C7D 65 B3		            adc angle_diff_bat
  1485 3C7F 85 B0		            sta tmp_angle1
  1486 3C81 4C 8B 3C		            jmp calc_done            
  1487
  1488 3C84			diff_clockwise
  1489 3C84 A5 B0		            lda tmp_angle1
  1490 3C86 38			            sec
  1491 3C87 E5 B3		            sbc angle_diff_bat
  1492 3C89 85 B0		            sta tmp_angle1
  1493 				            
  1494 				; calculation done            
  1495 3C8B			calc_done
  1496 3C8B A5 B0		            lda tmp_angle1
  1497 3C8D 85 AB		            sta ball_angle_end
  1498 3C8F AA			            tax
  1499 3C90 20 99 3C		            jsr angle_to_end_position
  1500
  1501 3C93 20 8C 3B		            jsr set_robot_angle_end
  1502
  1503 3C96 4C D8 3E		            jmp init_current_xy
  1504
  1505 				; x = angle 0..255
  1506 3C99			angle_to_end_position
  1507 3C99 BD 00 10		            lda outer_x_256,x
  1508 3C9C 85 E8		            sta tmp_x2
  1509 3C9E BD 00 11		            lda outer_y_256,x
  1510 3CA1 85 E9		            sta tmp_y2
  1511 3CA3 60			            rts
  1512
  1513 3CA4			wipe_ball
  1514 3CA4 A5 A7		            lda ball_current_y
  1515 3CA6 4A			            lsr
  1516 3CA7 69 06		            adc #ball_top_margin
  1517 3CA9 AA			            tax                 ; x = real y position on screen
  1518 3CAA A9 00		            lda #0
  1519 3CAC 9D 80 0D		            sta msl_area,x
  1520 3CAF 9D 81 0D		            sta msl_area+1,x
  1521 3CB2 9D 82 0D		            sta msl_area+2,x
  1522 3CB5 9D 83 0D		            sta msl_area+3,x
  1523 3CB8 60			            rts
  1524
  1525 3CB9			show_ball
  1526 3CB9 A5 A7		            lda ball_current_y
  1527 3CBB 4A			            lsr
  1528 3CBC 69 06		            adc #ball_top_margin
  1529 3CBE AA			            tax                 ; x = real y position on screen
  1530
  1531 3CBF A9 02		            lda #%00000010
  1532 3CC1 9D 80 0D		            sta msl_area,x
  1533 3CC4 9D 83 0D		            sta msl_area+3,x
  1534 3CC7 A9 07		            lda #%00000111
  1535 3CC9 9D 81 0D		            sta msl_area+1,x
  1536 3CCC 9D 82 0D		            sta msl_area+2,x
  1537
  1538 3CCF A5 A6		            lda ball_current_x
  1539 3CD1 4A			            lsr
  1540 3CD2 69 45		            adc #ball_left_margin
  1541 3CD4 8D 05 D0		            sta HPOSM1
  1542 3CD7 69 02		            adc #2
  1543 3CD9 8D 04 D0		            sta HPOSM0
  1544
  1545 3CDC 60			            rts
  1546
  1547 3CDD			show_p1
  1548 				; y position
  1549 3CDD A5 98		            lda player1_y
  1550 3CDF 18			            clc
  1551 3CE0 69 01		            adc #upper_margin
  1552 3CE2 AA			            tax
  1553
  1554 3CE3 A0 00		            ldy #0
  1555 3CE5			show_shape1
  1556 3CE5 B1 84		            lda (shape_ptr),y
  1557 3CE7 9D 00 0E		            sta p0_area,x 
  1558 3CEA C8			            iny
  1559 3CEB B1 84		            lda (shape_ptr),y
  1560 3CED 9D 00 0F		            sta p2_area,x
  1561 3CF0 E8			            inx
  1562 3CF1 C8			            iny
  1563 3CF2 C0 20		            cpy #32
  1564 3CF4 D0 EF		            bne show_shape1
  1565
  1566 				; x position
  1567 3CF6 A5 94		            lda player1_x
  1568 3CF8 18			            clc
  1569 3CF9 69 20		            adc #left_margin
  1570 3CFB 85 81		            sta shadow_HPOSP0
  1571 3CFD 69 08		            adc #8
  1572 3CFF 8D 02 D0		            sta HPOSP2
  1573 3D02 60			            rts
  1574
  1575 3D03			show_p2
  1576 				; y position
  1577 3D03 A5 99		            lda player2_y
  1578 3D05 18			            clc
  1579 3D06 69 01		            adc #upper_margin
  1580 3D08 AA			            tax
  1581
  1582 3D09 A0 00		            ldy #0
  1583 3D0B			show_shape2
  1584 3D0B B1 84		            lda (shape_ptr),y
  1585 3D0D 9D 80 0E		            sta p1_area,x
  1586 3D10 C8			            iny
  1587 3D11 B1 84		            lda (shape_ptr),y
  1588 3D13 9D 80 0F		            sta p3_area,x
  1589 3D16 E8			            inx
  1590 3D17 C8			            iny
  1591 3D18 C0 20		            cpy #32
  1592 3D1A D0 EF		            bne show_shape2
  1593
  1594 				; x position
  1595 3D1C A5 95		            lda player2_x
  1596 3D1E 18			            clc
  1597 3D1F 69 20		            adc #left_margin
  1598 3D21 85 82		            sta shadow_HPOSP1
  1599 3D23 69 08		            adc #8
  1600 3D25 8D 03 D0		            sta HPOSP3
  1601 3D28 60			            rts
  1602
  1603 3D29			wipe_p1
  1604 3D29 A5 98		            lda player1_y
  1605 3D2B 18			            clc
  1606 3D2C 69 01		            adc #upper_margin
  1607 3D2E AA			            tax
  1608
  1609 3D2F A0 10		            ldy #16
  1610 3D31 A9 00		            lda #0
  1611 3D33			wipe_it1            
  1612 3D33 9D 00 0E		            sta p0_area,x 
  1613 3D36 9D 00 0F		            sta p2_area,x
  1614 3D39 E8			            inx
  1615 3D3A 88			            dey
  1616 3D3B D0 F6		            bne wipe_it1 
  1617 3D3D 60			            rts
  1618
  1619 3D3E			wipe_p2
  1620 3D3E A5 99		            lda player2_y
  1621 3D40 18			            clc
  1622 3D41 69 01		            adc #upper_margin
  1623 3D43 AA			            tax
  1624 				            
  1625 3D44 A0 10		            ldy #16
  1626 3D46 A9 00		            lda #0
  1627 3D48			wipe_it2            
  1628 3D48 9D 80 0E		            sta p1_area,x
  1629 3D4B 9D 80 0F		            sta p3_area,x
  1630 3D4E E8			            inx
  1631 3D4F 88			            dey
  1632 3D50 D0 F6		            bne wipe_it2 
  1633 3D52 60			            rts
  1634
  1635 3D53			make_shape_index
  1636 3D53 A9 00		            lda #<pm_shapes
  1637 3D55 85 84		            sta shape_ptr
  1638 3D57 A9 60		            lda #>pm_shapes
  1639 3D59 85 85		            sta shape_ptr+1
  1640 				            
  1641 3D5B A2 00		            ldx #0
  1642 3D5D			fill_pm_tab
  1643 3D5D A5 84		            lda shape_ptr
  1644 3D5F 9D 00 14		            sta pm_shape_lo,x
  1645 3D62 A5 85		            lda shape_ptr+1
  1646 3D64 9D 80 14		            sta pm_shape_hi,x
  1647 				            
  1648 3D67 A5 84		            lda shape_ptr
  1649 3D69 18			            clc
  1650 3D6A 69 20		            adc #32
  1651 3D6C 85 84		            sta shape_ptr
  1652 3D6E A5 85		            lda shape_ptr+1
  1653 3D70 69 00		            adc #0
  1654 3D72 85 85		            sta shape_ptr+1
  1655 				            
  1656 3D74 E8			            inx
  1657 3D75 10 E6		            bpl fill_pm_tab
  1658 				            
  1659 3D77 60			            rts
  1660 				            
  1661 				; there are 128 shapes, each 32 bytes
  1662
  1663 				; y = shape index
  1664 3D78			shape_to_ptr
  1665 3D78 B9 00 14		            lda pm_shape_lo,y
  1666 3D7B 85 84		            sta shape_ptr
  1667 3D7D B9 80 14		            lda pm_shape_hi,y
  1668 3D80 85 85		            sta shape_ptr+1
  1669
  1670 3D82 60			            rts
  1671
  1672 				; turn 1024 tables into 256 bytes for ball edge lookup
  1673 3D83			make_outer_256
  1674 3D83 A0 00		            ldy #0
  1675 3D85 A2 00		            ldx #0
  1676 3D87			conv_256
  1677 3D87 BD 00 44		            lda outer_x_tab,x
  1678 3D8A 99 00 10		            sta outer_x_256,y
  1679 3D8D BD 00 45		            lda outer_x_tab+$100,x
  1680 3D90 99 40 10		            sta outer_x_256+64,y
  1681 3D93 BD 00 46		            lda outer_x_tab+$200,x
  1682 3D96 99 80 10		            sta outer_x_256+128,y
  1683 3D99 BD 00 47		            lda outer_x_tab+$300,x
  1684 3D9C 99 C0 10		            sta outer_x_256+192,y
  1685 				            
  1686 3D9F BD 00 48		            lda outer_y_tab,x
  1687 3DA2 99 00 11		            sta outer_y_256,y
  1688 3DA5 BD 00 49		            lda outer_y_tab+$100,x
  1689 3DA8 99 40 11		            sta outer_y_256+64,y
  1690 3DAB BD 00 4A		            lda outer_y_tab+$200,x
  1691 3DAE 99 80 11		            sta outer_y_256+128,y
  1692 3DB1 BD 00 4B		            lda outer_y_tab+$300,x
  1693 3DB4 99 C0 11		            sta outer_y_256+192,y
  1694
  1695 3DB7 E8			            inx
  1696 3DB8 E8			            inx
  1697 3DB9 E8			            inx
  1698 3DBA E8			            inx
  1699 3DBB C8			            iny
  1700 3DBC C0 40		            cpy #64
  1701 3DBE D0 C7		            bne conv_256            
  1702 3DC0 60			            rts
  1703
  1704 3DC1			show_score_p1
  1705 3DC1 AD 2E 51		            lda score_p1
  1706 3DC4 4A			            lsr
  1707 3DC5 4A			            lsr
  1708 3DC6 4A			            lsr
  1709 3DC7 4A			            lsr
  1710 3DC8 F0 02		            beq do_space1
  1711 3DCA 09 10		            ora #16
  1712 3DCC			do_space1
  1713 3DCC 8D 0B 51		            sta score_chars_p1
  1714 3DCF AD 2E 51		            lda score_p1
  1715 3DD2 29 0F		            and #15
  1716 3DD4 09 10		            ora #16
  1717 3DD6 8D 0C 51		            sta score_chars_p1+1
  1718 3DD9 60			            rts
  1719
  1720 3DDA			show_score_p2
  1721 3DDA AD 2F 51		            lda score_p2
  1722 3DDD 4A			            lsr
  1723 3DDE 4A			            lsr
  1724 3DDF 4A			            lsr
  1725 3DE0 4A			            lsr
  1726 3DE1 F0 02		            beq do_space2
  1727 3DE3 09 10		            ora #16
  1728 3DE5			do_space2
  1729 3DE5 8D 2B 51		            sta score_chars_p2
  1730 3DE8 AD 2F 51		            lda score_p2
  1731 3DEB 29 0F		            and #15
  1732 3DED 09 10		            ora #16
  1733 3DEF 8D 2C 51		            sta score_chars_p2+1
  1734 3DF2 60			            rts
  1735 				                        
  1736 3DF3			reset_score
  1737 3DF3 A9 00		            lda #0
  1738 3DF5 8D 2E 51		            sta score_p1
  1739 3DF8 8D 2F 51		            sta score_p2
  1740 3DFB 60			            rts            
  1741 				         
  1742 3DFC			inc_score_p1
  1743 3DFC F8			            sed
  1744 3DFD AD 2E 51		            lda score_p1
  1745 3E00 18			            clc
  1746 3E01 69 01		            adc #1
  1747 3E03 8D 2E 51		            sta score_p1    
  1748 3E06 D8			            cld
  1749 3E07 60			            rts
  1750
  1751 3E08			inc_score_p2
  1752 3E08 F8			            sed
  1753 3E09 AD 2F 51		            lda score_p2
  1754 3E0C 18			            clc
  1755 3E0D 69 01		            adc #1
  1756 3E0F 8D 2F 51		            sta score_p2
  1757 3E12 D8			            cld
  1758 3E13 60			            rts
  1759
  1760 				; calculate the difference between angle1 and angle2
  1761
  1762 				; input:
  1763 				; tmp_angle1 (0..255)
  1764 				; tmp_angle2 (0..255)
  1765
  1766 				; output:
  1767 				; tmp_angle_diff, A: difference between angle1 and angle2
  1768 				; tmp_angle_direction: 0 = anti-clockwise, 1 = clockwise
  1769
  1770 3E14			calc_angle_diff
  1771 3E14 A9 00		            lda #0
  1772 3E16 85 B2		            sta add_to_angle
  1773 3E18 85 B4		            sta tmp_angle_direction
  1774
  1775 				; make sure we can compare angles, otherwise add $40 to angles
  1776 3E1A A5 B0		            lda tmp_angle1
  1777 3E1C C9 C0		            cmp #$c0
  1778 3E1E B0 06		            bcs too_large
  1779 3E20 A5 B1		            lda tmp_angle2
  1780 3E22 C9 C0		            cmp #$c0
  1781 3E24 90 12		            bcc not_too_large
  1782 3E26			too_large
  1783 3E26 A5 B0		            lda tmp_angle1
  1784 3E28 38			            sec
  1785 3E29 E9 40		            sbc #$40
  1786 3E2B 85 B0		            sta tmp_angle1
  1787 				            
  1788 3E2D A5 B1		            lda tmp_angle2
  1789 3E2F 38			            sec
  1790 3E30 E9 40		            sbc #$40
  1791 3E32 85 B1		            sta tmp_angle2
  1792 				            
  1793 3E34 A9 40		            lda #$40
  1794 3E36 85 B2		            sta add_to_angle
  1795
  1796 3E38			not_too_large
  1797 3E38 A5 B1		            lda tmp_angle2
  1798 3E3A C5 B0		            cmp tmp_angle1
  1799 3E3C 90 0A		            bcc angle2_smaller_angle1
  1800 				; ball >= play
  1801 3E3E 38			            sec
  1802 3E3F E5 B0		            sbc tmp_angle1
  1803 3E41 85 B7		            sta tmp_angle_diff
  1804 				            
  1805 3E43 E6 B4		            inc tmp_angle_direction
  1806 3E45 4C 4F 3E		            jmp diff_calculated
  1807 				                        
  1808 3E48			angle2_smaller_angle1
  1809 3E48 A5 B0		            lda tmp_angle1
  1810 3E4A 38			            sec
  1811 3E4B E5 B1		            sbc tmp_angle2
  1812 3E4D 85 B7		            sta tmp_angle_diff
  1813
  1814 3E4F			diff_calculated
  1815 3E4F A5 B7		            lda tmp_angle_diff           
  1816 3E51 60			            rts
  1817
  1818 				; X = angle
  1819 				; lookup magnitude of angle 0 to angle X
  1820 3E52			angle_to_magnitude
  1821 3E52 BD 00 4C		            lda magnitudes_lo,x
  1822 3E55 85 B8		            sta magnitude
  1823 3E57 BD 00 4D		            lda magnitudes_hi,x
  1824 3E5A 85 B9		            sta magnitude+1
  1825 3E5C 60			            rts
  1826
  1827 				; tmp_dx = abs(tmp_x2 - tmp_x1)
  1828 3E5D			calc_abs_tmp_dx
  1829 3E5D A5 E8		            lda tmp_x2
  1830 3E5F 38			            sec
  1831 3E60 E5 E6		            sbc tmp_x1
  1832 3E62 B0 05		            bcs x2_le
  1833 3E64 49 FF		            eor #255
  1834 3E66 18			            clc
  1835 3E67 69 01		            adc #1
  1836 3E69 85 F2		x2_le       sta tmp_dx
  1837
  1838 				; tmp_dy = abs(tmp_y2 - tmp_y1)
  1839 3E6B			calc_abs_tmp_dy
  1840 3E6B A5 E9		            lda tmp_y2
  1841 3E6D 38			            sec
  1842 3E6E E5 E7		            sbc tmp_y1
  1843 3E70 B0 05		            bcs y2_le
  1844 3E72 49 FF		            eor #255
  1845 3E74 18			            clc
  1846 3E75 69 01		            adc #1
  1847 3E77 85 F3		y2_le       sta tmp_dy
  1848 3E79 60			            rts
  1849 				            
  1850 3E7A			calc_dx_div_magnitude
  1851 3E7A A9 00		            lda #0
  1852 3E7C 85 E2		            sta _dividend
  1853 3E7E A5 F2		            lda tmp_dx
  1854 3E80 85 E3		            sta _dividend+1
  1855
  1856 3E82 A5 B9		            lda magnitude+1
  1857 3E84 85 E0		            sta _divisor
  1858 3E86 A9 00		            lda #0
  1859 3E88 85 E1		            sta _divisor+1
  1860 				            
  1861 3E8A 20 B2 3E		            jsr _div16
  1862
  1863 				; todo multiply result with velocity            
  1864 3E8D A5 E2		            lda _result
  1865 3E8F 85 EE		            sta step_x
  1866 3E91 A5 E3		            lda _result+1
  1867 3E93 85 EF		            sta step_x+1
  1868 				            
  1869 3E95 60			            rts
  1870 				            
  1871 3E96			calc_dy_div_magnitude
  1872 3E96 A9 00		            lda #0
  1873 3E98 85 E2		            sta _dividend
  1874 3E9A A5 F3		            lda tmp_dy
  1875 3E9C 85 E3		            sta _dividend+1
  1876 				            
  1877 3E9E A5 B9		            lda magnitude+1
  1878 3EA0 85 E0		            sta _divisor
  1879 3EA2 A9 00		            lda #0
  1880 3EA4 85 E1		            sta _divisor+1
  1881
  1882 3EA6 20 B2 3E		            jsr _div16
  1883 				            
  1884 				; todo multiply result with velocity
  1885 3EA9 A5 E2		            lda _result
  1886 3EAB 85 F0		            sta step_y
  1887 3EAD A5 E3		            lda _result+1
  1888 3EAF 85 F1		            sta step_y+1
  1889 				            
  1890 3EB1 60			            rts
  1891
  1892 				; divide 16bit
  1893 				; https://codebase64.org/doku.php?id=base:16bit_division_16-bit_result
  1894
  1895 				; _result = _dividend / divisor
  1896
  1897 3EB2 A9 00		_div16      lda #0          ;preset remainder to 0
  1898 3EB4 85 E4		            sta _remainder
  1899 3EB6 85 E5		            sta _remainder+1
  1900 3EB8 A2 10		            ldx #16         ;repeat for each bit: ...
  1901
  1902 3EBA 06 E2		_div_loop   asl _dividend    ;dividend lb & hb*2, msb -> Carry
  1903 3EBC 26 E3		            rol _dividend+1  
  1904 3EBE 26 E4		            rol _remainder   ;remainder lb & hb * 2 + msb from carry
  1905 3EC0 26 E5		            rol _remainder+1
  1906 3EC2 A5 E4		            lda _remainder
  1907 3EC4 38			            sec
  1908 3EC5 E5 E0		            sbc _divisor ;substract divisor to see if it fits in
  1909 3EC7 A8			            tay         ;lb result -> Y, for we may need it later
  1910 3EC8 A5 E5		            lda _remainder+1
  1911 3ECA E5 E1		            sbc _divisor+1
  1912 3ECC 90 06		            bcc _div_skip    ;if carry=0 then divisor didn't fit in yet
  1913
  1914 3ECE 85 E5		            sta _remainder+1 ;else save substraction result as new remainder,
  1915 3ED0 84 E4		            sty _remainder   
  1916 3ED2 E6 E2		            inc _result  ;and INCrement result cause divisor fit in 1 times
  1917
  1918 3ED4 CA			_div_skip   dex
  1919 3ED5 D0 E3		            bne _div_loop 
  1920 3ED7 60			            rts
  1921
  1922 				; Calculations for step size
  1923
  1924 				; not optimised for speed or size
  1925 				; step should be set according to the angle
  1926
  1927 				; move in straight line (x1,y1) to (x2,y2)
  1928
  1929 				; 1. set start/end of line
  1930 				; set (tmp_x1, tmp_y1)
  1931 				; set (tmp_x2, tmp_y2)
  1932
  1933 				; 2. init. current_x, current_y
  1934 				; - set current x,y to start of line (tmp_x1, tmp_y2)
  1935 				; - calculates step sizes for x,y
  1936 				; - calculated directions for x,y
  1937 				;            jsr init_current_xy
  1938
  1939 				; 3. use current_x, current_y to plot or set a position
  1940 				;            lda current_x+1
  1941 				;            sta x_position
  1942 				;            lda current_y+1
  1943 				;            sta y_position
  1944 				;            jsr plot_pixel
  1945
  1946 				; 4. move current_x, current_y to next position on line
  1947 				; A=0 still moving
  1948 				;           move_current_xy
  1949
  1950 3ED8			init_current_xy
  1951 3ED8 A9 7F		            lda #$7f      ; was 128 for half pixel
  1952 3EDA 85 EA		            sta current_x
  1953 3EDC 85 EC		            sta current_y
  1954
  1955 3EDE A5 E6		            lda tmp_x1
  1956 3EE0 85 EB		            sta current_x+1
  1957 				            
  1958 3EE2 A5 E7		            lda tmp_y1
  1959 3EE4 85 ED		            sta current_y+1
  1960
  1961 				; dx = abs(tmp_x1 - tmp_x2)
  1962 3EE6 20 5D 3E		            jsr calc_abs_tmp_dx
  1963
  1964 				; dy = abs(tmp_y1 - tmp_y2)
  1965 3EE9 20 6B 3E		            jsr calc_abs_tmp_dy
  1966
  1967 				; set directions
  1968 3EEC A5 E6		            lda tmp_x1
  1969 3EEE C5 E8		            cmp tmp_x2
  1970 3EF0 90 04		            bcc x1_smaller_x2
  1971 				; x1 >= x2
  1972 3EF2 A9 01		            lda #1
  1973 3EF4 D0 02		            bne set_dir_x
  1974 3EF6			x1_smaller_x2
  1975 3EF6 A9 00		            lda #0
  1976 3EF8			set_dir_x
  1977 3EF8 85 FA		            sta dir_x
  1978 				            
  1979 3EFA A5 E7		            lda tmp_y1
  1980 3EFC C5 E9		            cmp tmp_y2
  1981 3EFE 90 04		            bcc y1_smaller_y2
  1982 				; y1 >= y2
  1983 3F00 A9 01		            lda #1
  1984 3F02 D0 02		            bne set_dir_y
  1985 3F04			y1_smaller_y2
  1986 3F04 A9 00		            lda #0
  1987 3F06			set_dir_y
  1988 3F06 85 FB		            sta dir_y
  1989
  1990 				; Calculate diff between start angle and end angle
  1991
  1992 3F08 A5 AA		            lda ball_angle_start
  1993 3F0A 85 B0		            sta tmp_angle1
  1994 3F0C A5 AB		            lda ball_angle_end
  1995 3F0E 85 B1		            sta tmp_angle2
  1996 				            
  1997 3F10 20 14 3E		            jsr calc_angle_diff
  1998
  1999 				; lookup magnitude of vector (tmp_x1, tmp_y1), (tmp_x2, tmp_y2)
  2000 3F13 A6 B7		            ldx tmp_angle_diff
  2001 3F15 20 52 3E		            jsr angle_to_magnitude
  2002 				            
  2003 3F18 20 7A 3E		            jsr calc_dx_div_magnitude
  2004 3F1B 20 96 3E		            jsr calc_dy_div_magnitude
  2005 				            
  2006 				; Calculate step size by ball speed
  2007 				            
  2008 				; step_x = step_x * speed
  2009 				            
  2010 3F1E A5 EE		            lda step_x
  2011 3F20 85 F6		            sta _multiplicand
  2012 3F22 A5 EF		            lda step_x+1
  2013 3F24 85 F7		            sta _multiplicand+1
  2014 3F26 A5 AC		            lda ball_speed
  2015 3F28 85 F8		            sta _multiplier
  2016
  2017 3F2A 20 61 36		            jsr _multi8
  2018 				;result in .A (low byte, also in .X) and .Y (high byte)
  2019 3F2D 85 EE		            sta step_x
  2020 3F2F 84 EF		            sty step_x+1
  2021 3F31			skip_step_x_hi
  2022 				            
  2023 				; step_y = step_y * speed
  2024
  2025 3F31 A5 F0		            lda step_y
  2026 3F33 85 F6		            sta _multiplicand
  2027 3F35 A5 F1		            lda step_y+1
  2028 3F37 85 F7		            sta _multiplicand+1
  2029 3F39 A5 AC		            lda ball_speed
  2030 3F3B 85 F8		            sta _multiplier
  2031
  2032 3F3D 20 61 36		            jsr _multi8
  2033 				;result in .A (low byte, also in .X) and .Y (high byte)
  2034 3F40 85 F0		            sta step_y
  2035 3F42 84 F1		            sty step_y+1
  2036 3F44			skip_step_y_hi
  2037
  2038 3F44 60			            rts
  2039
  2040 				; Move ball position 
  2041 				; Add one step, until end reached
  2042 				; Input:
  2043 				; - step size (step_x, step_y)
  2044 				; - current ball position (current_x, current_y)
  2045 				; - end position (tmp_x2, tmp_y2)
  2046 				; Output:
  2047 				; A (0 = still moving, 1 = end reached)
  2048 3F45			move_current_xy
  2049 3F45 A9 00		            lda #0
  2050 3F47 85 FC		            sta line_end_x
  2051 3F49 85 FD		            sta line_end_y
  2052
  2053 				; sets line end indicators here
  2054 3F4B 20 68 3F		            jsr move_current_x
  2055 3F4E 20 9A 3F		            jsr move_current_y
  2056
  2057 3F51 A5 FC		            lda line_end_x
  2058 3F53 25 FD		            and line_end_y
  2059 3F55 F0 10		            beq no_end_reached
  2060
  2061 3F57			end_reached
  2062 				; set current to (x2,y2)
  2063 3F57 A5 E8		            lda tmp_x2
  2064 3F59 85 EB		            sta current_x+1
  2065 3F5B A5 E9		            lda tmp_y2
  2066 3F5D 85 ED		            sta current_y+1
  2067 				            
  2068 3F5F A9 00		            lda #0
  2069 3F61 85 EA		            sta current_x
  2070 3F63 85 EC		            sta current_y
  2071 				            
  2072 3F65 A9 01		            lda #1 ; end reached
  2073 				            
  2074 3F67			no_end_reached  ; A = 0
  2075 3F67 60			            rts
  2076
  2077 3F68			move_current_x
  2078 3F68 A5 FA		            lda dir_x
  2079 3F6A D0 14		            bne move_current_left
  2080
  2081 				; move right, add
  2082 3F6C A5 EA		            lda current_x
  2083 3F6E 18			            clc
  2084 3F6F 65 EE		            adc step_x
  2085 3F71 85 EA		            sta current_x
  2086 3F73 A5 EB		            lda current_x+1
  2087 3F75 65 EF		            adc step_x+1
  2088 3F77 85 EB		            sta current_x+1
  2089
  2090 3F79 A5 EB		            lda current_x+1
  2091 3F7B C5 E8		            cmp tmp_x2
  2092 3F7D 90 00		            bcc no_line_end
  2093 3F7F			exact_end_x
  2094 				;            lda #1
  2095 				;            sta line_end_x
  2096 3F7F			no_line_end
  2097 3F7F 60			            rts
  2098 				            
  2099 3F80			move_current_left
  2100 3F80 A5 EA		            lda current_x
  2101 3F82 38			            sec
  2102 3F83 E5 EE		            sbc step_x
  2103 3F85 90 01		            bcc clear_skip
  2104 3F87 EA			            nop
  2105 3F88			clear_skip
  2106 3F88 85 EA		            sta current_x
  2107 3F8A A5 EB		            lda current_x+1
  2108 3F8C E5 EF		            sbc step_x+1
  2109 3F8E 85 EB		            sta current_x+1
  2110 3F90 90 07		            bcc below_zero
  2111 				                        
  2112 3F92 A5 E8		            lda tmp_x2
  2113 3F94 C5 EB		            cmp current_x+1
  2114 3F96 90 E7		            bcc no_line_end
  2115 				;            lda #1
  2116 				;            sta line_end_x
  2117 3F98 60			            rts
  2118 3F99			below_zero            
  2119 				;            lda #1
  2120 				;            sta line_end_x
  2121 				;            sta line_end_y
  2122 3F99 60			            rts
  2123 3F9A			move_current_y
  2124 3F9A A5 FB		            lda dir_y
  2125 3F9C D0 14		            bne move_current_up
  2126
  2127 				; move down, add
  2128 3F9E A5 EC		            lda current_y
  2129 3FA0 18			            clc
  2130 3FA1 65 F0		            adc step_y
  2131 3FA3 85 EC		            sta current_y
  2132 3FA5 A5 ED		            lda current_y+1
  2133 3FA7 65 F1		            adc step_y+1
  2134 3FA9 85 ED		            sta current_y+1
  2135 				            
  2136 3FAB A5 ED		            lda current_y+1
  2137 3FAD C5 E9		            cmp tmp_y2
  2138 3FAF 90 CE		            bcc no_line_end
  2139 3FB1			exact_end_y
  2140 				;            lda #1
  2141 				;            sta line_end_y
  2142 3FB1 60			            rts
  2143
  2144 3FB2			move_current_up
  2145 3FB2 A5 EC		            lda current_y
  2146 3FB4 38			            sec
  2147 3FB5 E5 F0		            sbc step_y
  2148 3FB7 85 EC		            sta current_y
  2149 3FB9 A5 ED		            lda current_y+1
  2150 3FBB E5 F1		            sbc step_y+1
  2151 3FBD 90 DA		            bcc below_zero
  2152 3FBF 85 ED		            sta current_y+1
  2153 				            
  2154 3FC1 A5 E9		            lda tmp_y2
  2155 3FC3 C5 ED		            cmp current_y+1
  2156 3FC5 90 B8		            bcc no_line_end
  2157 				;            lda #1
  2158 				;            sta line_end_y
  2159 3FC7 60			            rts                            
  2160 				            
  2161 3FC8			init_sprites
  2162 3FC8 A2 00		            ldx #0
  2163 3FCA 8A			            txa
  2164 3FCB			set_p
  2165 3FCB 9D 00 0E		            sta p0_area,x
  2166 3FCE 9D 80 0E		            sta p1_area,x
  2167 3FD1 9D 00 0F		            sta p2_area,x
  2168 3FD4 9D 80 0F		            sta p3_area,x
  2169 3FD7 E8			            inx
  2170 3FD8 10 F1		            bpl set_p
  2171
  2172 3FDA A9 31		            lda #%0110001  ; overlap OR colors, missile = 5th player, prio player 0..3
  2173 3FDC 8D 6F 02		            sta GPRIOR
  2174
  2175 3FDF A9 0C		            lda #>pm_area
  2176 3FE1 8D 07 D4		            sta PMBASE
  2177
  2178 3FE4 A9 03		            lda #3          ; P/M both on
  2179 3FE6 8D 1D D0		            sta GRACTL
  2180
  2181 3FE9 A9 90		            lda #$90
  2182 3FEB 8D 02 D0		            sta HPOSP2
  2183 3FEE A9 A0		            lda #$A0
  2184 3FF0 8D 03 D0		            sta HPOSP3  
  2185 3FF3 60			            rts
  2186
  2187 3FF4			init_colors
  2188 3FF4 A9 5A		            lda #BASE_COLOR_P1+10
  2189 3FF6 8D C2 02		            sta PCOLR2
  2190 3FF9 A9 BA		            lda #BASE_COLOR_P2+10
  2191 3FFB 8D C3 02		            sta PCOLR3
  2192 				            
  2193 3FFE A9 00		            lda #0
  2194 4000 8D C6 02		            sta COLOR2
  2195
  2196 4003 A9 0E		            lda #HEADER_FG_COLOR
  2197 4005 8D C5 02		            sta COLOR1
  2198
  2199 4008 A9 50		            lda #HEADER_P1_COLOR
  2200 400A 8D C0 02		            sta PCOLR0
  2201 400D A9 B0		            lda #HEADER_P2_COLOR
  2202 400F 8D C1 02		            sta PCOLR1
  2203
  2204 4012 60			            rts
  2205
  2206 4013			previous_consol
  2207 4013 00			            dta 0
  2208
  2209 4014			current_level_index
  2210 4014 00			            dta 0
  2211 = 0007			NR_OF_LEVELS = 7
  2212 = 0000			INIT_LEVEL_INDEX = 0
  2213 4015			level_speeds
  2214 4015 02 03 04 05 06 07 +             dta 2,3,4,5,6,7,8
  2215 				;level_speeds_lo
  2216 				;            dta 128
  2217 401C			stick_slow_speed_tab
  2218 401C 01 02 02 02 03 03 +             dta 1,2,2,2,3,3,3
  2219 4023			stick_fast_speed_tab
  2220 4023 02 02 03 03 04 04 +             dta 2,2,3,3,4,4,4
  2221
  2222 				; X = level (0..NR_OF_LEVELS)
  2223 402A			set_level_ball_speed
  2224 402A BD 1C 40		            lda stick_slow_speed_tab,x
  2225 402D 85 88		            sta stick_slow_speed
  2226 402F BD 23 40		            lda stick_fast_speed_tab,x
  2227 4032 85 89		            sta stick_fast_speed
  2228
  2229 4034 BD 15 40		            lda level_speeds,x
  2230 4037 85 AC		            sta ball_speed
  2231 4039 8A			            txa
  2232 403A 18			            clc
  2233 403B 69 01		            adc #1
  2234 403D 09 10		            ora #16
  2235 403F 8D AB 52		            sta level_char
  2236 4042 60			            rts
  2237 				            
  2238 4043			increase_level
  2239 4043 EE 14 40		            inc current_level_index
  2240 4046 AD 14 40		            lda current_level_index
  2241 4049 C9 07		            cmp #NR_OF_LEVELS
  2242 404B D0 05		            bne ok_level
  2243 404D A9 00		            lda #INIT_LEVEL_INDEX
  2244 404F 8D 14 40		            sta current_level_index
  2245 4052			ok_level           
  2246 4052 60			            rts
  2247
  2248 4053			increase_player_mode
  2249 4053 E6 8A		            inc player_mode
  2250 4055 A5 8A		            lda player_mode
  2251 4057 C9 03		            cmp #NR_OF_PLAYER_MODES
  2252 4059 D0 04		            bne ok_player_mode
  2253 405B A9 00		            lda #INIT_PLAYER_MODE
  2254 405D 85 8A		            sta player_mode
  2255 405F			ok_player_mode
  2256 405F 85 8B		            sta player_mode_saved
  2257 4061 60			            rts
  2258
  2259 4062			show_player_mode
  2260 4062 A6 8A		            ldx player_mode
  2261 4064 BD 3F 53		            lda player_mode_lo,x
  2262 4067 8D F9 50		            sta menu_line2_ptr
  2263 406A BD 42 53		            lda player_mode_hi,x
  2264 406D 8D FA 50		            sta menu_line2_ptr+1
  2265 4070 60			            rts
  2266
  2267 4071			            .align $100
  2268 4100			inner_x_tab
  2269 = 4200			inner_y_tab = *+$100
  2270 4100-42FF> 70 72 75 77 +             ins 'data\in210.dat'
  2271 				      
  2272 4300			            .align $400            
  2273 				; outer circle 1024 plot points on 360 degrees
  2274 4400			outer_x_tab
  2275 = 4800			outer_y_tab = *+1024
  2276 4400-4DFF> 70 70 71 72 +             ins 'data\out224.dat'
  2277 				           
  2278 4C00			            .align $400
  2279 				; table of magnitudes (length) between angle 0 and 0..255
  2280 				; fixed point 8.8 : hi.lo
  2281 4C00			magnitudes_lo
  2282 = 4D00			magnitudes_hi = *+256
  2283 4C00 00 BC 79 35 F1 AC +             ins 'data\magnitud.dat'
  2284
  2285 4E00			            .align $400
  2286 5000			display_list
  2287 5000-512F> C2		            dta $42+128         ; dli_header
  2288 5001 06 51		            dta a(score_line)
  2289
  2290 				; 102 x 40 = 4080 bytes            
  2291 5003 4F			            dta $4f
  2292 5004 00 70		            dta a(screen_mem1)
  2293 5006 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f
  2294 500D 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2295 5015 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2296 501D 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2297
  2298 5025 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2299 502D 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2300 5035 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2301 503D 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2302
  2303 5045 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2304 504D 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2305 5055			menu_dl_hook
  2306 5055 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2307 505D 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2308
  2309 5065 0F 0F 0F 0F 0F 0F	            dta $0f,$0f,$0f,$0f,$0f,$0f
  2310
  2311 				; 42 + 60 = 102, 4080 bytes
  2312 506B 4F			            dta $4f
  2313 506C 00 80		            dta a(screen_mem2)
  2314 506E 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f
  2315
  2316 5075 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2317 507D 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2318 5085 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2319 508D 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2320
  2321 5095 0F 0F		            dta $0f,$0f
  2322
  2323 				; 60 lines
  2324 5097			menu_dl_end
  2325 5097 4F			            dta $4f
  2326 5098 90 86		            dta a(screen_mem2+(42*SCREEN_WIDTH))
  2327 509A 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f
  2328 50A1 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2329 50A9 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2330 50B1 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2331
  2332 50B9 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2333 50C1 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2334 50C9 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2335 50D1 0F 0F 0F 0F		            dta $0f,$0f,$0f,$0f
  2336
  2337 				; 20 x 40 = 800
  2338 50D5 4F			            dta $4f
  2339 50D6 00 90		            dta a(screen_mem3)       
  2340 50D8 0F 0F 0F		            dta $0f,$0f,$0f
  2341 50DB 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2342 50E3 0F 0F 0F 0F 0F 0F +             dta $0f,$0f,$0f,$0f,$0f,$0f,$0f,$0f
  2343 				            
  2344 50EB 41			            dta $41
  2345 50EC 00 50		            dta a(display_list)
  2346
  2347 50EE			menu_dl_part
  2348 50EE 80			            dta 128 ; dli_menu
  2349 50EF 20			            dta $20
  2350 50F0 42			            dta $42
  2351 50F1 00 52		            dta a(rotor_logo_text)
  2352 50F3 02			            dta 2
  2353 50F4 30			            dta $30
  2354 50F5 46			            dta $46
  2355 50F6			menu_line1_ptr
  2356 50F6 50 52		            dta a(controller_text)
  2357 50F8 46			            dta $46
  2358 50F9			menu_line2_ptr
  2359 50F9 64 52		            dta a(two_player_text)
  2360 50FB 46			            dta $46
  2361 50FC			menu_line3_ptr
  2362 50FC 9F 52		            dta a(level_text)
  2363 50FE 30			            dta $30
  2364 50FF 42			            dta $42
  2365 5100 B3 52		            dta a(start_text)
  2366 5102 10			            dta $10
  2367 5103 01			            dta $01 ; jump
  2368 5104 97 50		            dta a(menu_dl_end)
  2369
  2370 5106			score_line  
  2371 5106 00 2F 2E 25 00	            dta d' ONE '
  2372 510B			score_chars_p1
  2373 510B 0D 0D 00		            dta d'-- '
  2374
  2375 510E 00 00 00 00 00 00 +             dta d'          '
  2376 5118 00 00 00 00 00 00 +             dta d'          '
  2377
  2378 5122 00 00 00 00 00 34 +             dta d'     TWO '
  2379 512B			score_chars_p2
  2380 512B 0D 0D 00		            dta d'-- '
  2381
  2382 512E 00			score_p1    dta 0
  2383 512F 00			score_p2    dta 0
  2384
  2385 5130			            .align $100
  2386 5200			rotor_logo_text
  2387 5200-5344> 00 00 00 00 +             dta d'              '
  2388 520E 45 46 47 48 49 4A +             dta $45,$46,$47,$48,$49,$4a,$4b,$4c,$4d,$4e,$4f,$50
  2389 521A 40			            dta $40
  2390 521B 00 00 00 00 00 00 +             dta d'             '
  2391 5228 00 00 00 00 00 00 +             dta d'              '
  2392 5236 51 52 53 54 55 56 +             dta $51,$52,$53,$54,$55,$56,$57,$58,$59,$5a,$5b,$5c
  2393 5242 00 00 00 00 00 00 +             dta d'              '
  2394
  2395 5250			controller_text
  2396 5250 00 00 23 2F 2E 34 +             dta d'  CONTROL:'
  2397 525A			driver_screen
  2398 525A 00 00 00 00 00 00 +             dta d'          '
  2399
  2400 5264			two_player_text
  2401 5264 00 00 00 28 35 2D +             dta d'   HUMAN VS HUMAN   '
  2402
  2403 5278			one_player_text
  2404 5278 00 00 00 28 35 2D +             dta d'   HUMAN VS ROBOT  '
  2405
  2406 528B			demo_player_text
  2407 528B 00 00 00 00 00 00 +             dta d'        DEMO        '
  2408
  2409 529F			level_text
  2410 529F 00 00 00 00 00 00 +             dta d'      LEVEL '
  2411 52AB			level_char            
  2412 52AB 11 00 00 00 00 00 +             dta d'1       '
  2413
  2414 52B3			start_text
  2415 52B3 80 80 80 80 80 B3 +             dta d'     START or FIRE buttons to play!     '*
  2416 52DB			stick_text
  2417 52DB 33 34 29 23 2B 00 +             dta d'STICK   '
  2418 52E3			paddle_text
  2419 52E3 30 21 24 24 2C 25 +             dta d'PADDLE  '
  2420 52EB			mouse_text
  2421 52EB 2D 2F 35 33 25 00 +             dta d'MOUSE   '
  2422 52F3			unknown_text
  2423 52F3 35 2E 2B 2E 2F 37 +             dta d'UNKNOWN '
  2424
  2425 52FB			empty_text
  2426 52FB 00 00 00 00 00 00 +             dta d'                    '
  2427 530F			winner_one_text
  2428 530F 00 00 30 2C 21 39 +             dta d'  PLAYER ONE WINS!  '
  2429 5323			winner_two_text
  2430 5323 00 00 30 2C 21 39 +             dta d'  PLAYER TWO WINS!  '
  2431
  2432 5337			driver_text_lo
  2433 5337 DB			            dta <stick_text
  2434 5338 E3			            dta <paddle_text
  2435 5339 EB			            dta <mouse_text
  2436 533A F3			            dta <unknown_text
  2437 				            
  2438 533B			driver_text_hi
  2439 533B 52			            dta >stick_text
  2440 533C 52			            dta >paddle_text
  2441 533D 52			            dta >mouse_text
  2442 533E 52			            dta >unknown_text
  2443
  2444 533F			player_mode_lo
  2445 533F 64			            dta <two_player_text
  2446 5340 78			            dta <one_player_text
  2447 5341 8B			            dta <demo_player_text
  2448
  2449 5342			player_mode_hi
  2450 5342 52			            dta >two_player_text
  2451 5343 52			            dta >one_player_text
  2452 5344 52			            dta >demo_player_text
  2453
  2454 				; 4 KB
  2455 				; 128 x 32 bytes shapes
  2456 5345			            .align $1000
  2457 6000			pm_shapes
  2458 6000-7FEF> 01 00 01 00 +             ins 'data\pm_128_x_32.dat'
  2459
  2460 				; 9 KB for backdrop image
  2461 7000			            .align $1000
  2462 = 7000			screen_mem1 = * ; 4K
  2463 				;            org screen_mem1
  2464 7000 FF FF F1 07 D0 00 +             ins 'gfx\backdrop2.gr8',0,102*SCREEN_WIDTH
  2465
  2466 7FF0			            .align $1000
  2467 = 8000			screen_mem2 = * ; 4K
  2468 				;            org screen_mem2
  2469 8000-8FEF> A1 55 7F E0 +             ins 'gfx\backdrop2.gr8',102*SCREEN_WIDTH,102*SCREEN_WIDTH
  2470
  2471 8FF0			            .align $1000
  2472 = 9000			screen_mem3 = * ; 1K
  2473 				;            org screen_mem3
  2474 9000-931F> EE 2A AB 52 +             ins 'gfx\backdrop2.gr8',204*SCREEN_WIDTH,20*SCREEN_WIDTH
  2475
  2476 02E0-02E1> C3 35		            run main
